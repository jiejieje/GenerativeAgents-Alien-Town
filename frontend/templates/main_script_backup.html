<!-- æ·»åŠ PixiJSåº?-->
<script src="https://pixijs.download/v6.5.9/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-tilemap@2.1.3/dist/pixi-tilemap.umd.js"></script>

<script type="text/javascript">
    // ä»Flaskä¸Šä¸‹æ–‡åˆå§‹åŒ–å˜é‡
    var step = {{ step|tojson }};                          
    var step_size = {{ sec_per_step|tojson }} * 1000;     
    step_size = step_size / 1; // æ¢å¤åŸå§‹æ—¶é—´æµé€Ÿï¼Œä¸å†å‡åŠ
    var zoom = {{ zoom|tojson }};  // æ¸¸æˆç¼©æ”¾
    var global_time_speed = 1; // æ—¶é—´æµé€é€Ÿåº¦
    // æ·»åŠ æ°”æ³¡æ§åˆ¶å…¨å±€å˜é‡
    var bubbleScale = 1.0;  // æ°”æ³¡å¤§å°æ¯”ä¾‹
    // æ·»åŠ æ¶ˆæ¯è®¡æ•°å™¨ï¼Œç”¨äºå†³å®šæ¶ˆæ¯æ˜¾ç¤ºä½ç½®ï¼ˆå¥‡æ•°å·¦è¾¹ï¼Œå¶æ•°å³è¾¹ï¼?    var messageCounter = 0;
    var bubbleVerticalOffset = 70;  // æ°”æ³¡å‚ç›´åç§»é‡?    var bubbleHorizontalOffset = 0;  // æ°”æ³¡æ°´å¹³åç§»é‡?    // è§’è‰²å¤´é¡¶å›¾ç‰‡ç›¸å…³å˜é‡
    var characterImages = {}; // è§’è‰²å¤´é¡¶å›¾ç‰‡èµ„æºæ˜ å°„
    var characterHeadImages = {}; // å­˜å‚¨è§’è‰²å¤´é¡¶æ˜¾ç¤ºçš„å›¾ç‰?    
    if (zoom <= 0) zoom = document.documentElement.clientWidth / 4400;  

    // è®¾ç½®PixiJSå…¨å±€æ¸²æŸ“è´¨é‡
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.LINEAR;
    PIXI.settings.ROUND_PIXELS = true;

    // æ¸¸æˆåŸºç¡€è®¾ç½®
    var tile_width = 32;                                  
    var movement_speed = {{ play_speed|tojson }};         
    movement_speed = movement_speed * 4; // å°†NPCç§»åŠ¨é€Ÿåº¦æé«˜åˆ°åŸå§‹å€¼çš„4å€?    var execute_count_max = tile_width / movement_speed;   
    execute_count_max = Math.max(1, Math.round(execute_count_max / 2));
    execute_count_max = execute_count_max * 1; // ç¼©çŸ­æ‰§è¡Œæ—¶é—´ä½¿åŠ¨ç”»æ›´æµç•…
    var execute_count = execute_count_max;                
    var all_movement = {{ all_movement|tojson }};         

    // å¯¹è¯å†å²è®°å½•
    var dialogHistory = {};
    // ä¸Šä¸€ä¸ªå‘è¨€è€…ï¼Œç”¨äºåˆ¤æ–­è¿ç»­çš„æ¶ˆæ¯æ˜¯å¦æ¥è‡ªåŒä¸€äº?    var lastSpeaker = null;
    
    // åˆå§‹æ£€æŸ¥å¯¹è¯æ•°æ?    function checkInitialConversationData() {
        if (!all_movement || !all_movement["conversation"]) {
            console.warn("å¯¹è¯æ•°æ®ä¸å­˜åœ¨æˆ–ä¸ºç©º");
            return;
        }
        
        const conversationKeys = Object.keys(all_movement["conversation"]);
        if (conversationKeys.length > 0) {
            const firstKey = conversationKeys[0];
            const firstConversation = all_movement["conversation"][firstKey];
            
            if (typeof firstConversation === 'object') {
                const personaNames = Object.keys(firstConversation).filter(key => key !== 'emoji');
            }
        }
    }
    
    // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å¯¹è¯æ•°æ?    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–UIå…ƒç´ 
        initializeUI();
        
        // æ·»åŠ åˆå§‹å¯¹è¯æ•°æ®æ£€æŸ?        setTimeout(checkInitialConversationData, 1000);
        
        // æ·»åŠ å¾®ä¿¡é£æ ¼çš„CSS
        addWeChatStyleCSS();
        
        // è®¾ç½®è‡ªåŠ¨ç§»é™¤ä»‹ç»ä¿¡æ¯çš„å®šæ—¶å™¨
        setTimeout(function() {
            console.log("å¼€å§‹ç§»é™¤ä»‹ç»ä¿¡æ?..");
            const introMessages = document.querySelectorAll('.intro-message');
            console.log(`æ‰¾åˆ° ${introMessages.length} æ¡æ ‡è®°ä¸ºintro-messageçš„ä»‹ç»ä¿¡æ¯`);
            
            // ç›´æ¥å¤„ç†å·²çŸ¥çš„NPCä»‹ç»å¯¹è¯ï¼ˆé€šè¿‡å†…å®¹åŒ¹é…ï¼?            const allMessages = document.querySelectorAll('.chat-message');
            let npcIntroCount = 0;
            
            allMessages.forEach(msg => {
                const textContent = msg.textContent || '';
                if (
                    (textContent.includes('æ‚¨å¥½ï¼æˆ‘æ˜¯æœ¬ç³»ç»Ÿçš„ä¸»è¦è§’è‰²ä¹‹ä¸€') || 
                     textContent.includes('ç‚¹å‡»é¡¶éƒ¨çš„è§’è‰²å¤´åƒ?) || 
                     textContent.includes('ä¸‹æ–¹æ§åˆ¶æ çš„æŒ‰é’®') ||
                     /^[^\w\s].*è§‚å¯Ÿ.*å¯¹è¯/.test(textContent) ||
                     /^[^\w\s].*åˆ‡æ¢è§†è§’/.test(textContent) ||
                     /^[^\w\s].*æ§åˆ¶æ ?.test(textContent)
                    ) && !msg.classList.contains('intro-message')
                ) {
                    console.log(`æ‰¾åˆ°NPCä»‹ç»å¯¹è¯: ${textContent.substring(0, 30)}...`);
                    msg.classList.add('intro-message');
                    npcIntroCount++;
                }
            });
            
            const allIntroMessages = document.querySelectorAll('.intro-message');
            allIntroMessages.forEach(message => {
                message.classList.add('fading');
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 500);
            });
        }, 60000);
        
        // æ·»åŠ å¯æ‹–åŠ¨çª—å£çš„æ ·å¼
        const dragWindowStyle = document.createElement('style');
        dragWindowStyle.textContent = `
            .floating-window {
                position: absolute;
                background-color: rgba(40, 44, 52, 0.85);
                border: 1px solid #61dafb;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                padding: 8px;
                z-index: 10000;
                user-select: none;
                min-width: 200px;
                transition: box-shadow 0.3s;
                backdrop-filter: blur(5px);
            }
            
            .floating-window:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            }
            
            .window-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
                padding-bottom: 4px;
                border-bottom: 1px solid #484e5c;
                cursor: move;
            }
            
            .window-title {
                font-size: 13px;
                font-weight: bold;
                color: #61dafb;
            }
            
            .window-close {
                background: none;
                border: none;
                color: #e06c75;
                font-size: 16px;
                cursor: pointer;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }
            
            .window-close:hover {
                background-color: rgba(224, 108, 117, 0.2);
            }
            
            .window-content {
                color: #ffffff;
                font-family: 'Consolas', 'Monaco', monospace;
            }
            
            .clock-display {
                font-size: 16px;
                text-align: center;
                margin: 4px 0;
                color: #ffffff;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            }
            
            .clock-date {
                font-size: 13px;
                text-align: center;
                margin-bottom: 4px;
                color: #ffffff;
            }
        `;
        document.head.appendChild(dragWindowStyle);
        
        // åˆ›å»ºæµ®åŠ¨æ—¶é’Ÿçª—å£æŒ‰é’®
        createFloatingClockButton();
    });
    
    // æ·»åŠ æ¶ˆæ¯åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .chat-message {
            animation: slideInUp 0.3s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }
        
        .chat-message.show {
            opacity: 1;
        }
        
        .fading {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
    `;
    document.head.appendChild(style);

    // æ·»åŠ å¾®ä¿¡é£æ ¼çš„CSS
    function addWeChatStyleCSS() {
        const style = document.createElement('style');
        style.textContent = `
            /* å¯¹è¯æ¡†æ•´ä½“æ ·å¼?*/
            #ui-dialog-panel {
                background: #f2f2f2 !important;
                border-top: 1px solid #ddd !important;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
                color: #333 !important;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                padding: 15px !important;
            }
            
            /* èŠå¤©æ¶ˆæ¯åŠ¨ç”» */
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(10px); }
            }
            
            /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
            .chat-message {
                margin: 12px 0;
                animation: fadeIn 0.3s ease;
                position: relative;
                width: 100%;
            }
            
            /* å¤´åƒæ ·å¼ */
            .chat-avatar {
                border-radius: 4px !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* åç§°æ ‡ç­¾æ ·å¼ */
            .chat-name {
                font-size: 10px;
                color: #999;
                margin-top: 2px;
                text-align: center;
                max-width: 40px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* å·¦ä¾§å‘é€æ–¹æ°”æ³¡æ ·å¼ - ä¸»è§’(è“è‰²) */
            .chat-message:not([style*="flex-direction: row-reverse"]) .chat-bubble {
                background-color: #3498db;
                color: white;
                border-radius: 12px;
                border-top-left-radius: 0;
                margin-right: 10px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                display: inline-block;
                max-width: calc(100% - 60px);
                min-width: 40px;
                word-wrap: break-word;
                white-space: pre-wrap;
                box-sizing: border-box;
            }
            
            /* å³ä¾§å›å¤æ–¹æ°”æ³¡æ ·å¼?- NPC(ç™½è‰²) */
            .chat-message[style*="flex-direction: row-reverse"] .chat-bubble {
                background-color: #ffffff;
                color: #000000;
                border-radius: 12px;
                border-top-right-radius: 0;
                margin-left: 10px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                display: inline-block;
                max-width: calc(100% - 60px);
                min-width: 40px;
                word-wrap: break-word;
                white-space: pre-wrap;
                box-sizing: border-box;
                border: 1px solid rgba(0,0,0,0.05);
            }
            
            /* æ°”æ³¡å†…å®¹æ ·å¼ */
            .chat-bubble {
                padding: 10px 15px;
                word-wrap: break-word;
                text-align: left;
            }
            
            /* èŠå¤©æ–‡æœ¬æ ·å¼ */
            .chat-text {
                line-height: 1.4;
                font-size: 15px;
            }
            
            /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
            .system-message {
                text-align: center;
                margin: 5px auto;
                padding: 5px 10px;
                background-color: rgba(0,0,0,0.1);
                border-radius: 15px;
                color: #999;
                font-size: 0.9em;
                max-width: 80%;
            }
            
            /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ - èŠå¤©ä¸­çš„åœ°ç‚¹ä¿¡æ¯ç­?*/
            .chat-message[style*="justify-content: center"] {
                background-color: rgba(230, 230, 230, 0.8) !important;
                color: #000000 !important;
                font-weight: 500 !important;
                border-radius: 15px !important;
                padding: 8px 15px !important;
                font-size: 13px !important;
                max-width: 85% !important;
                margin: 10px auto !important;
                box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
                border: 1px solid #ccc !important;
            }
            
            /* èŠå¤©æ¶ˆæ¯æ—¶é—´æˆ³æ ·å¼?*/
            .message-time {
                font-size: 11px !important;
                color: #999999 !important;
                margin-top: 3px !important;
                user-select: none !important;
            }
            
            /* ä»‹ç»æ¶ˆæ¯çš„è‡ªåŠ¨æ¶ˆå¤±ç±» */
            .intro-message {
                animation: fadeIn 0.3s ease-in-out;
                transition: opacity 0.5s ease-in-out;
            }
            
            .intro-message.fading {
                animation: fadeOut 0.5s ease-in-out;
                opacity: 0 !important;
            }
        `;
        document.head.appendChild(style);
        console.log("å·²æ·»åŠ å¾®ä¿¡é£æ ¼CSS");
    }

    // åˆå§‹åŒ–UIå…ƒç´ 
    function initializeUI() {
        // æŸ¥æ‰¾å¯¹è¯é¢æ¿å…ƒç´ 
        const dialogPanel = document.getElementById('ui-dialog-panel');
        const conversationContent = document.getElementById('conversation-content');
        const defaultDialogContent = document.getElementById('default-dialog-content');
        
        if (!dialogPanel || !conversationContent || !defaultDialogContent) {
            console.error("æ‰¾ä¸åˆ°å¯¹è¯é¢æ¿å…ƒç´ ï¼Œæ­£åœ¨åˆ›å»º...");
            createDialogElements();
        } else {
            console.log("å¯¹è¯é¢æ¿å…ƒç´ å·²æ‰¾åˆ?);
            
            // ç¡®ä¿é»˜è®¤å†…å®¹å¯è§ï¼Œå¯¹è¯å†…å®¹éšè—?            conversationContent.style.display = 'none';
            defaultDialogContent.style.display = 'block';
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            showWelcomeMessages(conversationContent);
        }
    }
    
    // åˆ›å»ºå¯¹è¯é¢æ¿å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼?    function createDialogElements() {
        const uiDialogPanel = document.getElementById('ui-dialog-panel');
        if (!uiDialogPanel) {
            console.log("åˆ›å»ºå¯¹è¯é¢æ¿å…ƒç´ ");
            
            // åˆ›å»ºå¯¹è¯é¢æ¿
            const dialogPanel = document.createElement('div');
            dialogPanel.id = 'ui-dialog-panel';
            dialogPanel.style.width = '100%';
            dialogPanel.style.minHeight = '150px';
            dialogPanel.style.background = 'linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.6))';
            dialogPanel.style.borderTop = '2px solid #3498db';
            dialogPanel.style.color = 'white';
            dialogPanel.style.padding = '10px 15px';
            dialogPanel.style.marginTop = '20px';
            dialogPanel.style.overflowY = 'auto';
            
            // åˆ›å»ºå¯¹è¯å†…å®¹åŒºåŸŸ
            const conversationContent = document.createElement('div');
            conversationContent.id = 'conversation-content';
            conversationContent.style.display = 'none';
            conversationContent.style.flexDirection = 'column';
            conversationContent.style.gap = '10px';
            
            // åˆ›å»ºé»˜è®¤å¯¹è¯å†…å®¹
            const defaultDialogContent = document.createElement('div');
            defaultDialogContent.id = 'default-dialog-content';
            defaultDialogContent.style.textAlign = 'center';
            defaultDialogContent.style.padding = '20px';
            defaultDialogContent.innerHTML = `
                <p>æ¬¢è¿æ¥åˆ°è§’è‰²äº’åŠ¨æ¨¡æ‹Ÿä¸–ç•Œï¼?/p>
                <p>å½“è§’è‰²å¼€å§‹å¯¹è¯æ—¶ï¼Œå¯¹è¯å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€?/p>
                <p>æ‚¨å¯ä»¥é€šè¿‡æ—¶é—´è½´æ¥æŸ¥çœ‹è§’è‰²ä¹‹é—´çš„äº’åŠ¨æƒ…å†µã€?/p>
            `;
            
            // æ·»åŠ åˆ°é¡µé?            dialogPanel.appendChild(conversationContent);
            dialogPanel.appendChild(defaultDialogContent);
            
            // æŸ¥æ‰¾æ¸¸æˆå®¹å™¨ï¼Œåœ¨å…¶åæ’å…¥å¯¹è¯é¢æ¿
            const gameContainer = document.getElementById('game-container');
            if (gameContainer && gameContainer.parentNode) {
                gameContainer.parentNode.insertBefore(dialogPanel, gameContainer.nextSibling);
                console.log("å¯¹è¯é¢æ¿å·²æ·»åŠ åˆ°é¡µé¢");
                
                // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                showWelcomeMessages(conversationContent);
            } else {
                console.error("æ— æ³•æ‰¾åˆ°æ¸¸æˆå®¹å™¨ï¼Œå¯¹è¯é¢æ¿æœªæ·»åŠ åˆ°é¡µé?);
                // å°è¯•æ·»åŠ åˆ°body
                document.body.appendChild(dialogPanel);
            }
        }
    }

    // æ—¶é—´æ˜¾ç¤ºç›¸å…³è®¾ç½®
    var datetime_options = {                              
        weekday: "long",                                  
        year: "numeric",                                  
        month: "long",                                    
        day: "numeric"                                    
    };
    var start_datetime = new Date(Date.parse({{ start_datetime|tojson }}));  

    // è§’è‰²ç›¸å…³å˜é‡
    var persona_names = {{ persona_init_pos|tojson }};    
    var spawn_tile_loc = {};                              
    for (var key in persona_names) {                      
        spawn_tile_loc[key] = persona_names[key];         
    }

    var personas = {};                                    
    var pronunciatios = {};                               
    let anims_direction;                                  
    let pre_anims_direction;                              
    let pre_anims_direction_dict = {};                    
    let movement_target = {};                             
    let finished = false;                                 
    let paused = false;                                   
    let lastPlayerDirection = 'down';
    let keyboard = {};
    let player;
    let mapContainer;
    let uiContainer;
    let currentTimeText = null;
    let conversationText;
    let buttonPlay, buttonPause, buttonShowConversation, buttonHideConversation, buttonShowCollision, buttonHideCollision, buttonClearConversation;
    let app = null;
    
    // æ·»åŠ å…¨å±€å˜é‡ï¼Œç”¨äºè·Ÿè¸ªå½“å‰é”å®šçš„NPC
    let currentLockedCharacter = null;
    let isCharacterLocked = false;
    
    // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨å¯¹è¯å’ŒåŠ¨ä½œæ°”æ³¡çš„å†…å®?    let dialogBubbles = {};
    let actionBubbles = {};
    let bubbleTimers = {}; // å­˜å‚¨æ°”æ³¡çš„å®šæ—¶å™¨
    let typingEffects = {}; // å­˜å‚¨æ‰“å­—æ•ˆæœçš„çŠ¶æ€?    let dialogQueues = {}; // å­˜å‚¨æ¯ä¸ªNPCçš„å¯¹è¯é˜Ÿåˆ?    let currentDialogueGroup = []; // å­˜å‚¨å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„å¯¹è¯ç»„
    let isDialogueGroupPlaying = false; // æ˜¯å¦æ­£åœ¨æ’­æ”¾å¯¹è¯ç»?    let dialogueGroupTimer = null; // å¯¹è¯ç»„è®¡æ—¶å™¨
    
    // æ·»åŠ å…¨å±€å˜é‡
    let floatingClockWindow = null;
    
    // ç­‰å¾…DOMåŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
        // åˆ›å»ºæ¸¸æˆå®¹å™¨
        const gameContainer = document.getElementById('game-container');
        if (!gameContainer) {
            console.error("æ‰¾ä¸åˆ°game-containerå…ƒç´ ");
            return;
        }

        // è·å–å·²ç»åœ¨HTMLä¸­å®šä¹‰çš„UIå…ƒç´ 
        const uiBottomPanel = document.getElementById('ui-bottom-panel');
        const uiDialogPanel = document.getElementById('ui-dialog-panel');
        
        if (!uiBottomPanel || !uiDialogPanel) {
            console.error("æ‰¾ä¸åˆ°UIå®¹å™¨å…ƒç´ ");
            return;
        }

        // è®¾ç½®æ¸¸æˆå®¹å™¨æ ·å¼
        gameContainer.style.position = 'relative';
        gameContainer.style.width = '100%';
        gameContainer.style.minHeight = '500px'; // è®¾ç½®æœ€å°é«˜åº?        
        // åˆ›å»º"æ— å¯¹è¯æ—¶æ˜¾ç¤ºçš„é»˜è®¤å†…å®?
        const defaultDialogContent = document.createElement('div');
        defaultDialogContent.id = 'default-dialog-content';
        defaultDialogContent.style.textAlign = 'center';
        defaultDialogContent.style.padding = '20px';
        defaultDialogContent.style.color = '#aaa';
        defaultDialogContent.innerHTML = 'å½“å‰æ²¡æœ‰å¯¹è¯...';
        uiDialogPanel.appendChild(defaultDialogContent);

        // åˆ›å»ºå¯¹è¯å†…å®¹å®¹å™¨
        const dialogContent = document.createElement('div');
        dialogContent.id = 'conversation-content';
        dialogContent.style.display = 'flex';
        dialogContent.style.flexDirection = 'column';
        dialogContent.style.gap = '10px';
        uiDialogPanel.appendChild(dialogContent);
        
        // åˆå§‹åŒ–æ˜¾ç¤ºä¸€äº›æ¨¡æ‹Ÿå¯¹è¯?        showWelcomeMessages(dialogContent);

        // åˆ›å»ºPixiJSåº”ç”¨
        app = new PIXI.Application({
            width: document.documentElement.clientWidth,
            height: Math.min(document.documentElement.clientHeight * 0.7, 800), // æ§åˆ¶æ¸¸æˆé«˜åº¦ï¼Œä¸è¶…è¿‡å±å¹•70%
            backgroundColor: 0x00FF00, // æ”¹ä¸ºç»¿è‰²èƒŒæ™¯
            resolution: window.devicePixelRatio || 1,
            autoDensity: true,
            antialias: true,
            powerPreference: 'high-performance',
            preserveDrawingBuffer: true,
        });

        // è®¾ç½®é«˜è´¨é‡æ¸²æŸ?        PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.LINEAR;
        PIXI.settings.ROUND_PIXELS = true;

        // è®¾ç½®canvaså±æ€?        app.renderer.view.style.position = 'relative'; // ç›¸å¯¹å®šä½
        app.renderer.view.style.display = 'block';
        app.renderer.view.style.margin = '0 auto'; // å±…ä¸­æ˜¾ç¤º
        app.renderer.view.style.width = '100%';
        
        // æ·»åŠ åˆ°å®¹å™?        gameContainer.appendChild(app.view);
        
        // åœ¨canvasæ·»åŠ åˆ°DOMåè®¾ç½®willReadFrequentlyå±æ€?        setCanvasWillReadFrequently();
        
        // ä¼˜åŒ–ç¼©æ”¾è´¨é‡
        app.stage.scale.set(zoom);
        
        // æ·»åŠ ç¼©æ”¾æ§åˆ¶åŠŸèƒ½
        setupZoomControls();
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´ç”»å¸ƒå¤§å°?        window.addEventListener('resize', handleResize);
        
        // åˆå§‹åŒ–å±å¹•æ¯”ä¾?        setTimeout(() => {
            handleResize();
        }, 500);
        
        // å¼€å§‹åŠ è½½èµ„æº?        loadResources();
    });

    // æ·»åŠ ç¼©æ”¾æ§åˆ¶åŠŸèƒ½
    function setupZoomControls() {
        try {
            // ä¸å†åˆ›å»ºæ¸¸æˆå†…UIæ§ä»¶ï¼Œè€Œæ˜¯åœ¨åº•éƒ¨æ§åˆ¶æ ä¸­æ·»åŠ?            console.log("ç¼©æ”¾æ§åˆ¶å·²ç§»è‡³åº•éƒ¨æ§åˆ¶æ ");
        } catch (error) {
            console.error("è®¾ç½®ç¼©æ”¾æ§åˆ¶æ—¶å‡ºé”?", error);
        }
    }
    
    // è®¾ç½®å±å¹•æ¯”ä¾‹æ§åˆ¶ - ä¿®æ”¹è¿™ä¸ªå‡½æ•°æ¥ç§»é™¤æ¸¸æˆå†…çš„æ§åˆ¶UI
    function setupAspectRatioControls() {
        try {
            // ä¸å†åˆ›å»ºæ¸¸æˆå†…UIæ§ä»¶ï¼Œè€Œæ˜¯åœ¨åº•éƒ¨æ§åˆ¶æ ä¸­æ·»åŠ?            console.log("å±å¹•æ¯”ä¾‹æ§åˆ¶å·²ç§»è‡³åº•éƒ¨æ§åˆ¶æ ");
        } catch (error) {
            console.error("è®¾ç½®å±å¹•æ¯”ä¾‹æ§åˆ¶æ—¶å‡ºé”?", error);
        }
    }
    
    // è°ƒæ•´æ¸¸æˆç”»é¢æ¯”ä¾‹
    function adjustGameAspectRatio(ratio) {
        try {
            const gameContainer = document.getElementById('game-container');
            if (!gameContainer) return;
            
            // ä¿å­˜å½“å‰è§†å›¾ä¸­å¿ƒ
            const centerX = app.stage.pivot.x;
            const centerY = app.stage.pivot.y;
            
            // è·å–å¯ç”¨å®½åº¦
            const availableWidth = document.documentElement.clientWidth;
            let targetHeight;
            
            if (ratio === 'fullscreen') {
                // å…¨å±æ¨¡å¼
                targetHeight = window.innerHeight - 100; // é¢„ç•™ä¸€äº›ç©ºé—´ç»™å…¶ä»–UIå…ƒç´ 
            } else if (ratio === 'auto') {
                // è‡ªé€‚åº”æ¨¡å¼
                targetHeight = Math.min(document.documentElement.clientHeight * 0.7, 800);
            } else {
                // æ ¹æ®æ¯”ä¾‹è®¡ç®—é«˜åº¦
                targetHeight = availableWidth / ratio;
                // é™åˆ¶æœ€å¤§é«˜åº?                targetHeight = Math.min(targetHeight, window.innerHeight - 100);
            }
            
            // åº”ç”¨æ–°å°ºå¯?            app.renderer.resize(availableWidth, targetHeight);
            gameContainer.style.height = `${targetHeight}px`;
            
            // æ›´æ–°UIä½ç½®
            const uiBottomPanel = document.getElementById('ui-bottom-panel');
            if (uiBottomPanel) {
                uiBottomPanel.style.top = `${targetHeight}px`;
            }
            
            // æ¢å¤è§†å›¾ä¸­å¿ƒ
            app.stage.position.set(app.screen.width / 2, app.screen.height / 2);
            app.stage.pivot.set(centerX, centerY);
            
            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
            app.renderer.render(app.stage);
            
            console.log(`å·²è°ƒæ•´æ¸¸æˆç”»é¢æ¯”ä¾‹ä¸º ${ratio === 'fullscreen' ? 'å…¨å±' : (ratio === 'auto' ? 'è‡ªé€‚åº”' : ratio)}`);
            
            // ä¿å­˜å½“å‰è®¾ç½®åˆ°localStorage
            try {
                localStorage.setItem('gameAspectRatio', ratio);
            } catch (e) {
                console.warn('æ— æ³•ä¿å­˜ç”»é¢æ¯”ä¾‹è®¾ç½®:', e);
            }
        } catch (error) {
            console.error("è°ƒæ•´æ¸¸æˆç”»é¢æ¯”ä¾‹æ—¶å‡ºé”?", error);
        }
    }

    // å¤„ç†çª—å£å¤§å°å˜åŒ–
    function handleResize() {
        if (app) {
            try {
                // è·å–ä¿å­˜çš„æ¯”ä¾‹è®¾ç½?                let savedRatio;
                try {
                    savedRatio = localStorage.getItem('gameAspectRatio');
                    if (savedRatio === 'fullscreen' || savedRatio === 'auto') {
                        // ä½¿ç”¨å­—ç¬¦ä¸²å€?                    } else if (savedRatio) {
                        savedRatio = parseFloat(savedRatio);
                    }
                } catch (e) {
                    console.warn('æ— æ³•è·å–ä¿å­˜çš„ç”»é¢æ¯”ä¾‹è®¾ç½?', e);
                    savedRatio = 'auto';  // é»˜è®¤è‡ªé€‚åº”
                }
                
                // åº”ç”¨ä¿å­˜çš„æ¯”ä¾?                if (savedRatio) {
                    adjustGameAspectRatio(savedRatio);
                } else {
                    // é»˜è®¤è°ƒæ•´
                    adjustGameAspectRatio('auto');
                }
            } catch (error) {
                console.error("çª—å£å¤§å°å˜åŒ–å¤„ç†æ—¶å‡ºé”?", error);
                
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤è°ƒæ•?            app.renderer.resize(
                document.documentElement.clientWidth,
                    Math.min(document.documentElement.clientHeight * 0.7, 800)
                );
            }
        }
    }

    // åº”ç”¨é«˜è´¨é‡ç¼©æ”?    function applyHighQualityZoom(zoomLevel) {
        try {
            // è®°å½•å½“å‰è§†å›¾ä¸­å¿ƒ
            const centerX = app.stage.pivot.x;
            const centerY = app.stage.pivot.y;
            
            // ä½¿ç”¨æ•´æ•°ç¼©æ”¾çº§åˆ«é¿å…æ¨¡ç³Š
            const roundedZoom = Math.round(zoomLevel * 100) / 100;
            
            // é«˜è´¨é‡ç¼©æ”¾è®¾ç½?            app.renderer.resolution = window.devicePixelRatio || 1;
            app.stage.scale.set(roundedZoom);
            
            // ç¡®ä¿spriteä½¿ç”¨é«˜è´¨é‡ç¼©æ”¾æ¨¡å¼?            if (app && app.stage && app.stage.children) {
                app.stage.children.forEach(container => {
                    if (container && container.children) {
                        container.children.forEach(sprite => {
                            if (sprite && sprite.texture && sprite.texture.baseTexture) {
                                sprite.texture.baseTexture.scaleMode = PIXI.SCALE_MODES.LINEAR;
                            }
                        });
                    }
                });
            }
            
            // æ›´æ–°æ‰€æœ‰å¯¹è¯æ°”æ³¡çš„ç¼©æ”¾ï¼Œä½¿å…¶å¤§å°ä¸å—æ¸¸æˆç¼©æ”¾å½±å“?            for (let personaName in pronunciatios) {
                if (pronunciatios[personaName] && pronunciatios[personaName].container) {
                    updateBubblePosition(personaName);
                }
            }
            
            // å¼ºåˆ¶æ•´ä¸ªèˆå°é‡æ–°æ¸²æŸ“
            if (app && app.renderer) {
                app.renderer.render(app.stage);
            }
            
            console.log(`åº”ç”¨é«˜è´¨é‡ç¼©æ”? ${roundedZoom}`);
        } catch (error) {
            console.error("åº”ç”¨é«˜è´¨é‡ç¼©æ”¾æ—¶å‡ºé”™:", error);
        }
    }
    
    // è®¾ç½®Canvas willReadFrequentlyå±æ€?    function setCanvasWillReadFrequently() {
        try {
            // åº”ç”¨åˆ°æ‰€æœ‰canvaså…ƒç´ 
            document.querySelectorAll('canvas').forEach(canvas => {
                canvas.willReadFrequently = true;
                console.log("è®¾ç½®canvas willReadFrequently=true");
            });
            
            // åº”ç”¨åˆ°PixiJSçš„canvas
            if (app && app.view) {
                app.view.willReadFrequently = true;
                console.log("è®¾ç½®PixiJS canvas willReadFrequently=true");
            }
        } catch (error) {
            console.error("è®¾ç½®canvas willReadFrequentlyå±æ€§å¤±è´?", error);
        }
    }

    // åˆ›å»ºUIæ–‡æœ¬
    function createText(x, y, text, bgColor = 0xffffcc, emoji = "") {
        const container = new PIXI.Container();
        
        // ä½¿ç”¨æ›´é†’ç›®çš„æ ·å¼
        const style = new PIXI.TextStyle({
            fontFamily: 'é»‘ä½“',
            fontSize: 26,
            fontWeight: 'bold',
            fill: '#FFFFFF',
            stroke: '#000000',
            strokeThickness: 2,
            wordWrap: true,
            wordWrapWidth: 1200/zoom,
            dropShadow: true,
            dropShadowColor: '#000000',
            dropShadowBlur: 4,
            dropShadowDistance: 2
        });
        
        const textSprite = new PIXI.Text(`${emoji} ${text}`, style);
        
        const padding = {x: 20, y: 8};
        const background = new PIXI.Graphics();
        background.beginFill(bgColor);
        background.lineStyle(2, 0x000000, 1);
        background.drawRoundedRect(
            -padding.x, 
            -padding.y, 
            textSprite.width + padding.x * 2, 
            textSprite.height + padding.y * 2,
            12
        );
        background.endFill();
        background.alpha = 0.85;
        
        container.addChild(background);
        container.addChild(textSprite);
        
        container.x = x;
        container.y = y;
        container.zIndex = 10;
        container.interactive = true;
        container.buttonMode = true;
        
        // æ·»åŠ æ‚¬åœæ•ˆæœ
        container.on('pointerover', function() {
            background.alpha = 1;
            container.scale.set(1.05);
        });
        
        container.on('pointerout', function() {
            background.alpha = 0.85;
            container.scale.set(1);
        });
        
        return container;
    }

    // åŠ è½½èµ„æº
    function loadResources() {
        console.log("å¼€å§‹åŠ è½½èµ„æº?..");
        
        // æ·»åŠ é”™è¯¯å¤„ç†
        app.loader.onError.add((error, loader, resource) => {
            console.error("èµ„æºåŠ è½½é”™è¯¯:", error);
            console.error("èµ„æº:", resource.url);
            showSystemMessage(`èµ„æºåŠ è½½å¤±è´¥: ${resource.url.split('/').pop()}`);
        });
        
        // æŠ¥å‘Šè¿›åº¦
        app.loader.onProgress.add((loader, resource) => {
            console.log(`åŠ è½½è¿›åº¦: ${Math.round(loader.progress)}% - åŠ è½½: ${resource.url}`);
            
            // æ˜¾ç¤ºåŠ è½½è¿›åº¦
            if (Math.round(loader.progress) % 20 === 0) { // æ¯?0%æ˜¾ç¤ºä¸€æ¬?                showSystemMessage(`èµ„æºåŠ è½½ä¸? ${Math.round(loader.progress)}%`, 1000);
            }
        });
        
        // æ·»åŠ ç‰¹æ®Šæ–­ç‚¹æ£€æµ?        app.loader.onComplete.add((loader, resources) => {
            console.log("èµ„æºåŠ è½½å®Œæˆï¼Œæ£€æŸ¥å…³é”®èµ„æºæ˜¯å¦å­˜åœ?);
            
            // æ£€æŸ¥åœ°å›¾èµ„æº?            if (!resources.map) {
                console.error("åœ°å›¾èµ„æºåŠ è½½å¤±è´¥ï¼Œå°è¯•å†æ¬¡åŠ è½?);
                showSystemMessage("åœ°å›¾èµ„æºåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡?);
                
                // å°è¯•ç›´æ¥åŠ è½½åœ°å›¾JSON
                fetch('static/assets/village/tilemap/tilemap.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ç½‘ç»œé”™è¯¯');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("ç›´æ¥è·å–åœ°å›¾æ•°æ®æˆåŠŸ");
                        resources.map = { data };
                        setupGame(resources);
                    })
                    .catch(error => {
                        console.error("ç›´æ¥è·å–åœ°å›¾æ•°æ®å¤±è´¥:", error);
                        setupGame(resources); // ç»§ç»­ä½¿ç”¨åŸæœ‰èµ„æº
                    });
            }
            
            // æ£€æŸ¥ç©å®¶çº¹ç?            if (!resources.player_spritesheet) {
                console.error("ç©å®¶çº¹ç†åŠ è½½å¤±è´¥");
                showSystemMessage("ç©å®¶çº¹ç†åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨å ä½ç¬?);
            }
            
            // åŠ è½½è§’è‰²å›¾ç‰‡èµ„æº
            loadCharacterImages();
        });
        
        // åŠ è½½åœ°å›¾ç“¦ç‰‡
        for(let i = 1; i <= 8; i++) {
            app.loader.add(`tilemap${i}`, `static/assets/village/tilemap/${i}.png`);
        }
        
        app.loader.add('map', 'static/assets/village/tilemap/tilemap.json');

        // åŠ è½½ç©å®¶å’ŒNPCçš„ç²¾çµè¡¨
        app.loader.add('player_spritesheet', 'static/assets/village/agents/å®éªŒè€?texture.png');
        
        // åŠ è½½æ‰€æœ‰NPCçš„ç²¾çµè¡¨
        for (let p in persona_names) {
            if (p !== 'å®éªŒè€?) {  // è·³è¿‡ç©å®¶è§’è‰²
                app.loader.add(`${p}_spritesheet`, `static/assets/village/agents/${p}/texture.png`);
            }
        }

        // å¼€å§‹åŠ è½?        app.loader.load((loader, resources) => {
            console.log("èµ„æºåŠ è½½å®Œæˆ");
            console.log("åŠ è½½çš„èµ„æº?", Object.keys(resources));
            setupGame(resources);
        });
    }

    // åŠ è½½è§’è‰²å¤´é¡¶å›¾ç‰‡
    function loadCharacterImages() {
        console.log("å¼€å§‹åŠ è½½è§’è‰²å¤´é¡¶å›¾ç‰?..");
        
        // è§’è‰²æ–‡ä»¶å¤¹æ˜ å°„å…³ç³»ï¼ˆæ–‡ä»¶å¤¹IDåˆ°è§’è‰²åï¼?        const folderToPersonaMap = {
            'wxr31': 'ç´¢ä¼¦ç‰?
            // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šæ˜ å°?        };
        
        // éå†æ‰€æœ‰è§’è‰²æ–‡ä»¶å¤¹
        for (const [folderId, personaName] of Object.entries(folderToPersonaMap)) {
            // åˆå§‹åŒ–è¯¥è§’è‰²çš„å›¾ç‰‡æ˜ å°?            if (!characterImages[personaName]) {
                characterImages[personaName] = [];
            }
            
            // ä½¿ç”¨fetchè·å–è§’è‰²å›¾ç‰‡åˆ—è¡¨
            fetch(`/list_images?folder=${folderId}/${personaName}`)
                .then(response => response.json())
                .then(imageFiles => {
                    console.log(`åŠ è½½${personaName}çš„å›¾ç‰?`, imageFiles);
                    
                    // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰?                    imageFiles.forEach(file => {
                        const imagePath = `static/assets/village/generated_images/${folderId}/${personaName}/${file}`;
                        const imgTexture = PIXI.Texture.from(imagePath);
                        
                        // è§£ææ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³
                        // å‡è®¾æ–‡ä»¶åæ ¼å¼ä¸º: YYYY-MM-DD_HHMMSS.png
                        const timeMatch = file.match(/(\d{4}-\d{2}-\d{2})_(\d{2})(\d{2})(\d{2})\.png/);
                        if (timeMatch) {
                            const [_, dateStr, hours, minutes, seconds] = timeMatch;
                            const timeStr = `${hours}:${minutes}:${seconds}`;
                            
                            // åˆ›å»ºæ—¥æœŸå¯¹è±¡
                            const dateObj = new Date(`${dateStr}T${timeStr}`);
                            
                            // å­˜å‚¨å›¾ç‰‡ä¿¡æ¯
                            characterImages[personaName].push({
                                texture: imgTexture,
                                timestamp: dateObj,
                                filename: file,
                                path: imagePath
                            });
                            
                            console.log(`åŠ è½½äº?{personaName}çš„å›¾ç‰? ${file}ï¼Œæ—¶é—? ${dateObj}`);
                        } else {
                            console.warn(`æ— æ³•è§£ææ–‡ä»¶åä¸­çš„æ—¶é—´æˆ³: ${file}`);
                        }
                    });
                })
                .catch(error => {
                    console.error(`è·å–${personaName}å›¾ç‰‡åˆ—è¡¨å¤±è´¥:`, error);
                });
        }
    }

    // å­˜å‚¨è§’è‰²å¤´é¡¶å›¾ç‰‡ç²¾çµçš„å¯¹è±?    const characterHeadImages = {};

    // æ›´æ–°è§’è‰²å¤´é¡¶å›¾ç‰‡
    function updateCharacterImage(personaName, currentGameTime) {
        // æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰å›¾ç‰‡èµ„æº
        if (!characterImages || !characterImages[personaName] || !characterImages[personaName].length) {
            return;
        }
        
        // è·å–è§’è‰²å¯¹è±¡
        const character = personas[personaName];
        if (!character) {
            return;
        }
        
        // å¯»æ‰¾åŒ¹é…å½“å‰æ¸¸æˆæ—¶é—´çš„å›¾ç‰?        // å…è®¸5åˆ†é’Ÿçš„æ—¶é—´è¯¯å·®èŒƒå›?        const TIME_TOLERANCE_MS = 5 * 60 * 1000;
        const currentTimeMS = currentGameTime.getTime();
        
        let matchedImage = null;
        let closestTimeDiff = Infinity;
        
        for (const imgInfo of characterImages[personaName]) {
            const timeDiff = Math.abs(imgInfo.timestamp.getTime() - currentTimeMS);
            
            // å¦‚æœåœ¨è¯¯å·®èŒƒå›´å†…ï¼Œå¹¶ä¸”æ˜¯æœ€æ¥è¿‘çš„æ—¶é—?            if (timeDiff < TIME_TOLERANCE_MS && timeDiff < closestTimeDiff) {
                matchedImage = imgInfo;
                closestTimeDiff = timeDiff;
            }
        }
        
        // å¦‚æœå·²ç»æ˜¾ç¤ºäº†åŒ¹é…çš„å›¾ç‰‡ï¼Œåˆ™ä¸éœ€è¦æ›´æ–?        if (characterHeadImages[personaName] && 
            characterHeadImages[personaName].currentImagePath === matchedImage?.path) {
            return;
        }
        
        // æ¸…é™¤ä¹‹å‰æ˜¾ç¤ºçš„å›¾ç‰?        if (characterHeadImages[personaName]) {
            // å¦‚æœæœ‰æ­£åœ¨æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œåˆ™ç§»é™¤å®?            if (characterHeadImages[personaName].sprite && 
                characterHeadImages[personaName].sprite.parent) {
                characterHeadImages[personaName].sprite.parent.removeChild(
                    characterHeadImages[personaName].sprite
                );
            }
            
            // æ¸…é™¤å®šæ—¶å™?            if (characterHeadImages[personaName].timer) {
                clearTimeout(characterHeadImages[personaName].timer);
            }
            
            characterHeadImages[personaName] = null;
        }
        
        // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡ï¼Œåˆ™æ˜¾ç¤?        if (matchedImage) {
            // åˆ›å»ºå›¾ç‰‡ç²¾çµ
            const sprite = new PIXI.Sprite(matchedImage.texture);
            
            // è®¾ç½®ç²¾çµå±æ€?            sprite.anchor.set(0.5, 1); // é”šç‚¹è®¾ç½®ä¸ºåº•éƒ¨ä¸­å¿?            sprite.scale.set(0.3, 0.3); // ç¼©å°å›¾ç‰‡å°ºå¯¸
            sprite.zIndex = 1000; // ç¡®ä¿åœ¨æ‰€æœ‰å†…å®¹ä¸Šæ–?            
            // è®¾ç½®ç²¾çµä½ç½® (è§’è‰²å¤´é¡¶ä¸Šæ–¹)
            sprite.x = 0;
            sprite.y = -120; // è§’è‰²å¤´é¡¶ä»¥ä¸Šçš„ä½ç½?            
            // æ·»åŠ åˆ°è§’è‰²å®¹å™?            character.addChild(sprite);
            
            // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ä¿¡æ?            characterHeadImages[personaName] = {
                sprite: sprite,
                currentImagePath: matchedImage.path,
                timestamp: matchedImage.timestamp,
                // è®¾ç½®10ç§’åè‡ªåŠ¨éšè—å›¾ç‰‡
                timer: setTimeout(() => {
                    if (characterHeadImages[personaName] && 
                        characterHeadImages[personaName].sprite &&
                        characterHeadImages[personaName].sprite.parent) {
                        // æ¸éšæ•ˆæœ
                        const fadeOut = () => {
                            if (sprite.alpha > 0.1) {
                                sprite.alpha -= 0.1;
                                requestAnimationFrame(fadeOut);
                            } else {
                                // å®Œå…¨éšè—åç§»é™¤ç²¾ç?                                sprite.parent.removeChild(sprite);
                                characterHeadImages[personaName] = null;
                            }
                        };
                        fadeOut();
                    }
                }, 10000) // 10ç§’åéšè—
            };
            
            console.log(`æ˜¾ç¤º${personaName}åœ?{matchedImage.timestamp}çš„å›¾ç‰‡`);
        }
    }

    // æ¸¸æˆè®¾ç½®
    function setupGame(resources) {
        console.log("è®¾ç½®æ¸¸æˆ...");
        console.log("å¯ç”¨èµ„æºé”®å:", Object.keys(resources));
        
        // æ£€æŸ¥å…³é”®èµ„æºæ˜¯å¦å­˜åœ?        if (!resources.map) {
            console.error("åœ°å›¾èµ„æºä¸å­˜åœ¨ï¼Œæ£€æŸ¥èµ„æºè·¯å¾„å’ŒåŠ è½½è¿‡ç¨‹");
            showSystemMessage("åœ°å›¾èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ?);
        }
        
        // åˆ›å»ºåœ°å›¾å®¹å™¨
        mapContainer = new PIXI.Container();
        mapContainer.zIndex = 1; // æœ€ä½å±‚
        app.stage.addChild(mapContainer);
        
        // åˆ›å»ºè§’è‰²å®¹å™¨
        const characterContainer = new PIXI.Container();
        characterContainer.sortableChildren = true; // ç¡®ä¿æ·±åº¦æ’åº
        characterContainer.zIndex = 2; // è§’è‰²åœ¨åœ°å›¾ä¸Šæ–?        app.stage.addChild(characterContainer);
        
        // å¯ç”¨æ·±åº¦æ’åº
        app.stage.sortableChildren = true;
        app.stage.sortChildren();
        
        // åˆ›å»ºåœ°å›¾
        createMap(resources);
        
        // åˆ›å»ºUI (ç°åœ¨ä½¿ç”¨DOMå…ƒç´ è€ŒéPixiJS)
        createUI();
        
        // è®¾ç½®ç©å®¶è§’è‰²
        console.log("åˆ›å»ºç©å®¶è§’è‰²...");
        try {
            // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥ç©å®¶çº¹ç†æ˜¯å¦å­˜åœ?            console.log("ç©å®¶çº¹ç†èµ„æº:", resources.player_spritesheet);
            
            // ä½¿ç”¨å®éªŒè€…ä½œä¸ºç©å®¶è§’è‰?            let playerTexture = resources.player_spritesheet ? resources.player_spritesheet.texture : null;
            if (!playerTexture) {
                throw new Error("ç©å®¶çº¹ç†ä¸å¯ç”?);
            } else {
                console.log("ç©å®¶çº¹ç†å°ºå¯¸:", playerTexture.width, "x", playerTexture.height);
            }
            
            // åˆ›å»ºç©å®¶è§’è‰²
            player = createCharacter('player', 6000, 3000, playerTexture); // Yåæ ‡ä¸Šç§»5ä¸ªåƒç´?            player.zIndex = 2;
            characterContainer.addChild(player);
            console.log("ç©å®¶è§’è‰²åˆ›å»ºæˆåŠŸ");
        } catch (error) {
            console.error("åˆ›å»ºç©å®¶å¤±è´¥:", error);
            // åˆ›å»ºä¸€ä¸ªå ä½ç¬¦ä½œä¸ºåå¤‡
            player = createCharacterPlaceholder(2500, 2495); // Yåæ ‡ä¸Šç§»5ä¸ªåƒç´?            characterContainer.addChild(player);
            console.log("ä½¿ç”¨å ä½ç¬¦æ›¿ä»£ç©å®¶è§’è‰?);
        }
        
        // è®¾ç½®NPCè§’è‰²
        console.log("åˆ›å»ºNPCè§’è‰²...");
        console.log("è¦åˆ›å»ºçš„NPC:", Object.keys(persona_names));
        
        let successfulNPCs = 0;
        let failedNPCs = 0;
        
        for (let p in persona_names) {
            if (p === 'å®éªŒè€?) continue; // è·³è¿‡ç©å®¶è§’è‰²
            
            try {
                console.log(`å¼€å§‹åˆ›å»ºNPC: ${p}`);
                const startPos = spawn_tile_loc[p];
                if (!startPos) {
                    console.error(`NPC ${p} æ²¡æœ‰èµ·å§‹ä½ç½®`);
                    failedNPCs++;
                    continue;
                }
                
                const x = startPos[0] * tile_width + tile_width / 2 - 10;
                const y = startPos[1] * tile_width + tile_width - 5; // å°†NPCä¸Šç§»5ä¸ªåƒç´?                
                console.log(`NPC ${p} ä½ç½®: ${x}, ${y}`);
                
                // æ£€æŸ¥PNGèµ„æºæ˜¯å¦å¯ç”¨
                const resourceKey = `${p}_spritesheet`;
                console.log(`æ£€æŸ¥NPCèµ„æº: ${resourceKey}`);
                
                if (!resources[resourceKey]) {
                    console.error(`æœªæ‰¾åˆ°NPC ${p} çš„èµ„æº? å°è¯•ä½¿ç”¨æ›¿ä»£æ–¹æ³•`);
                    
                    // å°è¯•ä½¿ç”¨é€šç”¨NPCèµ„æºæˆ–åˆ›å»ºå ä½ç¬¦
                    const npc = createCharacterPlaceholder(x, y);
                    npc.zIndex = 2;
                    characterContainer.addChild(npc);
                    personas[p] = npc;
                    
                    // åˆå§‹åŒ–åŠ¨ç”»æ–¹å‘å­—å…?                    pre_anims_direction_dict[p] = "d"; // é»˜è®¤æœä¸‹
                    
                    // åˆ›å»ºå¯¹è¯æ°”æ³¡
                    createDialogueBubble(npc, p);
                    console.log(`NPC ${p} ä½¿ç”¨å ä½ç¬¦åˆ›å»ºå®Œæˆ`);
                    failedNPCs++;
                    continue;
                }
                
                if (!resources[resourceKey].texture) {
                    console.error(`NPC ${p} çš„PNGçº¹ç†ä¸å¯ç”¨`);
                    failedNPCs++;
                    continue;
                } else {
                    console.log(`NPC ${p} çº¹ç†å°ºå¯¸:`, resources[resourceKey].texture.width, "x", resources[resourceKey].texture.height);
                }
                
                // åˆ›å»ºNPCè§’è‰²
                const npc = createCharacter(p, x, y, resources[resourceKey].texture);
                npc.zIndex = 2;
                characterContainer.addChild(npc);
                personas[p] = npc;
                
                // åˆå§‹åŒ–åŠ¨ç”»æ–¹å‘å­—å…?                pre_anims_direction_dict[p] = "d"; // é»˜è®¤æœä¸‹
                
                // åˆ›å»ºå¯¹è¯æ°”æ³¡
                createDialogueBubble(npc, p);
                console.log(`NPC ${p} åˆ›å»ºå®Œæˆ`);
                successfulNPCs++;
            } catch (error) {
                console.error(`åˆ›å»ºNPC ${p} æ—¶å‡ºé”?`, error);
                failedNPCs++;
                
                // æ·»åŠ å ä½ç¬¦ä½œä¸ºåå¤?                const startPos = spawn_tile_loc[p] || [100, 100]; // å¦‚æœæ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€?                const x = startPos[0] * tile_width + tile_width / 2 - 10;
                const y = startPos[1] * tile_width + tile_width - 5; // å°†åå¤‡NPCä¹Ÿä¸Šç§?ä¸ªåƒç´?                
                const npc = createCharacterPlaceholder(x, y);
                npc.zIndex = 2;
                characterContainer.addChild(npc);
                personas[p] = npc;
                
                // åˆå§‹åŒ–åŠ¨ç”»æ–¹å‘å­—å…?                pre_anims_direction_dict[p] = "d"; // é»˜è®¤æœä¸‹
                
                // åˆ›å»ºå¯¹è¯æ°”æ³¡
                createDialogueBubble(npc, p);
                console.log(`NPC ${p} ä½¿ç”¨å ä½ç¬¦æ›¿ä»£`);
            }
        }
        
        console.log(`NPCåˆ›å»ºå®Œæˆ: æˆåŠŸ ${successfulNPCs}ä¸? å¤±è´¥ ${failedNPCs}ä¸ª`);
        
        // ç¡®ä¿æ·±åº¦æ’åº
        characterContainer.sortChildren();
        app.stage.sortChildren();
        
        // è®¾ç½®é”®ç›˜æ§åˆ¶
        setupKeyboardControls();
        
        // ç¡®ä¿æ‰€æœ‰ç¢°æ’æ¡†éšè—
        showAllCollisionBoxes(false);
        
        // å¼ºåˆ¶æ›´æ–°UIç¡®ä¿å¯è§
        forceUpdateUI();
        
        // åº”ç”¨Canvasä¼˜åŒ–
        setCanvasWillReadFrequently();
        
        // å¼€å§‹æ¸¸æˆå¾ªç?        app.ticker.add(gameLoop);
        
        console.log("æ¸¸æˆè®¾ç½®å®Œæˆ");
        
        // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ç”¨æˆ·æ¸¸æˆå·²å‡†å¤‡å°±ç»?        showSystemMessage("æ¸¸æˆä¸–ç•Œå·²åŠ è½½å®Œæˆ?);
    }
    
    // åˆ›å»ºåœ°å›¾
    function createMap(resources) {
        try {
            if (!resources.map || !resources.map.data) {
                console.error("åœ°å›¾æ•°æ®æœªèƒ½æ­£ç¡®åŠ è½½");
                createSimpleBackground();
                showSystemMessage("åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€å•èƒŒæ™¯æ›¿ä»?);
                return;
            }

            const mapData = resources.map.data;
            
            // åˆ›å»ºåŸºç¡€èƒŒæ™¯
            createSimpleBackground();

            // è·å–ç“¦ç‰‡é›†ä¿¡æ?            const tilesets = mapData.tilesets;
            
            // é¢„å…ˆæ£€æŸ¥ç“¦ç‰‡é›†èµ„æº
            let allTilesetsAvailable = true;
            for (let i = 1; i <= tilesets.length; i++) {
                const textureName = `tilemap${i}`;
                if (!resources[textureName] || !resources[textureName].texture) {
                    console.error(`ç“¦ç‰‡é›?${textureName} æœªåŠ è½½æˆ–æ— æ•ˆ`);
                    allTilesetsAvailable = false;
                }
            }
            
            if (!allTilesetsAvailable) {
                console.error("éƒ¨åˆ†ç“¦ç‰‡é›†èµ„æºä¸å¯ç”¨ï¼Œåœ°å›¾å¯èƒ½æ— æ³•æ­£ç¡®æ˜¾ç¤?);
                showSystemMessage("éƒ¨åˆ†åœ°å›¾èµ„æºåŠ è½½å¤±è´¥");
            }

            // åˆ›å»ºç“¦ç‰‡åœ°å›¾å±?            let visibleLayerCount = 0;
            
            mapData.layers.forEach((layer, index) => {
                if (layer.type === "tilelayer") {
                    const layerContainer = new PIXI.Container();
                    
                    // è®¾ç½®å›¾å±‚é€æ˜åº?                    let layerVisible = true;
                    if (layer.visible === false) {
                        layerContainer.visible = false;
                        layerVisible = false;
                    } else {
                        visibleLayerCount++;
                    }
                    
                    if (layer.opacity !== undefined) {
                        layerContainer.alpha = layer.opacity;
                    }
                    
                    // æ¸²æŸ“å›¾å±‚ç“¦ç‰‡
                    let tileCount = 0;
                    
                    for (let y = 0; y < layer.height; y++) {
                        for (let x = 0; x < layer.width; x++) {
                            const tileIndex = y * layer.width + x;
                            const tileId = layer.data[tileIndex];
                            
                            if (tileId !== 0) {  // 0 è¡¨ç¤ºç©ºç“¦ç‰?                                tileCount++;
                                
                                // æ‰¾åˆ°å¯¹åº”çš„ç“¦ç‰‡é›†
                                let tileset = null;
                                let tilesetIndex = 0;
                                
                                for (let i = 0; i < tilesets.length; i++) {
                                    if (tileId >= tilesets[i].firstgid && 
                                        (!tilesets[i+1] || tileId < tilesets[i+1].firstgid)) {
                                        tileset = tilesets[i];
                                        tilesetIndex = i + 1;
                                        break;
                                    }
                                }
                                
                                if (tileset) {
                                    const textureName = `tilemap${tilesetIndex}`;
                                    if (resources[textureName] && resources[textureName].texture) {
                                        // è®¡ç®—ç“¦ç‰‡åœ¨ç“¦ç‰‡é›†ä¸­çš„ä½ç½®
                                        const localId = tileId - tileset.firstgid;
                                        const tilesPerRow = Math.floor(tileset.imagewidth / tileset.tilewidth);
                                        const tileX = (localId % tilesPerRow) * tileset.tilewidth;
                                        const tileY = Math.floor(localId / tilesPerRow) * tileset.tileheight;
                                        
                                        try {
                                            // åˆ›å»ºç“¦ç‰‡ç²¾çµ
                                            const texture = new PIXI.Texture(
                                                resources[textureName].texture.baseTexture,
                                                new PIXI.Rectangle(tileX, tileY, tileset.tilewidth, tileset.tileheight)
                                            );
                                            const tile = new PIXI.Sprite(texture);
                                            
                                            // è®¾ç½®ç“¦ç‰‡ä½ç½®
                                            tile.x = x * tile_width;
                                            tile.y = y * tile_width;
                                            
                                            layerContainer.addChild(tile);
                                        } catch (error) {
                                            console.error(`åˆ›å»ºç“¦ç‰‡æ—¶å‡ºé”?(å›¾å±‚: ${layer.name}, ä½ç½®: ${x},${y}, ç“¦ç‰‡ID: ${tileId}):`, error);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // è®¾ç½®ç‰¹å®šå›¾å±‚çš„é€æ˜åº?                    if (layer.name.startsWith("1") || layer.name.startsWith("2")) {
                        if (layer.name.includes("éŸ³ä¹åŒ?)) {
                            layerContainer.alpha = 0.02;
                        } else {
                            layerContainer.alpha = 0.3;
                        }
                    }
                    
                    mapContainer.addChild(layerContainer);
                }
            });

            // æ·»åŠ ç¼©æ”¾å’Œä½ç½®è°ƒæ•?            mapContainer.scale.set(1);
            mapContainer.position.set(0, 0);
            
            // æ·»åŠ è§†å£è·Ÿéš
            app.stage.position.set(app.screen.width / 2, app.screen.height / 2);
            app.stage.pivot.set(2500, 2500);

        } catch (error) {
            console.error("åˆ›å»ºåœ°å›¾å¤±è´¥:", error);
            createSimpleBackground();
        }
    }
    
    // åˆ›å»ºå®éªŒè€…å•çš„èƒŒæ™?    function createSimpleBackground() {
        console.log("åˆ›å»ºå®éªŒè€…å•èƒŒæ™¯");
        const bg = new PIXI.Graphics();
        
        // åˆ›å»ºå¤§èƒŒæ™¯ï¼ŒèƒŒæ™¯é¢œè‰²
        bg.beginFill(0x90EE90);  // æ”¹ä¸ºç»¿è‰²
        bg.drawRect(0, 0, 5000, 5000);
        bg.endFill();
        
        // æ·»åŠ ç½‘æ ¼
        bg.lineStyle(1, 0xCCCCCC, 0.3);
        for (let i = 0; i <= 5000; i += tile_width) {
            bg.moveTo(i, 0);
            bg.lineTo(i, 5000);
            bg.moveTo(0, i);
            bg.lineTo(5000, i);
        }
        
        // æ·»åŠ å‚è€ƒç‚¹
        bg.lineStyle(2, 0xFF0000, 0.5);
        bg.drawCircle(2500, 2500, 50); // ç©å®¶åˆå§‹ä½ç½®æ ‡è®°
        
        // æ·»åŠ åŒºåŸŸæ ‡è®°
        bg.lineStyle(2, 0x0000FF, 0.5);
        for (let p in spawn_tile_loc) {
            const pos = spawn_tile_loc[p];
            const x = pos[0] * tile_width;
            const y = pos[1] * tile_width;
            bg.drawRect(x, y, tile_width, tile_width);
        }
        
        mapContainer.addChild(bg);
        console.log("å®éªŒè€…å•èƒŒæ™¯åˆ›å»ºå®Œæˆ");
    }
    
    // åˆ›å»ºè§’è‰²
    function createCharacter(textureName, x, y, baseTexture = null) {
        try {
            const container = new PIXI.Container();
            container.sortableChildren = true;
            
            container.textureInfo = {
                name: textureName,
                spritesheet: baseTexture,
                frame: 0,
                totalFrames: 24,
                rows: 5,
                cols: 5,
                frameWidth: baseTexture.width / 5,
                frameHeight: baseTexture.height / 5
            };
            
            function createFrameTexture(frame) {
                const col = frame % 5;
                const row = Math.floor(frame / 5);
                return new PIXI.Texture(
                    baseTexture,
                    new PIXI.Rectangle(
                        col * container.textureInfo.frameWidth,
                        row * container.textureInfo.frameHeight,
                        container.textureInfo.frameWidth,
                        container.textureInfo.frameHeight
                    )
                );
            }
            
            const sprite = new PIXI.Sprite(createFrameTexture(0));
            sprite.anchor.set(0.5, 0.5);
            sprite.scale.set(0.14);
            sprite.x = 0;
            sprite.y = -5;
            sprite.zIndex = 1;
            
            container.addChild(sprite);
            
            const collisionBox = new PIXI.Graphics();
            collisionBox.lineStyle(4, 0xFF0000, 1);
            collisionBox.beginFill(0xFF0000, 0.3);
            collisionBox.drawRect(-16, 3, 32, 32);
            collisionBox.endFill();
            
            collisionBox.lineStyle(2, 0xFFFFFF, 1);
            collisionBox.moveTo(-16, 27);
            collisionBox.lineTo(16, 27);
            collisionBox.moveTo(0, 11);
            collisionBox.lineTo(0, 43);
            
            collisionBox.zIndex = 1000;
            collisionBox.visible = false;
            
            const collisionText = new PIXI.Text("ç¢°æ’æ¡?, {
                fontSize: 10,
                fill: 0xFFFFFF,
                fontWeight: 'bold',
                stroke: 0x000000,
                strokeThickness: 3,
                align: 'center'
            });
            collisionText.x = -15;
            collisionText.y = 20;
            collisionText.visible = false;
            collisionBox.addChild(collisionText);
            
            container.addChild(collisionBox);
            container.collisionBox = collisionBox;
            
            container.x = x;
            container.y = y;
            container.zIndex = 2;
            
            container.hitArea = new PIXI.Rectangle(-16, 11, 32, 32);
            
            container.animationState = {
                direction: 'down',
                isMoving: false,
                frameCounter: 0,
                frameDelay: textureName === 'player' ? 6 : 6,
                currentFrameSet: {
                    start: 0,
                    end: 5
                }
            };
            
            // å®šä¹‰åŠ¨ç”»å¸§èŒƒå›´é…ç½?            const ANIMATION_SETS = {
                moving: {
                    left: { start: 0, end: 5 },
                    down: { start: 0, end: 5 },
                    right: { start: 6, end: 11 },
                    up: { start: 6, end: 11 }
                },
                idle: {
                    left: { start: 12, end: 17 },
                    down: { start: 12, end: 17 },
                    right: { start: 18, end: 23 },
                    up: { start: 18, end: 23 }
                }
            };
            
            container.updateAnimation = function(direction, isMoving) {
                this.animationState.direction = direction;
                this.animationState.isMoving = isMoving;
                
                // æ›´æ–°å¸§å»¶è¿?                if (textureName !== 'player') {
                    this.animationState.frameDelay = isMoving ? 4 : 8;
                }
                
                // è·å–å½“å‰çŠ¶æ€çš„å¸§èŒƒå›?                const state = isMoving ? 'moving' : 'idle';
                const frameSet = ANIMATION_SETS[state][direction];
                this.animationState.currentFrameSet = frameSet;
                
                // æ›´æ–°å¸?                this.animationState.frameCounter++;
                if (this.animationState.frameCounter >= this.animationState.frameDelay) {
                    this.animationState.frameCounter = 0;
                    
                    const currentFrame = this.textureInfo.frame;
                    const { start, end } = frameSet;
                    
                    // è®¡ç®—ä¸‹ä¸€å¸?                    this.textureInfo.frame = currentFrame < start || currentFrame >= end
                        ? start
                        : currentFrame + 1 > end ? start : currentFrame + 1;
                    
                    // æ›´æ–°çº¹ç†
                    sprite.texture = createFrameTexture(this.textureInfo.frame);
                }
            };
            
            return container;
        } catch (error) {
            console.error(`åˆ›å»ºè§’è‰² ${textureName} å¤±è´¥:`, error);
            return createCharacterPlaceholder(x, y);
        }
    }
    
    // åˆ›å»ºè‡ªå®šä¹‰SVGåŠ¨ç”»
    function createSvgAnimations(baseTexture) {
        const spriteWidth = baseTexture.width / 5;
        const spriteHeight = baseTexture.height / 5;
        
        const animations = {
            down: { walk: [], idle: [] },
            left: { walk: [], idle: [] },
            right: { walk: [], idle: [] },
            up: { walk: [], idle: [] }
        };
        
        try {
            // åˆ›å»º24å¸§çš„çº¹ç†æ•°ç»„
            const frames = Array.from({ length: 24 }, (_, i) => {
                const x = (i % 5) * spriteWidth;
                const y = Math.floor(i / 5) * spriteHeight;
                return new PIXI.Texture(
                    baseTexture,
                    new PIXI.Rectangle(x, y, spriteWidth, spriteHeight)
                );
            });
            
            // åˆ†é…å¸§åˆ°ä¸åŒçš„åŠ¨ç”»çŠ¶æ€?            const frameRanges = {
                walk: {
                    left: [0, 5],    // 1-6å¸§ç”¨äºå·¦èµ?                    down: [0, 5],    // 1-6å¸§ç”¨äºä¸‹èµ?                    right: [6, 11],  // 7-12å¸§ç”¨äºå³èµ?                    up: [6, 11]      // 7-12å¸§ç”¨äºä¸Šèµ?                },
                idle: {
                    left: [12, 17],  // 13-18å¸§ç”¨äºå·¦å¾…æœº
                    down: [12, 17],  // 13-18å¸§ç”¨äºä¸‹å¾…æœº
                    right: [18, 23], // 19-24å¸§ç”¨äºå³å¾…æœº
                    up: [18, 23]     // 19-24å¸§ç”¨äºä¸Šå¾…æœº
                }
            };
            
            // ä¸ºæ¯ä¸ªæ–¹å‘å’ŒçŠ¶æ€åˆ†é…å¸§
            Object.entries(frameRanges).forEach(([state, directions]) => {
                Object.entries(directions).forEach(([direction, [start, end]]) => {
                    animations[direction][state] = frames.slice(start, end + 1);
                });
            });
            
            return animations;
        } catch (error) {
            // åˆ›å»ºåå¤‡åŠ¨ç”»
            const defaultFrame = new PIXI.Texture(
                baseTexture,
                new PIXI.Rectangle(0, 0, spriteWidth, spriteHeight)
            );
            
            Object.values(animations).forEach(states => {
                Object.keys(states).forEach(state => {
                    states[state] = [defaultFrame];
                });
            });
            
            return animations;
        }
    }
    
    // åˆ›å»ºè§’è‰²å ä½ç¬?    function createCharacterPlaceholder(x, y) {
        const container = new PIXI.Container();
        container.sortableChildren = true;
        
        // åˆ›å»ºåŸºç¡€å›¾å½¢
        const placeholder = new PIXI.Graphics();
        placeholder.beginFill(0xFF0000);
        placeholder.drawCircle(0, -5, 16);
        placeholder.endFill();
        
        placeholder.lineStyle(2, 0xFFFFFF, 1);
        placeholder.moveTo(-16, -5);
        placeholder.lineTo(16, -5);
        placeholder.moveTo(0, -21);
        placeholder.lineTo(0, 11);
        
        placeholder.zIndex = 1;
        container.addChild(placeholder);
        
        // åˆ›å»ºç¢°æ’æ¡?        const collisionBox = new PIXI.Graphics();
        collisionBox.lineStyle(4, 0xFF0000, 1);
        collisionBox.beginFill(0xFF0000, 0.3);
        collisionBox.drawRect(-16, 3, 32, 32);
        collisionBox.endFill();
        
        collisionBox.lineStyle(2, 0xFFFFFF, 1);
        collisionBox.moveTo(-16, 27);
        collisionBox.lineTo(16, 27);
        collisionBox.moveTo(0, 11);
        collisionBox.lineTo(0, 43);
        
        collisionBox.zIndex = 1000;
        collisionBox.visible = false;
        container.addChild(collisionBox);
        container.collisionBox = collisionBox;
        
        // è®¾ç½®å®¹å™¨å±æ€?        container.x = x;
        container.y = y;
        container.zIndex = 2;
        
        // æ·»åŠ ç©ºçš„åŠ¨ç”»æ›´æ–°æ–¹æ³•
        container.updateAnimation = function() {};
        
        return container;
    }
    
    // åˆ›å»ºå¯¹è¯æ°”æ³¡
    function createDialogueBubble(personaSprite, personaName) {
        // åˆ›å»ºåŸºç¡€å®¹å™¨
        const dialogueContainer = new PIXI.Container();
        dialogueContainer.name = `dialogue_${personaName}`;
        dialogueContainer.zIndex = 9999;
        
        // åˆ›å»ºèƒŒæ™¯å’Œæ–‡æœ?        const background = new PIXI.Graphics();
        background.name = "dialogue_bg";
        
        const text = new PIXI.Text("", {
            fontFamily: 'Arial',
            fontSize: 14,
            fill: 0x000000,
            align: 'left',
            wordWrap: true,
            wordWrapWidth: 40,
            lineHeight: 10
        });
        text.name = "dialogue_text";
        text.x = 8;
        text.y = 4;
        
        // ç»„è£…æ°”æ³¡
        dialogueContainer.addChild(background);
        dialogueContainer.addChild(text);
        
        // è®¾ç½®ä½ç½®å’Œå¯è§æ€?        dialogueContainer.x = personaSprite.width / 2 - 100;
        dialogueContainer.y = -70;
        dialogueContainer.visible = false;
        
        // æ·»åŠ åˆ°è§’è‰²ç²¾ç?        personaSprite.addChild(dialogueContainer);
        
        // è®°å½•æ°”æ³¡å¼•ç”¨
        pronunciatios[personaName] = {
            container: dialogueContainer,
            background: background,
            text: text,
            personaName: personaName
        };
    }
    
    // åº”ç”¨ç»Ÿä¸€çš„æ–‡æœ¬æ ·å¼?    function applyBubbleTextStyle(textStyle, bubbleType = "dialog") {
        return {
            ...textStyle,
            wordWrap: bubbleType === "dialog",
            fontSize: bubbleType === "action" ? 12 : 14,
            wordWrapWidth: 40,
            lineHeight: 10
        };
    }
    
    // æ ¼å¼åŒ–æ°”æ³¡æ–‡æœ?    function formatBubbleText(text) {
        if (!text?.trim()) return "";
        
        // çŸ­æ–‡æœ¬ä¸éœ€è¦åˆ†è¡?        if (text.length <= 5) return text;
        
        // è®¡ç®—æ¯è¡Œå­—ç¬¦æ•?        const charsPerLine = Math.ceil(text.length / 2);
        
        // æŸ¥æ‰¾åˆé€‚çš„æ–­å¥ç‚?        const breakPoints = [',', 'ï¼?, '.', 'ã€?, '!', 'ï¼?, '?', 'ï¼?, ';', 'ï¼?, ':', 'ï¼?];
        let bestBreakIndex = -1;
        
        // åœ¨ç†æƒ³é•¿åº?0%åˆ?00%èŒƒå›´å†…å¯»æ‰¾æœ€ä½³æ–­å¥ç‚¹
        for (let i = Math.floor(charsPerLine * 0.7); i <= charsPerLine; i++) {
            if (breakPoints.includes(text[i])) {
                bestBreakIndex = i + 1;
                break;
            }
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„æ–­å¥ç‚¹ï¼Œå°±åœ¨ç†æƒ³é•¿åº¦å¤„æ–­å¼€
        if (bestBreakIndex === -1) {
            bestBreakIndex = charsPerLine;
        }
        
        // åˆ†æˆä¸¤è¡Œ
        return text.slice(0, bestBreakIndex) + '\n' + text.slice(bestBreakIndex);
    }
    
    // æ›´æ–°æ°”æ³¡ä½ç½®
    function updateBubblePosition(personaName) {
        const bubble = pronunciatios[personaName];
        if (!bubble?.container || !bubble?.background || !bubble?.text) return;

        const currentZoom = app.stage.scale.x;
        const npc = personas[personaName];
        if (!npc) return;

        // è®¡ç®—æ°”æ³¡å°ºå¯¸
        const bubbleWidth = bubble.background.width;
        const bubbleHeight = bubble.background.height;
        
        // é‡ç½®æ°”æ³¡ç¼©æ”¾ä»¥è¿›è¡Œæ­£ç¡®çš„ä½ç½®è®¡ç®—
        bubble.container.scale.set(1);
        
        // è®¡ç®—æ°”æ³¡ä½ç½®
        const scaledBubbleWidth = bubbleWidth / currentZoom;
        const scaledBubbleHeight = bubbleHeight / currentZoom;
        
        // æ°´å¹³å±…ä¸­å¹¶åº”ç”¨åç§?        bubble.container.x = (npc.width - scaledBubbleWidth) / 2 + bubbleHorizontalOffset;
        
        // å‚ç›´ä½ç½®è°ƒæ•´
        bubble.container.y = -bubbleVerticalOffset - scaledBubbleHeight;
        
        // åº”ç”¨åå‘ç¼©æ”¾å’Œå…¨å±€æ°”æ³¡ç¼©æ”¾
        if (currentZoom > 0) {
            bubble.container.scale.set((1 / currentZoom) * bubbleScale);
        }
        
        // ç¡®ä¿æ°”æ³¡åœ¨æœ€ä¸Šå±‚
        bubble.container.zIndex = 10000;
        npc.sortChildren();
    }
    
    // æ›´æ–°æ‰€æœ‰NPCæ°”æ³¡ä½ç½®
    function updateAllBubblePositions() {
        Object.keys(pronunciatios).forEach(updateBubblePosition);
    }
    
    // åˆ›å»ºUI
    function createUI() {
        // è·å–DOMä¸Šçš„UIå®¹å™¨
        const uiBottomPanel = document.getElementById('ui-bottom-panel');
        const uiDialogPanel = document.getElementById('ui-dialog-panel');
        
        if (!uiBottomPanel || !uiDialogPanel) {
            console.error("æ‰¾ä¸åˆ°UIå®¹å™¨å…ƒç´ ");
            return;
        }
        
        // ç¡®ä¿å¯¹è¯é¢æ¿é»˜è®¤éšè—
        uiDialogPanel.style.display = 'none';
        
        // åˆå§‹åŒ–å¯¹è¯é¢æ¿æ ·å¼?        initDialogPanel();
        
        // æ¸…ç©ºæŒ‰é’®å®¹å™¨
        uiBottomPanel.innerHTML = '';
        
        // åˆ›å»ºå·¦ä¾§æŒ‰é’®å®¹å™¨
        const leftButtonsContainer = document.createElement('div');
        leftButtonsContainer.style.display = 'flex';
        leftButtonsContainer.style.alignItems = 'center';
        leftButtonsContainer.style.gap = '5px'; // æŒ‰é’®ä¹‹é—´çš„é—´è·?        uiBottomPanel.appendChild(leftButtonsContainer);
        
        // åˆ›å»ºä¸­é—´æ§åˆ¶å®¹å™¨ï¼ˆç”¨äºç¼©æ”¾å’Œæ¯”ä¾‹æ§åˆ¶ï¼?        const centerControlsContainer = document.createElement('div');
        centerControlsContainer.style.display = 'flex';
        centerControlsContainer.style.alignItems = 'center';
        centerControlsContainer.style.marginLeft = '15px';
        centerControlsContainer.style.gap = '10px';
        uiBottomPanel.appendChild(centerControlsContainer);
        
        // åˆ›å»ºæ°”æ³¡æ§åˆ¶å®¹å™¨
        const bubbleControlsContainer = document.createElement('div');
        bubbleControlsContainer.style.display = 'flex';
        bubbleControlsContainer.style.flexDirection = 'column';
        bubbleControlsContainer.style.marginLeft = '15px';
        bubbleControlsContainer.style.gap = '5px';
        bubbleControlsContainer.style.padding = '5px';
        bubbleControlsContainer.style.backgroundColor = 'rgba(0,0,0,0.2)';
        bubbleControlsContainer.style.borderRadius = '5px';
        centerControlsContainer.appendChild(bubbleControlsContainer);
        
        // æ°”æ³¡æ§åˆ¶æ ‡é¢˜
        const bubbleControlTitle = document.createElement('div');
        bubbleControlTitle.textContent = 'ğŸ’¬ æ°”æ³¡æ§åˆ¶';
        bubbleControlTitle.style.color = 'white';
        bubbleControlTitle.style.fontSize = '14px';
        bubbleControlTitle.style.fontWeight = 'bold';
        bubbleControlTitle.style.marginBottom = '5px';
        bubbleControlsContainer.appendChild(bubbleControlTitle);
        
        // åˆ›å»ºæ°”æ³¡å¤§å°æ§åˆ¶
        const bubbleScaleContainer = document.createElement('div');
        bubbleScaleContainer.style.display = 'flex';
        bubbleScaleContainer.style.alignItems = 'center';
        bubbleScaleContainer.style.gap = '5px';
        
        const bubbleScaleLabel = document.createElement('span');
        bubbleScaleLabel.textContent = 'å¤§å°:';
        bubbleScaleLabel.style.color = 'white';
        bubbleScaleLabel.style.fontSize = '12px';
        bubbleScaleLabel.style.width = '40px';
        bubbleScaleContainer.appendChild(bubbleScaleLabel);
        
        const bubbleScaleSlider = document.createElement('input');
        bubbleScaleSlider.type = 'range';
        bubbleScaleSlider.min = '0.5';
        bubbleScaleSlider.max = '2.0';
        bubbleScaleSlider.step = '0.1';
        bubbleScaleSlider.value = bubbleScale.toString();
        bubbleScaleSlider.style.width = '80px';
        bubbleScaleSlider.style.height = '6px';
        Object.assign(bubbleScaleSlider.style, {
            appearance: 'none',
            webkitAppearance: 'none',
            backgroundColor: '#555',
            borderRadius: '3px',
            outline: 'none',
            cursor: 'pointer'
        });
        bubbleScaleContainer.appendChild(bubbleScaleSlider);
        
        const bubbleScaleValue = document.createElement('span');
        bubbleScaleValue.textContent = bubbleScale.toFixed(1);
        bubbleScaleValue.style.color = 'white';
        bubbleScaleValue.style.fontSize = '12px';
        bubbleScaleValue.style.minWidth = '25px';
        bubbleScaleContainer.appendChild(bubbleScaleValue);
        
        bubbleControlsContainer.appendChild(bubbleScaleContainer);
        
        // åˆ›å»ºæ°”æ³¡å‚ç›´ä½ç½®æ§åˆ¶
        const bubbleVerticalContainer = document.createElement('div');
        bubbleVerticalContainer.style.display = 'flex';
        bubbleVerticalContainer.style.alignItems = 'center';
        bubbleVerticalContainer.style.gap = '5px';
        
        const bubbleVerticalLabel = document.createElement('span');
        bubbleVerticalLabel.textContent = 'é«˜åº¦:';
        bubbleVerticalLabel.style.color = 'white';
        bubbleVerticalLabel.style.fontSize = '12px';
        bubbleVerticalLabel.style.width = '40px';
        bubbleVerticalContainer.appendChild(bubbleVerticalLabel);
        
        const bubbleVerticalSlider = document.createElement('input');
        bubbleVerticalSlider.type = 'range';
        bubbleVerticalSlider.min = '30';
        bubbleVerticalSlider.max = '200';
        bubbleVerticalSlider.step = '5';
        bubbleVerticalSlider.value = bubbleVerticalOffset.toString();
        bubbleVerticalSlider.style.width = '100px';
        bubbleVerticalSlider.style.height = '6px';
        Object.assign(bubbleVerticalSlider.style, {
            appearance: 'none',
            webkitAppearance: 'none',
            backgroundColor: '#555',
            borderRadius: '3px',
            outline: 'none',
            cursor: 'pointer'
        });
        bubbleVerticalContainer.appendChild(bubbleVerticalSlider);
        
        const bubbleVerticalValue = document.createElement('span');
        bubbleVerticalValue.textContent = bubbleVerticalOffset.toString();
        bubbleVerticalValue.style.color = 'white';
        bubbleVerticalValue.style.fontSize = '12px';
        bubbleVerticalValue.style.minWidth = '25px';
        bubbleVerticalContainer.appendChild(bubbleVerticalValue);
        
        bubbleControlsContainer.appendChild(bubbleVerticalContainer);
        
        // åˆ›å»ºæ°”æ³¡æ°´å¹³ä½ç½®æ§åˆ¶
        const bubbleHorizontalContainer = document.createElement('div');
        bubbleHorizontalContainer.style.display = 'flex';
        bubbleHorizontalContainer.style.alignItems = 'center';
        bubbleHorizontalContainer.style.gap = '5px';
        
        const bubbleHorizontalLabel = document.createElement('span');
        bubbleHorizontalLabel.textContent = 'æ°´å¹³:';
        bubbleHorizontalLabel.style.color = 'white';
        bubbleHorizontalLabel.style.fontSize = '12px';
        bubbleHorizontalLabel.style.width = '40px';
        bubbleHorizontalContainer.appendChild(bubbleHorizontalLabel);
        
        const bubbleHorizontalSlider = document.createElement('input');
        bubbleHorizontalSlider.type = 'range';
        bubbleHorizontalSlider.min = '-200';
        bubbleHorizontalSlider.max = '200';
        bubbleHorizontalSlider.step = '5';
        bubbleHorizontalSlider.value = bubbleHorizontalOffset.toString();
        bubbleHorizontalSlider.style.width = '100px';
        bubbleHorizontalSlider.style.height = '6px';
        Object.assign(bubbleHorizontalSlider.style, {
            appearance: 'none',
            webkitAppearance: 'none',
            backgroundColor: '#555',
            borderRadius: '3px',
            outline: 'none',
            cursor: 'pointer'
        });
        bubbleHorizontalContainer.appendChild(bubbleHorizontalSlider);
        
        const bubbleHorizontalValue = document.createElement('span');
        bubbleHorizontalValue.textContent = bubbleHorizontalOffset.toString();
        bubbleHorizontalValue.style.color = 'white';
        bubbleHorizontalValue.style.fontSize = '12px';
        bubbleHorizontalValue.style.minWidth = '25px';
        bubbleHorizontalContainer.appendChild(bubbleHorizontalValue);
        
        bubbleControlsContainer.appendChild(bubbleHorizontalContainer);
        
        // æ·»åŠ æ°”æ³¡æ§åˆ¶äº‹ä»¶ç›‘å¬
        bubbleScaleSlider.addEventListener('input', (e) => {
            bubbleScale = parseFloat(e.target.value);
            bubbleScaleValue.textContent = bubbleScale.toFixed(1);
            updateAllBubblePositions();
        });
        
        bubbleVerticalSlider.addEventListener('input', (e) => {
            bubbleVerticalOffset = parseInt(e.target.value);
            bubbleVerticalValue.textContent = bubbleVerticalOffset.toString();
            updateAllBubblePositions();
        });
        
        bubbleHorizontalSlider.addEventListener('input', (e) => {
            bubbleHorizontalOffset = parseInt(e.target.value);
            bubbleHorizontalValue.textContent = bubbleHorizontalOffset.toString();
            updateAllBubblePositions();
        });
        
        // åˆ›å»ºå³ä¾§æ—¶é—´æ˜¾ç¤ºå®¹å™¨
        const rightInfoContainer = document.createElement('div');
        rightInfoContainer.style.display = 'flex';
        rightInfoContainer.style.alignItems = 'center';
        rightInfoContainer.style.marginLeft = 'auto'; // æ¨åˆ°å³è¾¹
        uiBottomPanel.appendChild(rightInfoContainer);
        
        // åˆ›å»ºæ¸¸æˆæ§åˆ¶æŒ‰é’®
        const buttonStyles = {
            marginRight: '5px',
            padding: '5px 10px',
            borderRadius: '4px',
            fontSize: '14px',
            fontWeight: 'bold',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'é»‘ä½“, sans-serif',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 2px 3px rgba(0,0,0,0.2)',
            transition: 'all 0.2s ease',
            minWidth: '80px',
            height: '32px',
        };
        
        // åˆ›å»º"è¿è¡Œ"æŒ‰é’®
        buttonPlay = document.createElement('button');
        buttonPlay.textContent = "â–?è¿è¡Œ";
        Object.assign(buttonPlay.style, buttonStyles);
        buttonPlay.style.backgroundColor = '#2ecc71';
        buttonPlay.style.color = 'white';
        leftButtonsContainer.appendChild(buttonPlay);
        
        // åˆ›å»º"æš‚åœ"æŒ‰é’®
        buttonPause = document.createElement('button');
        buttonPause.textContent = "â?æš‚åœ";
        Object.assign(buttonPause.style, buttonStyles);
        buttonPause.style.backgroundColor = '#f39c12';
        buttonPause.style.color = 'white';
        leftButtonsContainer.appendChild(buttonPause);
        
        // åˆ›å»º"æ˜¾ç¤ºå¯¹è¯"æŒ‰é’®
        buttonShowConversation = document.createElement('button');
        buttonShowConversation.textContent = "ğŸ’¬ æ˜¾ç¤ºå¯¹è¯";
        Object.assign(buttonShowConversation.style, buttonStyles);
        buttonShowConversation.style.backgroundColor = '#3498db';
        buttonShowConversation.style.color = 'white';
        buttonShowConversation.style.display = 'flex'; // é»˜è®¤æ˜¾ç¤ºï¼Œå› ä¸ºå¯¹è¯é¢æ¿é»˜è®¤éšè—?        leftButtonsContainer.appendChild(buttonShowConversation);
        
        // åˆ›å»º"éšè—å¯¹è¯"æŒ‰é’®
        buttonHideConversation = document.createElement('button');
        buttonHideConversation.textContent = "ğŸš« éšè—å¯¹è¯";
        Object.assign(buttonHideConversation.style, buttonStyles);
        buttonHideConversation.style.backgroundColor = '#9b59b6';
        buttonHideConversation.style.color = 'white';
        buttonHideConversation.style.display = 'none'; // é»˜è®¤éšè—ï¼Œå› ä¸ºå¯¹è¯é¢æ¿é»˜è®¤éšè—?        leftButtonsContainer.appendChild(buttonHideConversation);
        
        // åˆ›å»º"æ˜¾ç¤ºç¢°æ’æ¡?æŒ‰é’®
        buttonShowCollision = document.createElement('button');
        buttonShowCollision.textContent = "â¬?æ˜¾ç¤ºç¢°æ’æ¡?;
        Object.assign(buttonShowCollision.style, buttonStyles);
        buttonShowCollision.style.backgroundColor = '#e74c3c';
        buttonShowCollision.style.color = 'white';
        leftButtonsContainer.appendChild(buttonShowCollision);
        
        // åˆ›å»º"éšè—ç¢°æ’æ¡?æŒ‰é’®
        buttonHideCollision = document.createElement('button');
        buttonHideCollision.textContent = "â¬?éšè—ç¢°æ’æ¡?;
        Object.assign(buttonHideCollision.style, buttonStyles);
        buttonHideCollision.style.backgroundColor = '#e67e22';
        buttonHideCollision.style.color = 'white';
        buttonHideCollision.style.display = 'none'; // é»˜è®¤éšè—
        leftButtonsContainer.appendChild(buttonHideCollision);
        
        // åˆ›å»º"æ¸…é™¤å¯¹è¯"æŒ‰é’®
        buttonClearConversation = document.createElement('button');
        buttonClearConversation.textContent = "ğŸ—‘ï¸?æ¸…é™¤å¯¹è¯";
        Object.assign(buttonClearConversation.style, buttonStyles);
        buttonClearConversation.style.backgroundColor = '#e74c3c';
        buttonClearConversation.style.color = 'white';
        leftButtonsContainer.appendChild(buttonClearConversation);
        
        // æ·»åŠ ç¼©æ”¾æ»‘å—æ§åˆ¶
        const zoomControlContainer = document.createElement('div');
        zoomControlContainer.style.display = 'flex';
        zoomControlContainer.style.alignItems = 'center';
        zoomControlContainer.style.gap = '5px';
        
        // ç¼©æ”¾æ ‡ç­¾
        const zoomLabel = document.createElement('span');
        zoomLabel.textContent = 'ğŸ” ç¼©æ”¾:';
        zoomLabel.style.color = 'white';
        zoomLabel.style.fontSize = '14px';
        zoomControlContainer.appendChild(zoomLabel);
        
        // ç¼©æ”¾æ»‘å—
        const zoomSlider = document.createElement('input');
        zoomSlider.type = 'range';
        zoomSlider.min = '0.2';
        zoomSlider.max = '2.0';
        zoomSlider.step = '0.1';
        zoomSlider.value = zoom.toString();
        zoomSlider.style.width = '120px';
        zoomSlider.style.height = '6px';
        zoomSlider.style.appearance = 'none';
        zoomSlider.style.webkitAppearance = 'none';
        zoomSlider.style.backgroundColor = '#555';
        zoomSlider.style.borderRadius = '3px';
        zoomSlider.style.outline = 'none';
        zoomSlider.style.cursor = 'pointer';
        
        // æ·»åŠ è·¨æµè§ˆå™¨æ»‘å—æ ·å¼
        zoomSlider.style.setProperty('-webkit-appearance', 'none');
        
        // åˆ›å»ºå¹¶æ·»åŠ æ»‘å—æ ·å¼?        const sliderStyle = document.createElement('style');
        sliderStyle.textContent = `
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #3498db;
                cursor: pointer;
                border: 2px solid white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            
            input[type=range]::-moz-range-thumb {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #3498db;
                cursor: pointer;
                border: 2px solid white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            
            input[type=range]::-ms-thumb {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #3498db;
                cursor: pointer;
                border: 2px solid white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            
            input[type=range]:hover::-webkit-slider-thumb {
                background: #2980b9;
            }
            
            input[type=range]:hover::-moz-range-thumb {
                background: #2980b9;
            }
            
            input[type=range]:hover::-ms-thumb {
                background: #2980b9;
            }
        `;
        document.head.appendChild(sliderStyle);
        
        // æ˜¾ç¤ºå½“å‰ç¼©æ”¾å€?        const zoomValue = document.createElement('span');
        zoomValue.textContent = zoom.toFixed(1) + 'x';
        zoomValue.style.color = 'white';
        zoomValue.style.fontSize = '14px';
        zoomValue.style.minWidth = '30px';
        
        // æ·»åŠ æ»‘å—äº‹ä»¶
        zoomSlider.addEventListener('input', () => {
            const currentZoom = parseFloat(zoomSlider.value);
            zoomValue.textContent = currentZoom.toFixed(1) + 'x';
            applyHighQualityZoom(currentZoom);
        });
        
        zoomControlContainer.appendChild(zoomSlider);
        zoomControlContainer.appendChild(zoomValue);
        centerControlsContainer.appendChild(zoomControlContainer);
        
        // æ·»åŠ ç”»é¢æ¯”ä¾‹æ§åˆ¶
        const aspectControlContainer = document.createElement('div');
        aspectControlContainer.style.display = 'flex';
        aspectControlContainer.style.alignItems = 'center';
        aspectControlContainer.style.gap = '5px';
        
        // æ¯”ä¾‹æ ‡ç­¾
        const aspectLabel = document.createElement('span');
        aspectLabel.textContent = 'ğŸ“ æ¯”ä¾‹:';
        aspectLabel.style.color = 'white';
        aspectLabel.style.fontSize = '14px';
        aspectControlContainer.appendChild(aspectLabel);
        
        // æŒ‰é’®æ ·å¼
        const aspectBtnStyle = {
            padding: '2px 6px',
            fontSize: '12px',
            background: 'rgba(52, 152, 219, 0.8)',
            color: 'white',
            border: '1px solid #2980b9',
            borderRadius: '3px',
            cursor: 'pointer',
            marginRight: '3px'
        };
        
        // åˆ›å»ºæ¯”ä¾‹æŒ‰é’®
        const aspectRatios = [
            { name: '16:9', value: 16/9 },
            { name: '4:3', value: 4/3 },
            { name: 'å…¨å±', value: 'fullscreen' }
        ];
        
        aspectRatios.forEach(ratio => {
            const btn = document.createElement('button');
            btn.textContent = ratio.name;
            Object.assign(btn.style, aspectBtnStyle);
            
            btn.addEventListener('click', () => {
                adjustGameAspectRatio(ratio.value);
            });
            
            aspectControlContainer.appendChild(btn);
        });
        
        // è‡ªå®šä¹‰æ¯”ä¾‹è¾“å…¥æ¡†
        const customAspectInput = document.createElement('input');
        customAspectInput.type = 'text';
        customAspectInput.placeholder = 'å®?é«?;
        customAspectInput.style.width = '45px';
        customAspectInput.style.height = '20px';
        customAspectInput.style.fontSize = '12px';
        customAspectInput.style.padding = '2px 4px';
        customAspectInput.style.border = '1px solid #3498db';
        customAspectInput.style.borderRadius = '3px';
        customAspectInput.style.backgroundColor = 'rgba(255,255,255,0.8)';
        aspectControlContainer.appendChild(customAspectInput);
        
        // åº”ç”¨æŒ‰é’®
        const applyAspectBtn = document.createElement('button');
        applyAspectBtn.textContent = 'åº”ç”¨';
        Object.assign(applyAspectBtn.style, aspectBtnStyle);
        applyAspectBtn.style.background = '#27ae60';
        
        applyAspectBtn.addEventListener('click', () => {
            const input = customAspectInput.value;
            const parts = input.split(':');
            if (parts.length === 2) {
                const width = parseFloat(parts[0]);
                const height = parseFloat(parts[1]);
                if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
                    adjustGameAspectRatio(width / height);
                }
            }
        });
        
        aspectControlContainer.appendChild(applyAspectBtn);
        centerControlsContainer.appendChild(aspectControlContainer);
        
        // åˆ›å»ºæ—¶é—´æ–‡æœ¬
        currentTimeText = document.createElement('div');
        currentTimeText.style.fontSize = '16px';
        currentTimeText.style.fontWeight = 'bold';
        currentTimeText.style.color = 'white';
        currentTimeText.style.display = 'flex';
        currentTimeText.style.alignItems = 'center';
        currentTimeText.innerHTML = 'ğŸ•’ <span id="time-display"></span>';
        rightInfoContainer.appendChild(currentTimeText);
        
        // å¯¹è¯æ–‡æœ¬å®¹å™¨
        conversationText = uiDialogPanel;
        
        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        buttonPlay.addEventListener('click', () => {
            if (finished) return;
            buttonPlay.style.backgroundColor = '#27ae60'; // æ·±ç»¿è‰?            buttonPlay.style.boxShadow = '0 0 10px #2ecc71'; // å‘å…‰æ•ˆæœ
            buttonPlay.textContent = "â–?[è¿è¡Œ]";
            buttonPause.textContent = "â?æš‚åœ";
            buttonPause.style.backgroundColor = '#f39c12'; // æ¢å¤é¢œè‰²
            buttonPause.style.boxShadow = 'none';
            paused = false;
        });

        buttonPause.addEventListener('click', () => {
            if (finished) return;
            buttonPlay.style.backgroundColor = '#2ecc71'; // æ¢å¤é¢œè‰²
            buttonPlay.style.boxShadow = 'none';
            buttonPlay.textContent = "â–?è¿è¡Œ";
            buttonPause.textContent = "â?[æš‚åœ]";
            buttonPause.style.backgroundColor = '#d35400'; // æ·±æ©™è‰?            buttonPause.style.boxShadow = '0 0 10px #f39c12'; // å‘å…‰æ•ˆæœ
            paused = true;
        });

        buttonShowConversation.addEventListener('click', () => {
            buttonShowConversation.style.display = 'none';
            buttonHideConversation.style.display = 'flex';
            
            // æ˜¾ç¤ºå¯¹è¯åŒºåŸŸ
            const uiDialogPanel = document.getElementById('ui-dialog-panel');
            if (uiDialogPanel) {
                uiDialogPanel.style.display = 'block';
                // ç«‹å³æ›´æ–°å¯¹è¯å†…å®¹
                updateDialogues();
                
                // æ»šåŠ¨åˆ°å¯¹è¯åŒºåŸ?                uiDialogPanel.scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        buttonHideConversation.addEventListener('click', () => {
            buttonShowConversation.style.display = 'flex';
            buttonHideConversation.style.display = 'none';
            
            // éšè—å¯¹è¯åŒºåŸŸ
            const uiDialogPanel = document.getElementById('ui-dialog-panel');
            if (uiDialogPanel) {
                uiDialogPanel.style.display = 'none';
            }
        });
        
        // è®¾ç½®ç¢°æ’æ¡†æ˜¾ç¤?éšè—äº‹ä»¶
        buttonShowCollision.addEventListener('click', () => {
            buttonShowCollision.style.display = 'none';
            buttonHideCollision.style.display = 'flex';
            showAllCollisionBoxes(true);
        });
        
        buttonHideCollision.addEventListener('click', () => {
            buttonShowCollision.style.display = 'flex';
            buttonHideCollision.style.display = 'none';
            showAllCollisionBoxes(false);
        });
        
        // è®¾ç½®æ¸…é™¤å¯¹è¯äº‹ä»¶
        buttonClearConversation.addEventListener('click', () => {
            // ç¡®è®¤å¯¹è¯æ¡?            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€?)) {
                // æ¸…ç©ºå¯¹è¯å†å²
                dialogHistory = {};
                lastSpeaker = null;
                
                // æ¸…ç©ºå¯¹è¯å†…å®¹
                const dialogContent = document.getElementById('conversation-content');
                const defaultDialogContent = document.getElementById('default-dialog-content');
                
                if (dialogContent && defaultDialogContent) {
                    dialogContent.innerHTML = '';
                    dialogContent.style.display = 'none';
                    defaultDialogContent.style.display = 'block';
                }
                
                // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                showSystemMessage('å¯¹è¯è®°å½•å·²æ¸…é™?);
            }
        });
        
        // åˆå§‹åŒ–è§’è‰²å›¾æ ‡ç‚¹å‡»äº‹ä»?        setupCharacterIconClickEvents();
        
        // é»˜è®¤éšè—ç¢°æ’æ¡?        buttonShowCollision.style.display = 'flex';
        buttonHideCollision.style.display = 'none';
        
        // æ˜¾ç¤ºåˆå§‹æ—¶é—´
        updateTimeDisplay();
        
        console.log("UIåˆ›å»ºå®Œæˆ");
    }
    
    // æ›´æ–°UIä½ç½®ï¼ˆå“åº”çª—å£å¤§å°å˜åŒ–ï¼‰
    function updateUIPositions() {
        const uiBottomPanel = document.getElementById('ui-bottom-panel');
        if (!uiBottomPanel) return;
        
        // æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´æŒ‰é’®æ ·å¼
        const isMobile = window.innerWidth < 768;
        const buttons = uiBottomPanel.querySelectorAll('button');
        
        buttons.forEach(button => {
            if (button) {
                Object.assign(button.style, {
                    minWidth: isMobile ? '60px' : '80px',
                    fontSize: isMobile ? '12px' : '14px',
                    padding: isMobile ? '3px 8px' : '5px 10px'
                });
            }
        });
    }
    
    // è§’è‰²å›¾æ ‡ç‚¹å‡»äº‹ä»¶è®¾ç½®
    function setupCharacterIconClickEvents() {
        for (let p in persona_names) {
            const iconTrigger = document.getElementById(`on_screen_det_trigger-${p}`);
            if (iconTrigger) {
                iconTrigger.addEventListener('click', function() {
                    // ç‰¹æ®Šå¤„ç†"å®éªŒè€?è§’è‰²ï¼ˆå¯èƒ½æ˜¯ç©å®¶è§’è‰²ï¼?                    if (p === 'å®éªŒè€?) {
                        // å¦‚æœå®éªŒè€…æ˜¯ç©å®¶è§’è‰²ï¼Œåˆ™åˆ‡æ¢åˆ°ç©å®¶ä½ç½?                        if (player) {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»é”å®šäº†è¯¥è§’è‰?                            if (currentLockedCharacter === player && isCharacterLocked) {
                                // å¦‚æœå·²é”å®šï¼Œåˆ™è§£é™¤é”å®?                                unlockCharacter();
                                console.log("è§£é™¤ç©å®¶é”å®š");
                                return;
                            }
                            
                            // é”å®šç©å®¶
                            lockCharacter(player, 'å®éªŒè€?);
                            console.log(`è§†å›¾å·²é”å®šåˆ°ç©å®¶è§’è‰², ä½ç½®: (${player.x}, ${player.y})`);
                            return;
                        }
                    }
                    
                    // æŸ¥æ‰¾å¯¹åº”NPCå¯¹è±¡
                    const npc = personas[p];
                    if (npc) {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»é”å®šäº†è¯¥NPC
                        if (currentLockedCharacter === npc && isCharacterLocked) {
                            // å¦‚æœå·²é”å®šï¼Œåˆ™è§£é™¤é”å®?                            unlockCharacter();
                            console.log(`è§£é™¤è§’è‰²é”å®š: ${p}`);
                            return;
                        }
                        
                        // é”å®šè¯¥NPC
                        lockCharacter(npc, p);
                        console.log(`è§†å›¾å·²é”å®šåˆ°è§’è‰²: ${p}, ä½ç½®: (${npc.x}, ${npc.y})`);
                    } else {
                        console.warn(`æ‰¾ä¸åˆ°è§’è‰? ${p}`);
                    }
                });
                console.log(`å·²ä¸ºè§’è‰² ${p} æ·»åŠ ç‚¹å‡»äº‹ä»¶`);
            }
        }
    }
    
    // é”å®šè§’è‰²
    function lockCharacter(character, characterName) {
        // è®¾ç½®é”å®šçŠ¶æ€?        currentLockedCharacter = character;
        isCharacterLocked = true;
        
        // ç§»åŠ¨è§†å›¾åˆ°è¯¥è§’è‰²ä½ç½®
        centerViewOnCharacter(character);
        
        // å¦‚æœæ˜¯ç©å®¶è§’è‰?        if (characterName === 'å®éªŒè€? && character === player) {
            highlightPlayer();
        } else {
            // å¦‚æœæ˜¯NPC
            highlightCharacter(characterName);
        }
        
        // åœ¨UIä¸­æ˜¾ç¤ºå½“å‰è·Ÿéšçš„è§’è‰²
        updateCurrentCharacterDisplay(characterName + " (å·²é”å®?");
    }
    
    // è§£é™¤é”å®š
    function unlockCharacter() {
        isCharacterLocked = false;
        
        // ç§»é™¤å½“å‰é”å®šè§’è‰²çš„é«˜äº?        if (currentLockedCharacter === player) {
            if (player.highlightEffect) {
                player.removeChild(player.highlightEffect);
                player.highlightEffect = null;
            }
        } else {
            // å¯¹äºNPCï¼Œç§»é™¤æ‰€æœ‰é«˜äº?            for (let name in personas) {
                const npc = personas[name];
                if (npc && npc.highlightEffect) {
                    npc.removeChild(npc.highlightEffect);
                    npc.highlightEffect = null;
                }
            }
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        let currentCharacterDisplay = document.getElementById('current-character-display');
        if (currentCharacterDisplay) {
            currentCharacterDisplay.textContent = "æ— é”å®šè§’è‰?;
            currentCharacterDisplay.style.backgroundColor = '#e74c3c'; // çº¢è‰²
            setTimeout(() => {
                currentCharacterDisplay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            }, 500);
        }
        
        currentLockedCharacter = null;
    }
    
    // å°†è§†å›¾ä¸­å¿ƒç§»åŠ¨åˆ°æŒ‡å®šè§’è‰²ä½ç½®
    function centerViewOnCharacter(character) {
        // é€šè¿‡è®¾ç½®stageçš„pivotæ¥ç§»åŠ¨è§†å›?        app.stage.pivot.x = character.x;
        app.stage.pivot.y = character.y;
    }
    
    // æ›´æ–°å½“å‰è·Ÿéšçš„è§’è‰²æ˜¾ç¤?    function updateCurrentCharacterDisplay(characterName) {
        // è·å–åº•éƒ¨é¢æ¿
        const uiBottomPanel = document.getElementById('ui-bottom-panel');
        if (!uiBottomPanel) return;
        
        // æŸ¥æ‰¾æˆ–åˆ›å»ºå½“å‰è§’è‰²æ˜¾ç¤ºå…ƒç´?        let currentCharacterDisplay = document.getElementById('current-character-display');
        if (!currentCharacterDisplay) {
            currentCharacterDisplay = document.createElement('div');
            currentCharacterDisplay.id = 'current-character-display';
            currentCharacterDisplay.style.marginLeft = '20px';
            currentCharacterDisplay.style.fontSize = '18px';
            currentCharacterDisplay.style.fontWeight = 'bold';
            currentCharacterDisplay.style.color = 'white';
            currentCharacterDisplay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            currentCharacterDisplay.style.padding = '5px 10px';
            currentCharacterDisplay.style.borderRadius = '5px';
            uiBottomPanel.appendChild(currentCharacterDisplay);
        }
        
        // æ›´æ–°å½“å‰è§’è‰²åç§°
        currentCharacterDisplay.textContent = `å½“å‰è·Ÿéš: ${characterName}`;
        
        // æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„é«˜äº®æ•ˆæœ
        currentCharacterDisplay.style.backgroundColor = '#3498db';
        setTimeout(() => {
            currentCharacterDisplay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        }, 500);
    }
    
    // é«˜äº®æ˜¾ç¤ºç©å®¶
    function highlightPlayer() {
        // é‡ç½®æ‰€æœ‰NPCé«˜äº®
        for (let p in personas) {
            const npc = personas[p];
            if (npc && npc.highlightEffect) {
                npc.removeChild(npc.highlightEffect);
                npc.highlightEffect = null;
            }
        }
        
        // ç§»é™¤ç©å®¶å·²æœ‰çš„é«˜äº®æ•ˆæ?        if (player.highlightEffect) {
            player.removeChild(player.highlightEffect);
            player.highlightEffect = null;
        }
        
        // ç§»é™¤ç©å®¶é«˜äº®åœˆæ•ˆæ?        // åŸä»£ç ï¼š
        // // åˆ›å»ºé«˜äº®ç‰¹æ•ˆ
        // const highlight = new PIXI.Graphics();
        // highlight.lineStyle(3, 0x00ffff, 0.8); // ç©å®¶ä½¿ç”¨é’è‰²é«˜äº®
        // highlight.drawCircle(0, 0, 25);
        // 
        // // æ·»åŠ é«˜äº®åŠ¨ç”»
        // let time = 0;
        // highlight.ticker = new PIXI.Ticker();
        // highlight.ticker.add(() => {
        //     time += 0.05;
        //     highlight.scale.set(1 + Math.sin(time) * 0.1);
        // });
        // highlight.ticker.start();
        // 
        // player.highlightEffect = highlight;
        // player.addChild(highlight);
        
        // ä¿ç•™ç©å®¶é€‰ä¸­çŠ¶æ€ï¼Œä½†ä¸æ·»åŠ è§†è§‰æ•ˆæœ
        player.highlightEffect = null;
    }
    
    // é«˜äº®æ˜¾ç¤ºè§’è‰²
    function highlightCharacter(characterName) {
        // é‡ç½®æ‰€æœ‰NPCé«˜äº®
        for (let p in personas) {
            const npc = personas[p];
            if (npc && npc.highlightEffect) {
                npc.removeChild(npc.highlightEffect);
                npc.highlightEffect = null;
            }
        }
        
        // æ¸…é™¤ç©å®¶é«˜äº®(å¦‚æœå­˜åœ¨)
        if (player && player.highlightEffect) {
            player.removeChild(player.highlightEffect);
            player.highlightEffect = null;
        }
        
        // é«˜äº®å½“å‰é€‰ä¸­çš„NPC
        const selectedNpc = personas[characterName];
        if (selectedNpc) {
            // ä¿ç•™å½“å‰é€‰ä¸­çš„NPCçŠ¶æ€ï¼Œä½†ä¸æ·»åŠ è§†è§‰æ•ˆæœ
            selectedNpc.highlightEffect = null;
        }
    }
    
    // æ˜¾ç¤ºæˆ–éšè—æ‰€æœ‰ç¢°æ’æ¡†
    function showAllCollisionBoxes(show) {
        // æ˜¾ç¤º/éšè—ç©å®¶ç¢°æ’æ¡?        if (player && player.collisionBox) {
            player.collisionBox.visible = show;
        }
        
        // æ˜¾ç¤º/éšè—æ‰€æœ‰NPCçš„ç¢°æ’æ¡†
        for (let npcName in personas) {
            const npc = personas[npcName];
            if (npc && npc.collisionBox) {
                npc.collisionBox.visible = show;
            }
        }
        
        console.log(`ç¢°æ’æ¡†æ˜¾ç¤ºçŠ¶æ€? ${show}`);
    }

    // é”®ç›˜æ§åˆ¶
    function setupKeyboardControls() {
        window.addEventListener('keydown', (e) => {
            keyboard[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            keyboard[e.key] = false;
        });
    }

    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateTimeDisplay() {
        const timeDisplay = document.getElementById('time-display');
        if (!timeDisplay) return;
        
        timeDisplay.textContent = start_datetime.toLocaleTimeString("zh-CN", datetime_options);
        
        // æ›´æ–°æµ®åŠ¨æ—¶é’Ÿ
        if (!floatingClockWindow) return;
        
        const clockDate = floatingClockWindow.querySelector('.clock-date');
        const clockDisplay = floatingClockWindow.querySelector('.clock-display');
        if (!clockDate || !clockDisplay) return;
        
        // æ ¼å¼åŒ–æ—¥æœŸå’Œæ—¶é—´
        const date = start_datetime;
        const dateStr = `${date.getFullYear()}å¹?{(date.getMonth() + 1).toString().padStart(2, '0')}æœ?{date.getDate().toString().padStart(2, '0')}æ—?${['æ˜ŸæœŸæ—?, 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäº?, 'æ˜ŸæœŸä¸?, 'æ˜ŸæœŸå›?, 'æ˜ŸæœŸäº?, 'æ˜ŸæœŸå…?][date.getDay()]}`;
        const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
        
        clockDate.textContent = dateStr;
        clockDisplay.textContent = timeStr;
    }
    
    // æ·»åŠ æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºæŒ‰é¡ºåºæ˜¾ç¤ºæ¶ˆæ¯
    let messageQueue = [];
    let isProcessingQueue = false;
    
    // é€æ¡æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•?    function processMessageQueue() {
        if (messageQueue.length === 0) {
            isProcessingQueue = false;
            return;
        }
        
        isProcessingQueue = true;
        const messageData = messageQueue.shift();
        
        // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¶ˆæ?        createChatMessage(
            messageData.container, 
            messageData.personaName, 
            messageData.text, 
            messageData.emoji, 
            messageData.timestamp, 
            messageData.autoRemove
        );
        
        // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ˜¾ç¤ºä¸‹ä¸€æ¡æ¶ˆæ?        setTimeout(() => {
            processMessageQueue();
        }, 2000); // æ¯æ¡æ¶ˆæ¯æ˜¾ç¤ºé—´éš”2000æ¯«ç§’ï¼Œä½¿æ˜¾ç¤ºæ›´æ…¢
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°é˜Ÿåˆ?    function addMessageToQueue(container, personaName, text, emoji = "", timestamp = null, autoRemove = false) {
        messageQueue.push({
            container,
            personaName,
            text,
            emoji,
            timestamp,
            autoRemove
        });
        
        // å¦‚æœé˜Ÿåˆ—æœªåœ¨å¤„ç†ä¸­ï¼Œå¼€å§‹å¤„ç?        if (!isProcessingQueue) {
            processMessageQueue();
        }
    }
    
    // æ›´æ–°å¯¹è¯
    function updateDialogues() {
        // è·å–å½“å‰æ—¶é—´ç‚¹çš„å¯¹è¯
        const curr_datetime = new Date(start_datetime.getTime());
        const formatNum = num => num.toString().padStart(2, "0");
        
        const timeKey = `${curr_datetime.getFullYear()}${formatNum(curr_datetime.getMonth() + 1)}${formatNum(curr_datetime.getDate())}-${formatNum(curr_datetime.getHours())}:${formatNum(curr_datetime.getMinutes())}`;
        
        // ç”Ÿæˆå‰å2åˆ†é’Ÿçš„æ—¶é—´ç‚¹
        const timeKeys = [-2, -1, 0, 1, 2].map(offset => {
            const date = new Date(curr_datetime.getTime() + offset * 60000);
            return `${date.getFullYear()}${formatNum(date.getMonth() + 1)}${formatNum(date.getDate())}-${formatNum(date.getHours())}:${formatNum(date.getMinutes())}`;
        });
        
        // è·å–å¯¹è¯å†…å®¹å…ƒç´ 
        const dialogContent = document.getElementById('conversation-content');
        const defaultDialogContent = document.getElementById('default-dialog-content');
        if (!dialogContent || !defaultDialogContent) return;
        
        // ç¡®ä¿å¯¹è¯é¢æ¿å¯è§æ€?        const uiDialogPanel = document.getElementById('ui-dialog-panel');
        if (uiDialogPanel && buttonHideConversation?.style.display === 'flex') {
            uiDialogPanel.style.display = 'block';
        }
        
        // è®°å½•æ»šåŠ¨ä½ç½®
        const wasAtBottom = (dialogContent.scrollHeight - dialogContent.scrollTop) <= (dialogContent.clientHeight + 50);
        
        // å¤„ç†æ–°å¯¹è¯?        let hasNewConversation = false;
        const newMessages = [];
        
        // æ£€æŸ¥æ—¶é—´ç‚¹æ˜¯å¦æœ‰å¯¹è¯?        for (const timeKey of timeKeys) {
            const conversation = all_movement.conversation?.[timeKey];
            if (!conversation || conversation === "" || dialogHistory[timeKey]) continue;
            
            // æ£€æŸ¥å¯¹è¯å‚ä¸è€…çŠ¶æ€?            const shouldShowDialogue = !Object.entries(personas).some(([name, persona]) => {
                const status = getPersonaStatus(name);
                return status?.action?.includes("ç¡è§‰") && 
                       (typeof conversation === 'string' ? 
                           conversation.includes(name + "ï¼?) : 
                           conversation[name]);
            });
            
            if (!shouldShowDialogue) continue;
            
            // åˆ›å»ºå¯¹è¯è®°å½•
            dialogHistory[timeKey] = {
                conversation: typeof conversation === 'string' ? 
                    parseDialogString(conversation) :
                    Object.entries(conversation)
                        .filter(([key]) => key !== 'emoji')
                        .map(([name, msg]) => ({
                            character: name,
                            message: msg,
                            emoji: conversation.emoji || ""
                        })),
                timestamp: curr_datetime.toLocaleTimeString(),
                date: `${curr_datetime.getFullYear()}-${formatNum(curr_datetime.getMonth() + 1)}-${formatNum(curr_datetime.getDate())}`,
                datetime: curr_datetime,
                displayed: false
            };
            
            // æ”¶é›†æ–°æ¶ˆæ?            newMessages.push(...dialogHistory[timeKey].conversation.map(entry => ({
                conversationKey: timeKey,
                personaName: entry.character,
                message: entry.message,
                emoji: entry.emoji || "",
                timestamp: curr_datetime
            })));
            
            // æ›´æ–°NPCå¤´é¡¶æ°”æ³¡
            updateNPCBubbles(dialogHistory[timeKey].conversation);
            hasNewConversation = true;
        }
        
        // æ˜¾ç¤ºå¯¹è¯å†…å®¹
        if (Object.keys(dialogHistory).length > 0) {
            dialogContent.style.display = 'flex';
            defaultDialogContent.style.display = 'none';
            
            // åˆå§‹åŒ–æ—¥æœŸåˆ†éš”çº¿
            if (dialogContent.children.length === 0) {
                const dates = [...new Set(Object.values(dialogHistory).map(record => record.date))].sort();
                dates.forEach(date => {
                    const separator = createDateSeparator(date);
                    dialogContent.appendChild(separator);
                });
            }
            
            // æ·»åŠ æ–°æ¶ˆæ¯åˆ°é˜Ÿåˆ—
            if (newMessages.length > 0) {
                newMessages.forEach(msg => {
                    addMessageToQueue(
                        dialogContent,
                        msg.personaName,
                        msg.message,
                        msg.emoji,
                        msg.timestamp
                    );
                });
            }
        } else {
            dialogContent.style.display = 'none';
            defaultDialogContent.style.display = 'block';
        }
    }
    
    // åˆ›å»ºæ—¥æœŸåˆ†éš”çº?    function createDateSeparator(date) {
        const separator = document.createElement('div');
        separator.className = 'date-separator';
        Object.assign(separator.style, {
            textAlign: 'center',
            margin: '20px 0',
            color: '#999',
            fontSize: '12px',
            position: 'relative'
        });
        
        const line = document.createElement('div');
        Object.assign(line.style, {
            position: 'absolute',
            top: '50%',
            left: '0',
            right: '0',
            height: '1px',
            backgroundColor: '#ddd',
            zIndex: '1'
        });
        
        const text = document.createElement('span');
        text.textContent = formatDate(date);
        Object.assign(text.style, {
            backgroundColor: '#f2f2f2',
            padding: '0 10px',
            position: 'relative',
            zIndex: '2'
        });
        
        separator.appendChild(line);
        separator.appendChild(text);
        return separator;
    }
    
    // è§£æå¯¹è¯å­—ç¬¦ä¸²ï¼Œè¯†åˆ«æ ¼å¼ä¸?\n\nè§’è‰²åï¼šå¯¹è¯å†…å®¹"çš„æ–‡æœ?    function parseDialogString(dialogText) {
        if (!dialogText || typeof dialogText !== 'string') {
            return [];
        }
        
        console.log("è§£æåŸå§‹å¯¹è¯æ–‡æœ¬...");
        
        // å°è¯•æå–åœ°ç‚¹ä¿¡æ¯
        let location = "";
        const locationMatch = dialogText.match(/åœ°ç‚¹ï¼?[^\n]+)/);
        if (locationMatch) {
            location = locationMatch[1];
            console.log(`æå–åˆ°åœ°ç‚¹ä¿¡æ? ${location}`);
            // ä»å¯¹è¯æ–‡æœ¬ä¸­ç§»é™¤åœ°ç‚¹ä¿¡æ¯ï¼Œä»¥å…è¢«å½“ä½œå¯¹è¯å†…å®¹
            dialogText = dialogText.replace(/åœ°ç‚¹ï¼?[^\n]+)/, "");
        }
        
        // åˆ†å‰²å¯¹è¯å†…å®¹ - æ”¹è¿›çš„è§£æé€»è¾‘
        // å…ˆæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆè¡?        const lines = dialogText.split('\n').filter(line => line.trim() !== '');
        const dialogEntries = [];
        
        // éå†æ¯ä¸€è¡Œï¼Œæå–è§’è‰²åå’Œå¯¹è¯å†…å®¹
        lines.forEach(line => {
            // ä½¿ç”¨å†’å·æ¥åˆ†å‰²è§’è‰²åå’Œå¯¹è¯å†…å®?            const colonIndex = line.indexOf('ï¼?);
            if (colonIndex > 0) {
                const character = line.substring(0, colonIndex).trim();
                const message = line.substring(colonIndex + 1).trim();
                
                if (character && message) {
                    console.log(`è§£æåˆ°å¯¹è¯? è§’è‰²=${character}, æ¶ˆæ¯=${message.substring(0, 30)}...`);
                    
                    // æ·»åŠ åˆ°ç»“æœæ•°ç»?                    dialogEntries.push({
                        character: character,
                        message: message,
                        emoji: "" // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¡¨æƒ…é€»è¾‘
                    });
                }
            } else if (line.trim() !== '') {
                // å¯¹äºæ²¡æœ‰å†’å·çš„è¡Œï¼Œå°è¯•ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æˆ–è€…è¿½åŠ åˆ°ä¸Šä¸€æ¡æ¶ˆæ?                if (dialogEntries.length > 0 && !line.match(/^[^\s:ï¼š]{1,20}[:ï¼š]/)) {
                    // è¿½åŠ åˆ°ä¸Šä¸€æ¡æ¶ˆæ?                    const lastEntry = dialogEntries[dialogEntries.length - 1];
                    lastEntry.message += '\n' + line.trim();
                    console.log(`è¿½åŠ åˆ°ä¸Šä¸€æ¡æ¶ˆæ? ${lastEntry.message.substring(0, 30)}...`);
                } else {
                    // ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯
                    console.log(`åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯: ${line.substring(0, 30)}...`);
                    dialogEntries.push({
                        character: "ç³»ç»Ÿ",
                        message: line.trim(),
                        emoji: "â„¹ï¸"
                    });
                }
            }
        });
        
        // å¦‚æœæå–åˆ°äº†åœ°ç‚¹ä¿¡æ¯ä¸”æœ‰å¯¹è¯æ¡ç›®ï¼Œæ·»åŠ åœ°ç‚¹ä¿¡æ¯ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆä¸è‡ªåŠ¨æ¶ˆå¤±ï¼‰
        if (location && location.trim() !== '') {
            // æ ¼å¼åŒ–åœ°ç‚¹ä¿¡æ¯å¹¶æ·»åŠ åˆ°å¯¹è¯æ¡ç›®çš„å¼€å¤?            dialogEntries.unshift({
                character: "ç³»ç»Ÿ",
                message: `å½“å‰åœ°ç‚¹: ${location}`,
                emoji: "ğŸ“"
            });
        }
        
        console.log(`è§£æå®Œæˆï¼Œå…±æå–åˆ?${dialogEntries.length} æ¡å¯¹è¯`);
        return dialogEntries;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•?    function formatDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${year}å¹?{parseInt(month)}æœ?{parseInt(day)}æ—¥`;
    }
    
    // åˆå§‹åŒ–å¯¹è¯é¢æ?    function initDialogPanel() {
        const uiDialogPanel = document.getElementById('ui-dialog-panel');
        if (uiDialogPanel) {
            // è®¾ç½®é¢æ¿æ ·å¼
            uiDialogPanel.style.maxHeight = '1200px'; // å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºæ›´å¤šå¯¹è¯è®°å½?            uiDialogPanel.style.overflowY = 'auto';
            uiDialogPanel.style.scrollBehavior = 'smooth';
            
            // è·å–å¯¹è¯å†…å®¹å…ƒç´ 
            const dialogContent = document.getElementById('conversation-content');
            if (dialogContent) {
                // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œæ£€æµ‹ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ»šåŠ?                dialogContent.addEventListener('scroll', function() {
                    // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘
                    const isNearBottom = (dialogContent.scrollHeight - dialogContent.scrollTop) <= (dialogContent.clientHeight + 50);
                    
                    // æ›´æ–°è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€?- å½“ç”¨æˆ·æ‰‹åŠ¨å‘ä¸Šæ»šåŠ¨æ—¶ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨ï¼Œæ»šåˆ°åº•éƒ¨æ—¶é‡æ–°å¯ç”¨
                    autoScrollEnabled = isNearBottom;
                    
                    // è°ƒè¯•è¾“å‡º
                    if (autoScrollEnabled !== isNearBottom) {
                        console.log(`è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€? ${autoScrollEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                    }
                });
                
                // æ·»åŠ è‡ªåŠ¨æ»šåŠ¨å¼€å…³åˆ°å¯¹è¯é¢æ¿
                addAutoScrollToggle(uiDialogPanel);
            }
            
            // å…¶ä»–æ ·å¼é€šè¿‡addWeChatStyleCSSå‡½æ•°æ·»åŠ 
            console.log("å¯¹è¯é¢æ¿åˆå§‹åŒ–å®Œæˆ?);
        }
    }
    
    // æ›´æ–°è§’è‰²ä½ç½®å’ŒåŠ¨ç”?    function updateCharacters() {
        // ç©å®¶ç§»åŠ¨å¤„ç†
        const speed = 20;
        let isMoving = false;
        let playerDirection = lastPlayerDirection;
        
        // å¤„ç†ç©å®¶ç§»åŠ¨è¾“å…¥
        if (keyboard["ArrowLeft"]) {
            player.x -= speed;
            playerDirection = 'left';
            isMoving = true;
        } else if (keyboard["ArrowRight"]) {
            player.x += speed;
            playerDirection = 'right';
            isMoving = true;
        }
        
        if (keyboard["ArrowUp"]) {
            player.y -= speed;
            if (!isMoving) playerDirection = 'up';
            isMoving = true;
        } else if (keyboard["ArrowDown"]) {
            player.y += speed;
            if (!isMoving) playerDirection = 'down';
            isMoving = true;
        }
        
        if (isMoving) {
            lastPlayerDirection = playerDirection;
            if (player) {
                app.stage.pivot.x = player.x;
                app.stage.pivot.y = player.y;
            }
        }
        
        // NPCç§»åŠ¨é€»è¾‘
        for (const curr_persona_name of Object.keys(personas)) {
            const curr_persona = personas[curr_persona_name];
            if (!curr_persona) continue;

            if (!(step in all_movement)) {
                finished = true;
                if (buttonPlay) buttonPlay.textContent = "â–?[å›æ”¾ç»“æŸ]";
                if (buttonPause) buttonPause.visible = false;
                break;
            }

            const movement_data = all_movement[step][curr_persona_name] || 
                                all_movement[step][curr_persona_name.replace("_", " ")];
            
            if (!movement_data) continue;

            // å¤„ç†ç›®æ ‡ä½ç½®è®¾ç½®å’ŒåŠ¨ä½œæ›´æ–?            if (execute_count === execute_count_max) {
                const [curr_x, curr_y] = movement_data.movement;
                movement_target[curr_persona_name] = [
                    curr_x * tile_width + tile_width / 2 - 10,
                    curr_y * tile_width + tile_width / 2
                ];

                const action = movement_data.action;
                const act = action.length > 25 ? action.substring(0, 20)+"..." : action;
                updateActionBubble(curr_persona_name, act, movement_data.emoji || "");
                
                // æ›´æ–°UIçŠ¶æ€?                try {
                    const elements = {
                        desc: document.getElementById(`agent_desc__${curr_persona_name}`),
                        action: document.getElementById(`current_action__${curr_persona_name}`),
                        address: document.getElementById(`target_address__${curr_persona_name}`)
                    };
                    
                    if (elements.desc) {
                        elements.desc.innerHTML = all_movement.description[curr_persona_name].currently;
                    }
                    if (elements.action) {
                        elements.action.innerHTML = action;
                    }
                    if (elements.address) {
                        elements.address.innerHTML = movement_data.location;
                    }
                } catch (e) {
                    console.warn("æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå¤±è´?", e);
                }
            }

            if (execute_count > 0 && movement_target[curr_persona_name]) {
                const [targetX, targetY] = movement_target[curr_persona_name];
                if (targetX === undefined || targetY === undefined) continue;

                const POSITION_THRESHOLD = 2;
                const hasReachedX = Math.abs(curr_persona.x - targetX) <= POSITION_THRESHOLD;
                const hasReachedY = Math.abs(curr_persona.y - targetY) <= POSITION_THRESHOLD;
                
                if (!hasReachedX || !hasReachedY) {
                    // æ›´æ–°ä½ç½®
                    const newX = !hasReachedX 
                        ? curr_persona.x + (curr_persona.x < targetX ? movement_speed : -movement_speed)
                        : curr_persona.x;
                        
                    const newY = !hasReachedX && hasReachedY
                        ? curr_persona.y
                        : curr_persona.y + (curr_persona.y < targetY ? movement_speed : -movement_speed);
                    
                    // æ›´æ–°æ–¹å‘
                    if (!hasReachedX) {
                        pre_anims_direction_dict[curr_persona_name] = curr_persona.x < targetX ? "r" : "l";
                    } else {
                        pre_anims_direction_dict[curr_persona_name] = curr_persona.y < targetY ? "d" : "u";
                    }
                    
                    // åº”ç”¨æ–°ä½ç½?                    curr_persona.x = newX;
                    curr_persona.y = newY;
                    
                    // æ›´æ–°æ°”æ³¡
                    const bubble = pronunciatios[curr_persona_name];
                    if (bubble?.container) {
                        updateBubblePosition(curr_persona_name);
                        bubble.container.visible = true;
                    }
                } else {
                    // å·²åˆ°è¾¾ç›®æ ‡ä½ç½?                    curr_persona.x = targetX;
                    curr_persona.y = targetY;
                }
            }
        }

        // æ›´æ–°æ‰§è¡ŒçŠ¶æ€?        if (execute_count === 0) {
            // æ›´æ–°æ‰€æœ‰NPCåˆ°ç›®æ ‡ä½ç½?            Object.entries(personas).forEach(([name, persona]) => {
                const target = movement_target[name];
                if (target?.[0] !== undefined && target?.[1] !== undefined) {
                    persona.x = target[0];
                    persona.y = target[1];
                }
            });
            
            execute_count = execute_count_max + 1;
            step += 1;
            start_datetime = new Date(start_datetime.getTime() + step_size);
            updateTimeDisplay();
        }

        execute_count -= 1;
    }

    // æ¸¸æˆä¸»å¾ªç?    function gameLoop(delta) {
        if (finished || paused) return;
        
        // æ›´æ–°è§’è‰²
        updateCharacters();
        
        // æ›´æ–°è§†å›¾è·Ÿéš
        if (isCharacterLocked && currentLockedCharacter) {
            centerViewOnCharacter(currentLockedCharacter);
        }
        
        // æ ¹æ®å½“å‰æ¸¸æˆæ—¶é—´æ›´æ–°è§’è‰²å¤´é¡¶å›¾ç‰‡
        const currentGameTime = new Date(start_datetime);
        for (const personaName in personas) {
            updateCharacterImage(personaName, currentGameTime);
        }
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šè®¡ç®—å¸§ç‡å¹¶æ ¹æ®éœ€è¦è·³è¿‡å¤æ‚æ›´æ–?        frameSkipCounter = (frameSkipCounter + 1) % (frameSkipThreshold + 1);
        const isFullFrame = frameSkipCounter === 0;
        
        // æ‰§è¡Œä¸åŒé¢‘ç‡çš„æ›´æ–?        if (isFullFrame) {
            updateDialogues();
            updateCollisionBoxes();
            updateBubbleVisibility();
            
            // ä½é¢‘ç‡æ‰§è¡ŒUIæ›´æ–°
            if (frameSkipCounter % (frameSkipThreshold * 2) === 0) {
                forceUpdateUI();
            }
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šå®šæœŸæ¸…ç†å†…å­?            const currentTime = Date.now();
            if (currentTime - lastMemoryCleanup > memoryCleanupInterval) {
                performMemoryCleanup();
                lastMemoryCleanup = currentTime;
            }
        }
        
        // æ›´æ–°æ‰€æœ‰è§’è‰²åŠ¨ç”?        updateAllCharacterAnimations();
        
        // æ¸…ç†æ ‡è®°ä¸ºè¦åˆ é™¤çš„æ°”æ³¡è®¡æ—¶å™¨
        if (bubbleTimersToRemove.length > 0) {
            bubbleTimersToRemove.forEach(timerId => {
                if (bubbleTimers[timerId]) {
                    clearTimeout(bubbleTimers[timerId]);
                    delete bubbleTimers[timerId];
                }
            });
            bubbleTimersToRemove = [];
        }
    }
    
    // æ·»åŠ å†…å­˜æ¸…ç†å‡½æ•°
    function performMemoryCleanup() {
        // æ¸…ç†è¿‡æœŸçš„æ°”æ³¡è®¡æ—¶å™¨
        Object.entries(bubbleTimers).forEach(([timerId, timerInfo]) => {
            if (timerInfo?.expirationTime && Date.now() > timerInfo.expirationTime) {
                clearTimeout(timerInfo.timer);
                delete bubbleTimers[timerId];
            }
        });
        
        // é™åˆ¶å¯¹è¯é˜Ÿåˆ—å¤§å°
        Object.entries(dialogQueues).forEach(([personaName, queue]) => {
            if (queue?.length > 10) {
                dialogQueues[personaName] = queue.slice(-10);
            }
        });
        
        // æ¸…ç†æ‰“å­—æ•ˆæœçŠ¶æ€?        Object.entries(typingEffects).forEach(([personaName, effect]) => {
            if (!personas[personaName] || !pronunciatios[personaName]) {
                clearInterval(effect?.interval);
                delete typingEffects[personaName];
            }
        });
        
        // é™åˆ¶å¯¹è¯å†å²è®°å½•å¤§å°
        const historyKeys = Object.keys(dialogHistory);
        if (historyKeys.length > maxDialogHistorySize) {
            const keysToRemove = historyKeys.slice(0, Math.floor(historyKeys.length * 0.2));
            keysToRemove.forEach(key => delete dialogHistory[key]);
        }
        
        // æ¸…ç†DOMä¸­è¿‡å¤šçš„æ¶ˆæ¯
        const dialogContainer = document.getElementById('conversation-content');
        if (dialogContainer) {
            const messages = dialogContainer.querySelectorAll('.chat-message');
            if (messages.length > 50) {
                Array.from(messages)
                    .slice(0, messages.length - 50)
                    .forEach(msg => msg.remove());
            }
        }
        
        // æ¸…ç†PIXIçº¹ç†ç¼“å­˜
        if (PIXI.utils.TextureCache) {
            Object.keys(PIXI.utils.TextureCache)
                .filter(key => key.includes('TEMP_') || key.includes('_temp'))
                .forEach(key => {
                    PIXI.utils.TextureCache[key].destroy(true);
                    delete PIXI.utils.TextureCache[key];
                });
        }
    }

    // ç¡®ä¿æ°”æ³¡æ­£ç¡®æ˜¾ç¤º - ä¼˜åŒ–ç‰ˆæœ¬
    function updateBubbleVisibility() {
        Object.entries(pronunciatios).forEach(([personaName, bubble]) => {
            if (bubble?.container?.visible) {
                bubble.container.zIndex = 1000;
                updateBubblePosition(personaName);
                personas[personaName]?.sortChildren();
            }
        });
    }
    
    // å¼ºåˆ¶æ›´æ–°UIä½ç½®å’Œå¯è§æ€?- ä¼˜åŒ–ç‰ˆæœ¬
    function forceUpdateUI() {
        updateTimeDisplay();
        updateUIPositions();
    }
    
    // æ›´æ–°æ‰€æœ‰è§’è‰²çš„åŠ¨ç”»
    function updateAllCharacterAnimations() {
        // æ›´æ–°ç©å®¶åŠ¨ç”»
        if (player && player.updateAnimation) {
            // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨ç§»åŠ¨
            const isMoving = keyboard["ArrowLeft"] || keyboard["ArrowRight"] || 
                           keyboard["ArrowUp"] || keyboard["ArrowDown"];
            player.updateAnimation(lastPlayerDirection, isMoving);
        }
        
        // æ›´æ–°æ‰€æœ‰NPCçš„åŠ¨ç”?        for (let npcName in personas) {
            const npc = personas[npcName];
            if (npc && npc.updateAnimation) {
                let direction = 'down';
                let isMoving = false;
                
                // è·å–NPCçš„å½“å‰ç§»åŠ¨çŠ¶æ€?                if (movement_target[npcName]) {
                    const targetX = movement_target[npcName][0];
                    const targetY = movement_target[npcName][1];
                    
                    // è®¡ç®—åˆ°ç›®æ ‡çš„è·ç¦»
                    const dx = targetX - npc.x;
                    const dy = targetY - npc.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // åˆ¤æ–­æ˜¯å¦æ­£åœ¨ç§»åŠ¨ (å¢å¤§åˆ¤æ–­é˜ˆå€¼ï¼Œç¡®ä¿åŠ¨ç”»æœ‰æœºä¼šæ’­æ”?
                    isMoving = distance > 3;
                    
                    // æ ¹æ®ç§»åŠ¨æ–¹å‘ç¡®å®šåŠ¨ç”»æ–¹å‘
                    if (isMoving) {
                        // ä¸ç©å®¶è§’è‰²ä¸€è‡´çš„åŠ¨ç”»æ–¹å‘å¤„ç†
                        if (Math.abs(dx) > Math.abs(dy)) {
                            // æ°´å¹³ç§»åŠ¨ä¸ºä¸»
                            direction = dx > 0 ? 'right' : 'left';
                        } else {
                            // å‚ç›´ç§»åŠ¨ä¸ºä¸»
                            direction = dy > 0 ? 'down' : 'up';
                        }
                        
                        // è®°å½•ä¸Šä¸€æ¬¡çš„åŠ¨ç”»æ–¹å‘
                        pre_anims_direction_dict[npcName] = direction === 'left' ? "l" : 
                                                          direction === 'right' ? "r" : 
                                                          direction === 'up' ? "u" : "d";
                    } else {
                        // é™æ­¢çŠ¶æ€ï¼Œä½¿ç”¨ä¸Šæ¬¡çš„æ–¹å?                        switch (pre_anims_direction_dict[npcName]) {
                            case "l": direction = 'left'; break;
                            case "r": direction = 'right'; break;
                            case "u": direction = 'up'; break;
                            case "d": direction = 'down'; break;
                            default: direction = 'down'; break;
                        }
                    }
                }
                
                // æ›´æ–°NPCåŠ¨ç”»
                npc.updateAnimation(direction, isMoving);
            }
        }
    }
    
    // ç¡®ä¿ç¢°æ’æ¡†å¯è§å’Œæ­£ç¡®ä½ç½®
    function updateCollisionBoxes() {
        // è·å–å½“å‰ç¢°æ’æ¡†æ˜¾ç¤ºçŠ¶æ€?        const showCollisionBoxes = buttonHideCollision.style.display === 'flex';
        
        // æ›´æ–°ç©å®¶ç¢°æ’æ¡?        if (player && player.collisionBox) {
            player.collisionBox.zIndex = 1000;
            player.collisionBox.visible = showCollisionBoxes;
            player.collisionBox.alpha = 1;
            // ç¡®ä¿æ–‡å­—æ ‡ç­¾å¯è§æ€§ä¸ç¢°æ’æ¡†ä¸€è‡?            if (player.collisionBox.children && player.collisionBox.children[0]) {
                player.collisionBox.children[0].visible = showCollisionBoxes;
            }
            // å¼ºåˆ¶æ’åº
            player.sortChildren();
        }
        
        // æ›´æ–°æ‰€æœ‰NPCçš„ç¢°æ’æ¡†
        for (let npcName in personas) {
            const npc = personas[npcName];
            if (npc && npc.collisionBox) {
                // è®¾ç½®æœ€é«˜å±‚çº?                npc.collisionBox.zIndex = 1000;
                npc.collisionBox.visible = showCollisionBoxes;
                npc.collisionBox.alpha = 1;
                
                // ç¡®ä¿æ–‡å­—æ ‡ç­¾å¯è§æ€§ä¸ç¢°æ’æ¡†ä¸€è‡?                if (npc.collisionBox.children && npc.collisionBox.children[0]) {
                    npc.collisionBox.children[0].visible = showCollisionBoxes;
                }
                
                // å¼ºåˆ¶æ’åº
                npc.sortChildren();
                
                // æ‰“å°ç¡®è®¤ç¢°æ’æ¡†çŠ¶æ€?(ä»…è°ƒè¯•æ—¶éœ€è¦?
                // if (npcName === Object.keys(personas)[0]) {
                //     console.log(`${npcName} ç¢°æ’æ¡†çŠ¶æ€?`, {
                //         visible: npc.collisionBox.visible,
                //         alpha: npc.collisionBox.alpha,
                //         zIndex: npc.collisionBox.zIndex,
                //         position: { x: npc.x, y: npc.y }
                //     });
                // }
            }
        }
        
        // å¼ºåˆ¶æ•´ä¸ªè§’è‰²å®¹å™¨æ’åº
        app.stage.children.forEach(child => {
            if (child && child.sortableChildren) { // æ·»åŠ æ£€æŸ¥ç¡®ä¿childå­˜åœ¨
                child.sortChildren();
            }
        });
    }

    // æ˜¾ç¤ºæ¬¢è¿å¯¹è¯
    function showWelcomeMessages(container) {
        if (!container) {
            console.error("å¯¹è¯å®¹å™¨ä¸å­˜åœ?);
            return;
        }
        
        console.log("è·³è¿‡æ˜¾ç¤ºæ¬¢è¿å¯¹è¯...");
        
        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        
        // æ˜¾ç¤ºå¯¹è¯å†…å®¹ï¼Œéšè—é»˜è®¤å†…å®?        container.style.display = 'flex';
        const defaultContent = document.getElementById('default-dialog-content');
        if (defaultContent) {
            defaultContent.style.display = 'none';
        }
        
        // ä¸å†åˆ›å»ºä»»ä½•æ¬¢è¿æ¶ˆæ¯
    }

    // åˆ›å»ºèŠå¤©æ¶ˆæ¯
    function createChatMessage(container, personaName, text, emoji = "", timestamp = null, autoRemove = false) {
        console.log(`åˆ›å»ºæ¶ˆæ¯: ${personaName} -> ${text.substring(0, 30)}...`);
        
        // å¦‚æœpersonaNameä¸ºç©ºï¼Œä½¿ç”¨ç³»ç»Ÿä½œä¸ºé»˜è®¤å€?        if (!personaName || personaName.trim() === '') {
            personaName = "ç³»ç»Ÿ";
        }
        
        // åˆ›å»ºæ—¶é—´æˆ³ï¼Œå¦‚æœæ²¡æœ‰æä¾›åˆ™ä½¿ç”¨å½“å‰æ—¶é—?        const messageTime = timestamp || new Date();
        const timeString = messageTime.getHours().toString().padStart(2, '0') + ':' + 
                          messageTime.getMinutes().toString().padStart(2, '0');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç³»ç»Ÿæ¶ˆæ¯
        const isSystem = personaName === "ç³»ç»Ÿ";
        
        // å¦‚æœä¸æ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œé€’å¢æ¶ˆæ¯è®¡æ•°å™?        if (!isSystem) {
            messageCounter++;
        }
        
        // æ ¹æ®æ¶ˆæ¯è®¡æ•°å™¨çš„å¥‡å¶æ€§å†³å®šæ¶ˆæ¯ä½ç½?        // å¥‡æ•°(messageCounter % 2 === 1)æ˜¾ç¤ºåœ¨å·¦è¾¹ï¼Œå¶æ•°(messageCounter % 2 === 0)æ˜¾ç¤ºåœ¨å³è¾?        const isRight = !isSystem && (messageCounter % 2 === 0);
        
        // æ£€æŸ¥æ˜¯å¦å’Œä¸Šä¸€ä¸ªå‘è¨€è€…ç›¸å?        const isSameSpeaker = (lastSpeaker === personaName);
        
        // æ›´æ–°ä¸Šä¸€ä¸ªå‘è¨€è€?        lastSpeaker = personaName;
        
        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        messageDiv.style.display = 'flex';
        messageDiv.style.margin = '5px 0';
        messageDiv.style.padding = '5px 10px';
        messageDiv.style.maxWidth = '100%';
        messageDiv.style.position = 'relative';
        messageDiv.style.opacity = '0'; // å¼€å§‹æ—¶é€æ˜
        messageDiv.style.transform = 'translateY(20px)'; // å¼€å§‹æ—¶å‘ä¸‹åç§»
        messageDiv.style.transition = 'opacity 0.5s ease, transform 0.5s ease'; // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
        
        if (isRight) {
            messageDiv.style.flexDirection = 'row-reverse';
            messageDiv.style.justifyContent = 'flex-start';
        }
        
        if (isSystem) {
            messageDiv.style.justifyContent = 'center';
            messageDiv.style.backgroundColor = 'rgba(230, 230, 230, 0.8)';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.padding = '5px 10px';
            messageDiv.style.margin = '5px 0';
            messageDiv.style.color = '#000000';
            messageDiv.style.fontSize = '0.9em';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.border = '1px solid #ccc';
            
            const textSpan = document.createElement('span');
            if (emoji && emoji.trim() !== '') {
                textSpan.textContent = `${emoji} ${text}`;
            } else {
                textSpan.textContent = text;
            }
            
            messageDiv.appendChild(textSpan);
            
            const timeStamp = document.createElement('div');
            timeStamp.className = 'message-time';
            timeStamp.textContent = timeString;
            timeStamp.style.fontSize = '0.7em';
            timeStamp.style.color = '#777';
            timeStamp.style.textAlign = 'center';
            timeStamp.style.marginTop = '3px';
            
            messageDiv.appendChild(timeStamp);
            
            container.appendChild(messageDiv);
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
                messageDiv.classList.add('show');
            }, 10);
            
            if (text.includes("æ¬¢è¿") || 
                text.includes("æ¨¡æ‹Ÿå¼€å§‹å") || 
                text.includes("ç‚¹å‡»é¡¶éƒ¨çš„è§’è‰²å¤´åƒ?) ||
                text.includes("æ§åˆ¶æ çš„æŒ‰é’®") ||
                text.includes("æ‚¨å¥½ï¼?) ||
                emoji === "ğŸ‘‹" || emoji === "ğŸ˜Š" || emoji === "ğŸ”" || emoji === "â¯ï¸"
            ) {
                console.log(`æ£€æµ‹åˆ°ä»‹ç»æ¶ˆæ¯ï¼?{text.substring(0, 20)}...`);
                messageDiv.classList.add('intro-message');
                autoRemove = true;
            }
            
            if (autoRemove) {
                console.log(`è®¾ç½®æ¶ˆæ¯è‡ªåŠ¨ç§»é™¤: ${text.substring(0, 20)}...`);
                messageDiv.dataset.autoRemove = "true";
            }
            
            // æœ€åè¿”å›ä¹‹å‰ï¼Œè§¦å‘è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                if (autoScrollEnabled) {
                    scrollToLatestMessage();
                }
            }, 100);
            
            return messageDiv;
        }
        
        // å¯¹äºéç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ›å»ºç±»ä¼¼å¾®ä¿¡çš„æ°”æ³¡å¸ƒå±€
        
        // å¦‚æœä¸ä¸Šä¸€æ¡æ¶ˆæ¯å‘é€è€…ç›¸åŒï¼Œåˆ™ä¸å†æ˜¾ç¤ºå¤´åƒå’Œåç§°
        if (!isSameSpeaker) {
            // åˆ›å»ºå¤´åƒå®¹å™¨
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-avatar';
            avatarDiv.style.flexShrink = '0';
            avatarDiv.style.width = '40px';
            avatarDiv.style.height = '40px';
            avatarDiv.style.borderRadius = '50%';
            avatarDiv.style.overflow = 'hidden';
            avatarDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            
            // è°ƒæ•´å¤´åƒè¾¹è·æ–¹å‘
            if (isRight) {
                avatarDiv.style.marginLeft = '10px';
            } else {
                avatarDiv.style.marginRight = '10px';
            }
            
            // å°è¯•åŠ è½½ä¸åŒæ ¼å¼çš„å¤´åƒ?            const possiblePaths = [
                `/static/assets/village/agents/${personaName}/portrait.png`,
                `/static/assets/village/agents/${personaName.replace(/\s+/g, '')}/portrait.png`,
                `/static/assets/village/agents/${personaName.toLowerCase()}/portrait.png`,
                `/static/assets/village/agents/${personaName.replace(/\s+/g, '').toLowerCase()}/portrait.png`
            ];
            
            console.log(`å°è¯•åŠ è½½ ${personaName} çš„å¤´åƒï¼Œå¯èƒ½è·¯å¾„:`, possiblePaths);
            
            // åˆ›å»ºå›¾åƒå…ƒç´ 
            const avatarImg = document.createElement('img');
            avatarImg.style.width = '100%';
            avatarImg.style.height = '100%';
            avatarImg.style.objectFit = 'cover';
            
            // å°è¯•æ‰€æœ‰å¯èƒ½çš„è·¯å¾„
            let loadSuccess = false;
            
            // è®¾ç½®é¦–é€‰è·¯å¾?            avatarImg.src = possiblePaths[0];
            avatarImg.alt = personaName;
            
            // å¤„ç†åŠ è½½é”™è¯¯
            avatarImg.onerror = function() {
                console.error(`å¤´åƒåŠ è½½å¤±è´¥: ${avatarImg.src}`);
                
                // å°è¯•ä¸‹ä¸€ä¸ªè·¯å¾?                const currentIndex = possiblePaths.indexOf(avatarImg.src);
                if (currentIndex < possiblePaths.length - 1) {
                    console.log(`å°è¯•å¤‡ç”¨è·¯å¾„: ${possiblePaths[currentIndex + 1]}`);
                    avatarImg.src = possiblePaths[currentIndex + 1];
                } else {
                    console.log(`æ‰€æœ‰å¤´åƒè·¯å¾„å°è¯•å¤±è´¥ï¼Œä½¿ç”¨å­—æ¯å¤´åƒ`);
                    
                    // ç§»é™¤å¤±è´¥çš„å›¾åƒ?                    if (avatarImg.parentNode) {
                        avatarImg.parentNode.removeChild(avatarImg);
                    }
                    
                    // åˆ›å»ºå­—æ¯å¤´åƒ
                    const letterAvatar = createLetterAvatar(personaName);
                    avatarDiv.appendChild(letterAvatar);
                }
            };
            
            // å¤„ç†åŠ è½½æˆåŠŸ
            avatarImg.onload = function() {
                console.log(`å¤´åƒåŠ è½½æˆåŠŸ: ${avatarImg.src}`);
                loadSuccess = true;
            };
            
            // æ·»åŠ å›¾åƒåˆ°å¤´åƒå®¹å™?            avatarDiv.appendChild(avatarImg);
            
            // åˆ›å»ºåç§°å…ƒç´ 
            const nameDiv = document.createElement('div');
            nameDiv.className = 'chat-name';
            nameDiv.style.fontSize = '0.8em';
            nameDiv.style.marginBottom = '2px';
            nameDiv.style.color = '#666';
            nameDiv.textContent = personaName;
            nameDiv.style.textAlign = isRight ? 'right' : 'left';
            
            // åˆ›å»ºå¤´åƒå’Œåç§°çš„åˆ?            const avatarNameCol = document.createElement('div');
            avatarNameCol.className = 'avatar-name-col';
            avatarNameCol.style.display = 'flex';
            avatarNameCol.style.flexDirection = 'column';
            avatarNameCol.style.alignItems = isRight ? 'flex-end' : 'flex-start';
            avatarNameCol.style.width = '40px';
            
            // åœ¨å¤´åƒä¸‹æ–¹æ˜¾ç¤ºåç§?            avatarNameCol.appendChild(avatarDiv);
            avatarNameCol.appendChild(nameDiv);
            
            messageDiv.appendChild(avatarNameCol);
        } else {
            // ä¸ºåŒä¸€å‘è¨€è€…çš„åç»­æ¶ˆæ¯æ·»åŠ ç©ºç™½å ä½
            const spacerDiv = document.createElement('div');
            spacerDiv.style.width = '50px'; // å¤´åƒ+è¾¹è·çš„å®½åº?            spacerDiv.style.flexShrink = '0';
            messageDiv.appendChild(spacerDiv);
        }
        
        // åˆ›å»ºå†…å®¹å®¹å™¨ (æ°”æ³¡)
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'chat-bubble';
        
        // è‡ªé€‚åº”æ°”æ³¡è®¾ç½®
        bubbleDiv.style.display = 'inline-block'; // ä½¿æ°”æ³¡å®½åº¦è‡ªé€‚åº”å†…å®¹
        bubbleDiv.style.minWidth = '40px'; // è®¾ç½®æœ€å°å®½åº?        bubbleDiv.style.maxWidth = 'calc(70% - 20px)'; // è®¾ç½®æœ€å¤§å®½åº?        bubbleDiv.style.padding = '8px 12px';
        bubbleDiv.style.position = 'relative';
        bubbleDiv.style.wordBreak = 'break-word';
        bubbleDiv.style.whiteSpace = 'pre-wrap'; // ä¿ç•™æ¢è¡Œå’Œç©ºæ ?        bubbleDiv.style.boxSizing = 'border-box'; // ç¡®ä¿paddingè®¡å…¥æ€»å®½åº?        
        // æ ¹æ®æ˜¯å¦ä¸ºå³ä¾§æ¶ˆæ¯è®¾ç½®ä¸åŒçš„æ°”æ³¡æ ·å¼
        if (isRight) {
            // å³ä¾§æ°”æ³¡æ ·å¼
            bubbleDiv.style.backgroundColor = '#FFFFFF';
            bubbleDiv.style.color = '#000000';
            bubbleDiv.style.borderRadius = '8px';
            bubbleDiv.style.marginLeft = '10px';
            bubbleDiv.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
            
            // æ·»åŠ æ°”æ³¡å°å°–è§?            if (!isSameSpeaker) {
                bubbleDiv.style.borderTopRightRadius = '0';
            }
        } else {
            // å·¦ä¾§æ°”æ³¡æ ·å¼
            bubbleDiv.style.backgroundColor = 'rgba(52, 152, 219, 0.8)';
            bubbleDiv.style.color = '#FFFFFF';
            bubbleDiv.style.borderRadius = '8px';
            bubbleDiv.style.marginRight = '10px';
            bubbleDiv.style.paddingBottom = '12px'; // å¢åŠ åº•éƒ¨è¡Œè·
            
            // æ·»åŠ æ°”æ³¡å°å°–è§?            if (!isSameSpeaker) {
                bubbleDiv.style.borderTopLeftRadius = '0';
            }
        }
        
        // åˆ›å»ºæ¶ˆæ¯æ–‡æœ¬å…ƒç´ 
        const textDiv = document.createElement('div');
        textDiv.className = 'chat-text';
        
        // æ·»åŠ è¡¨æƒ…ç¬¦å·ï¼ˆå¦‚æœæœ‰ï¼?        if (emoji && emoji.trim() !== '') {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è¯è¡¨æƒ…(ğŸ’¬)ï¼Œå¦‚æœæ˜¯åˆ™åªæ˜¾ç¤ºæ–‡æœ¬å†…å®¹ï¼Œå®Œå…¨å¿½ç•¥è¡¨æƒ…ç¬¦å?            if (emoji.trim() === 'ğŸ’¬') {
                // åˆ é™¤textå¼€å¤´å¯èƒ½çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦
                const cleanedText = text.replace(/^[\s\n]+/, '');
                textDiv.textContent = cleanedText; // ä¸æ˜¾ç¤ºğŸ’¬è¡¨æƒ…ç¬¦å?            } else {
                textDiv.textContent = `${emoji} ${text}`;
            }
        } else {
            textDiv.textContent = text;
        }
        
        // ç»„è£…å†…å®¹
        bubbleDiv.appendChild(textDiv);
        
        // åˆ›å»ºæ—¶é—´æˆ?        const timeStamp = document.createElement('div');
        timeStamp.className = 'message-time';
        timeStamp.textContent = timeString;
        timeStamp.style.fontSize = '0.7em';
        timeStamp.style.color = '#777';
        timeStamp.style.marginTop = '2px';
        timeStamp.style.textAlign = isRight ? 'right' : 'left';
        
        // æ°”æ³¡å®¹å™¨ï¼Œç”¨äºç¡®ä¿æ°”æ³¡å¯¹é½?        const bubbleContainer = document.createElement('div');
        bubbleContainer.style.display = 'flex';
        bubbleContainer.style.flexDirection = 'column';
        bubbleContainer.style.alignItems = isRight ? 'flex-end' : 'flex-start';
        bubbleContainer.style.flex = '1';
        bubbleContainer.appendChild(bubbleDiv);
        bubbleContainer.appendChild(timeStamp);
        
        // ç»„è£…æ¶ˆæ¯
        messageDiv.appendChild(bubbleContainer);
        
        // æ·»åŠ åˆ°å®¹å™?        container.appendChild(messageDiv);
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
        
        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ?        setTimeout(() => {
            if (autoScrollEnabled) {
                scrollToLatestMessage();
            }
        }, 100);
        
        return messageDiv;
    }
    
    // åˆ›å»ºå­—æ¯å¤´åƒ
    function createLetterAvatar(name) {
        // åˆ›å»ºcanvaså…ƒç´ 
        const canvas = document.createElement('canvas');
        canvas.width = 40;
        canvas.height = 40;
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        
        // è®¾ç½®willReadFrequentlyå±æ€§ä»¥ä¼˜åŒ–æ€§èƒ½
        canvas.getContext('2d', { willReadFrequently: true });
        
        // è·å–2Dä¸Šä¸‹æ–?        const ctx = canvas.getContext('2d');
        
        // è·å–é¦–å­—æ¯?        let initials = "";
        if (name && name.trim() !== '') {
            // åˆ†å‰²åç§°å¹¶è·å–æ¯ä¸ªéƒ¨åˆ†çš„é¦–å­—æ¯?            const nameParts = name.trim().split(/\s+/);
            if (nameParts.length === 1) {
                // åªæœ‰ä¸€ä¸ªå•è¯ï¼Œå–å‰ä¸¤ä¸ªå­—æ¯
                initials = nameParts[0].substring(0, 2).toUpperCase();
            } else {
                // å¤šä¸ªå•è¯ï¼Œå–æ¯ä¸ªå•è¯çš„é¦–å­—æ¯
                initials = nameParts.map(part => part.charAt(0).toUpperCase()).join('').substring(0, 2);
            }
        } else {
            initials = "??";
        }
        
        // æ ¹æ®åç§°ç”ŸæˆèƒŒæ™¯é¢œè‰²
        const hue = Math.abs(name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360);
        const bgColor = `hsl(${hue}, 70%, 40%)`;
        
        // ç»˜åˆ¶èƒŒæ™¯
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // è®¾ç½®æ–‡æœ¬æ ·å¼
        ctx.fillStyle = 'white';
        ctx.font = 'bold 20px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // ç»˜åˆ¶é¦–å­—æ¯?        ctx.fillText(initials, canvas.width / 2, canvas.height / 2);
        
        return canvas;
    }

    // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
    function showSystemMessage(message, duration = 3000) {
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        const messageEl = document.createElement('div');
        messageEl.className = 'system-message';
        messageEl.textContent = message;
        messageEl.style.position = 'fixed';
        messageEl.style.bottom = '80px';
        messageEl.style.left = '50%';
        messageEl.style.transform = 'translateX(-50%)';
        messageEl.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        messageEl.style.color = 'white';
        messageEl.style.padding = '8px 16px';
        messageEl.style.borderRadius = '4px';
        messageEl.style.zIndex = '10000';
        messageEl.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
        messageEl.style.fontSize = '14px';
        messageEl.style.fontWeight = 'bold';
        messageEl.style.pointerEvents = 'none';
        messageEl.style.animation = 'fadeIn 0.3s ease-in-out';
        
        // æ·»åŠ åˆ°æ–‡æ¡?        document.body.appendChild(messageEl);
        
        // å®šæ—¶ç§»é™¤
        setTimeout(() => {
            messageEl.style.animation = 'fadeOut 0.3s ease-in-out';
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 300);
        }, duration);
    }
    
    // æ›´æ–°NPCå¤´é¡¶æ–‡å­—æ¡?    function updateNPCBubbles(dialogEntries) {
        try {
            if (dialogEntries && dialogEntries.length > 0) {
                sortDialogueEntries(dialogEntries);
                
                if (!isDialogueGroupPlaying) {
                    currentDialogueGroup = [...dialogEntries];
                    playNextDialogueInGroup();
                } else {
                    dialogEntries.forEach(entry => {
                        if (entry.character === "ç³»ç»Ÿ") return;
                        
                        if (!dialogQueues[entry.character]) {
                            dialogQueues[entry.character] = [];
                        }
                        
                        const isDuplicate = dialogQueues[entry.character].some(item => 
                            item.message === entry.message && item.timestamp === entry.timestamp
                        );
                        
                        if (!isDuplicate) {
                            dialogQueues[entry.character].push(entry);
                        }
                    });
                }
            }
        } catch (error) {
            console.error("æ›´æ–°NPCå¯¹è¯æ°”æ³¡æ—¶å‡ºé”?", error);
        }
    }
    
    // å¯¹å¯¹è¯è¿›è¡Œæ’åºï¼Œä½¿å¯¹è¯æŒ‰ç…§åˆç†çš„é¡ºåºæ˜¾ç¤º
    function sortDialogueEntries(dialogEntries) {
        if (!dialogEntries || dialogEntries.length <= 1) return dialogEntries;
        
        console.log("å¯¹è¯æ’åºå‰?", dialogEntries.map(e => e.character));
        
        // å°†å¯¹è¯æŒ‰è§’è‰²åˆ†ç»„
        const dialoguesByCharacter = {};
        dialogEntries.forEach(entry => {
            if (!dialoguesByCharacter[entry.character]) {
                dialoguesByCharacter[entry.character] = [];
            }
            dialoguesByCharacter[entry.character].push(entry);
        });
        
        // é‡æ–°æ’åˆ—ä¸ºäº¤æ›¿å¯¹è¯æ¨¡å¼?        const sortedDialogues = [];
        const characters = Object.keys(dialoguesByCharacter);
        
        // ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šå¦‚æœåªæœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œç›´æ¥è¿”å›
        if (characters.length === 1 && characters[0] === "ç³»ç»Ÿ") {
            return dialogEntries;
        }
        
        // å¦‚æœæ˜¯ä¸¤ä¸ªè§’è‰²å¯¹è¯ï¼Œå®ç°äº¤æ›¿å¯¹è¯æ¨¡å¼
        if (characters.length === 2 && !characters.includes("ç³»ç»Ÿ")) {
            const char1 = characters[0];
            const char2 = characters[1];
            
            // ç¡®ä¿å¯¹è¯æ•°é‡åŒ¹é…
            const minDialogueCount = Math.min(
                dialoguesByCharacter[char1].length,
                dialoguesByCharacter[char2].length
            );
            
            // ä¸ºäº†å®ç°æ›´å¥½çš„å¯¹è¯æ•ˆæœï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªäººå…ˆé—®ï¼Œå¦ä¸€ä¸ªäººå†å›ç­?            // ç¡®å®šè°æ˜¯å¯¹è¯å‘èµ·è€?            let initiator = char1;
            let responder = char2;
            
            // ç®€å•å¯å‘å¼ï¼šæ£€æŸ¥ç¬¬ä¸€å¥è¯ä¸­æ˜¯å¦åŒ…å«å¦ä¸€ä¸ªè§’è‰²çš„åå­—
            if (dialoguesByCharacter[char1][0].message.includes(char2)) {
                initiator = char1;
                responder = char2;
            } else if (dialoguesByCharacter[char2][0].message.includes(char1)) {
                initiator = char2;
                responder = char1;
            }
            
            console.log(`å¯¹è¯å‘èµ·è€? ${initiator}, å›åº”è€? ${responder}`);
            
            // åˆ›å»ºäº¤æ›¿å¯¹è¯åºåˆ—
            for (let i = 0; i < minDialogueCount; i++) {
                sortedDialogues.push(dialoguesByCharacter[initiator][i]);
                sortedDialogues.push(dialoguesByCharacter[responder][i]);
            }
            
            // æ·»åŠ å‰©ä½™çš„å¯¹è¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (dialoguesByCharacter[initiator].length > minDialogueCount) {
                for (let i = minDialogueCount; i < dialoguesByCharacter[initiator].length; i++) {
                    sortedDialogues.push(dialoguesByCharacter[initiator][i]);
                }
            }
            
            if (dialoguesByCharacter[responder].length > minDialogueCount) {
                for (let i = minDialogueCount; i < dialoguesByCharacter[responder].length; i++) {
                    sortedDialogues.push(dialoguesByCharacter[responder][i]);
                }
            }
        } else {
            // å¦‚æœä¸æ˜¯ä¸¤äººå¯¹è¯ï¼Œä½¿ç”¨é»˜è®¤æ’åºé€»è¾‘
            // å…ˆæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ?            if (dialoguesByCharacter["ç³»ç»Ÿ"]) {
                sortedDialogues.push(...dialoguesByCharacter["ç³»ç»Ÿ"]);
            }
            
            // ç„¶åæŒ‰ç…§è§’è‰²å­—æ¯é¡ºåºæ’åˆ—å…¶ä»–è§’è‰²çš„ç¬¬ä¸€å¥è¯
            const nonSystemCharacters = characters.filter(char => char !== "ç³»ç»Ÿ");
            nonSystemCharacters.sort((a, b) => a.localeCompare(b));
            
            let maxDialogueCount = 0;
            nonSystemCharacters.forEach(char => {
                maxDialogueCount = Math.max(maxDialogueCount, dialoguesByCharacter[char].length);
            });
            
            // è½®æµæ·»åŠ æ¯ä¸ªè§’è‰²çš„å¯¹è¯?            for (let i = 0; i < maxDialogueCount; i++) {
                for (let char of nonSystemCharacters) {
                    if (dialoguesByCharacter[char][i]) {
                        sortedDialogues.push(dialoguesByCharacter[char][i]);
                    }
                }
            }
        }
        
        console.log("å¯¹è¯æ’åºå?", sortedDialogues.map(e => e.character));
        return sortedDialogues;
    }
    
    // æ’­æ”¾å¯¹è¯ç»„ä¸­çš„ä¸‹ä¸€æ¡å¯¹è¯?    function playNextDialogueInGroup() {
        isDialogueGroupPlaying = true;
        
        if (currentDialogueGroup.length > 0) {
            // è·å–å¹¶ç§»é™¤ç¬¬ä¸€æ¡å¯¹è¯?            const nextDialogue = currentDialogueGroup.shift();
            console.log(`æ’­æ”¾å¯¹è¯ç»„ä¸­çš„ä¸‹ä¸€æ? ${nextDialogue.character} è¯? ${nextDialogue.message.substring(0, 30)}...`);
            
            // æ˜¾ç¤ºè¿™æ¡å¯¹è¯
            forceShowNPCBubbles([nextDialogue], "dialog");
            
            // è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨å½“å‰å¯¹è¯æ˜¾ç¤ºå®Œæ¯•åæ˜¾ç¤ºä¸‹ä¸€æ?            const baseTime = 3000; // åŸºç¡€æ—¶é—´3ç§?            const charTime = 80; // æ¯ä¸ªå­—ç¬¦å¢åŠ 80æ¯«ç§’
            const displayTime = Math.min(
                15000, // æœ€é•?5ç§?                Math.max(5000, baseTime + nextDialogue.message.length * charTime) // æœ€çŸ?ç§?            );
            
            console.log(`å¯¹è¯æ˜¾ç¤ºæ—¶é—´: ${displayTime}æ¯«ç§’`);
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (dialogueGroupTimer) {
                clearTimeout(dialogueGroupTimer);
            }
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™?            dialogueGroupTimer = setTimeout(() => {
                // éšè—å½“å‰å¯¹è¯æ°”æ³¡
                if (pronunciatios[nextDialogue.character] && pronunciatios[nextDialogue.character].container) {
                    pronunciatios[nextDialogue.character].container.visible = false;
                }
                
                // å¦‚æœå¯¹è¯ç»„è¿˜æœ‰å¯¹è¯ï¼Œç»§ç»­æ’­æ”¾
                if (currentDialogueGroup.length > 0) {
                    playNextDialogueInGroup();
                } else {
                    // å¯¹è¯ç»„æ’­æ”¾å®Œæ¯?                    isDialogueGroupPlaying = false;
                    dialogueGroupTimer = null;
                    
                    // æ£€æŸ¥å„è§’è‰²é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰å¯¹è¯éœ€è¦æ˜¾ç¤?                    checkAndDisplayQueuedDialogues();
                }
            }, displayTime);
        } else {
            // å¯¹è¯ç»„ä¸ºç©?            isDialogueGroupPlaying = false;
            dialogueGroupTimer = null;
            
            // æ£€æŸ¥å„è§’è‰²é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰å¯¹è¯éœ€è¦æ˜¾ç¤?            checkAndDisplayQueuedDialogues();
        }
    }
    
    // æ£€æŸ¥å¹¶æ˜¾ç¤ºé˜Ÿåˆ—ä¸­çš„å¯¹è¯
    function checkAndDisplayQueuedDialogues() {
        const nextGroup = [];
        
        // ä»æ¯ä¸ªè§’è‰²çš„é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡å¯¹è¯?        for (let personaName in dialogQueues) {
            if (dialogQueues[personaName] && dialogQueues[personaName].length > 0) {
                nextGroup.push(dialogQueues[personaName].shift());
            }
        }
        
        if (nextGroup.length > 0) {
            // æ’åºæ–°çš„å¯¹è¯ç»?            sortDialogueEntries(nextGroup);
            
            // è®¾ç½®ä¸ºå½“å‰å¯¹è¯ç»„å¹¶å¼€å§‹æ’­æ”?            currentDialogueGroup = nextGroup;
            playNextDialogueInGroup();
        }
    }

    // æ˜¾ç¤ºä¸‹ä¸€æ¡å¯¹è¯?    function displayNextDialogue(personaName) {
        if (!dialogQueues[personaName] || dialogQueues[personaName].length === 0) {
            console.log(`${personaName} çš„å¯¹è¯é˜Ÿåˆ—ä¸ºç©º`);
            return;
        }
        
        // å–å‡ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡å¯¹è¯?        const nextDialogue = dialogQueues[personaName][0];
        console.log(`æ˜¾ç¤º ${personaName} çš„ä¸‹ä¸€æ¡å¯¹è¯? ${nextDialogue.message}`);
        
        // æ˜¾ç¤ºå¯¹è¯æ°”æ³¡
        forceShowNPCBubbles([nextDialogue], "dialog");
    }
    
    // å¼ºåˆ¶æ˜¾ç¤ºNPCæ°”æ³¡ï¼Œå¢åŠ ç±»å‹å‚æ•?    function forceShowNPCBubbles(dialogEntries, bubbleType = "dialog") {
        console.log(`å¼ºåˆ¶æ˜¾ç¤ºNPC ${bubbleType}æ°”æ³¡...`);
        
        // åˆ¤æ–­æ˜¾ç¤ºæ—¶é—´
        const displayTime = bubbleType === "dialog" ? 15000 : 10000; // å¯¹è¯æ°”æ³¡30ç§’ï¼ŒåŠ¨ä½œæ°”æ³¡8ç§?        
        try {
            // éå†æ‰€æœ‰å¯¹è¯?            dialogEntries.forEach(entry => {
                const personaName = entry.character;
                const message = entry.message;
                const emoji = bubbleType === "dialog" ? (entry.emoji || "") : ""; // åŠ¨ä½œæ°”æ³¡ä¸æ˜¾ç¤ºè¡¨æƒ?                
                // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
                if (personaName === "ç³»ç»Ÿ") return;
                
                console.log(`å¼ºåˆ¶æ˜¾ç¤º ${personaName} çš?{bubbleType}æ°”æ³¡: ${message}`);
                
                // è·å–NPCå¯¹è±¡
                const npc = personas[personaName];
                if (!npc) {
                    console.warn(`æ‰¾ä¸åˆ°è§’è‰?${personaName}`);
                    return;
                }
                
                // æ£€æŸ¥æ°”æ³¡æ˜¯å¦å­˜åœ?                let bubble = pronunciatios[personaName];
                if (!bubble || !bubble.container) {
                    console.warn(`${personaName} çš„æ°”æ³¡ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º`);
                    createDialogueBubble(npc, personaName);
                    bubble = pronunciatios[personaName];
                }
                
                // å¼ºåˆ¶æ›´æ–°æ°”æ³¡å†…å®¹å’Œå¤§å°?                if (bubble && bubble.text && bubble.background) {
                    // å¦‚æœå½“å‰æœ‰å¯¹è¯æ°”æ³¡åœ¨æ˜¾ç¤ºï¼Œä¸”è¦æ˜¾ç¤ºåŠ¨ä½œæ°”æ³¡ï¼Œåˆ™è·³è¿?                    if (bubbleType === "action" && 
                        bubbleTimers[personaName] && 
                        bubbleTimers[personaName].dialog) {
                        console.log(`${personaName} å½“å‰æœ‰å¯¹è¯æ°”æ³¡æ˜¾ç¤ºï¼Œè·³è¿‡æ˜¾ç¤ºåŠ¨ä½œæ°”æ³¡`);
                        return;
                    }
                    
                    // å‡†å¤‡æ¶ˆæ¯æ–‡æœ¬
                    const rawDisplayText = emoji ? `${emoji} ${message}` : message;
                    // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å¤„ç†æ–‡æœ¬ï¼Œæ·»åŠ æ¢è¡Œç¬?                    const displayText = bubbleType === "dialog" ? formatBubbleText(rawDisplayText) : formatActionText(rawDisplayText);
                    
                    // æ¸…é™¤ç°æœ‰æ‰“å­—æ•ˆæœ
                    if (typingEffects[personaName]) {
                        clearInterval(typingEffects[personaName].interval);
                        delete typingEffects[personaName];
                    }
                    
                    // é‡ç½®æ–‡æœ¬å†…å®¹ä¸ºç©º
                    bubble.text.text = "";
                    
                    // æ ¹æ®æ°”æ³¡ç±»å‹é€‰æ‹©ä¸åŒçš„èƒŒæ™¯é¢œè‰?                    const bgColor = bubbleType === "dialog" ? 0xFFFFAA : 0xE6F7FF;
                    const borderColor = bubbleType === "dialog" ? 0x000000 : 0x0088CC;
                    
                    // å…ˆä½¿ç”¨å®Œæ•´æ–‡æœ¬è®¡ç®—æ°”æ³¡å¤§å°?                    const tempTextStyle = Object.assign({}, bubble.text.style);
                    applyBubbleTextStyle(tempTextStyle, bubbleType);
                    
                    // å¯¹äºæ´»åŠ¨æ°”æ³¡ï¼Œç¡®ä¿æ–‡æœ¬æ ·å¼ç¦ç”¨è‡ªåŠ¨æ¢è¡?                    if (bubbleType === "action") {
                        tempTextStyle.wordWrap = false;
                        tempTextStyle.fontSize = 12;
                    }
                    
                    const tempText = new PIXI.Text(displayText, tempTextStyle);
                    
                    // å…ˆå°†æ°”æ³¡ç»˜åˆ¶ä¸ºå®Œæ•´æ–‡æœ¬æ‰€éœ€çš„å¤§å°?                    bubble.background.clear();
                    bubble.background.beginFill(bgColor);
                    bubble.background.lineStyle(3, borderColor, 0.8);
                    
                    // ä¸ºæ´»åŠ¨æ°”æ³¡æä¾›æ›´å®½çš„èƒŒæ™¯
                    if (bubbleType === "action") {
                        // æ´»åŠ¨æ°”æ³¡ç¦ç”¨äº†æ¢è¡Œï¼Œéœ€è¦æ›´å®½çš„èƒŒæ™¯
                        bubble.background.drawRoundedRect(0, 0, tempText.width + 50, tempText.height + 8, 10);
                    } else {
                        // å¯¹è¯æ°”æ³¡ä½¿ç”¨æ­£å¸¸å®½åº¦
                        bubble.background.drawRoundedRect(0, 0, tempText.width + 20, tempText.height + 8, 10);
                    }
                    bubble.background.endFill();
                    
                    // ä¿å­˜å®Œæ•´æ–‡æœ¬çš„å®½é«˜ï¼Œç”¨äºæ‰“å­—æœºæ•ˆæ?                    const fullTextWidth = tempText.width;
                    const fullTextHeight = tempText.height;
                    
                    // å¼ºåˆ¶è®¾ç½®zIndexç¡®ä¿å¯è§
                    bubble.container.zIndex = 9999;
                    
                    // ç¡®ä¿æ°”æ³¡å¯è§
                    bubble.container.visible = true;
                    bubble.text.visible = true;
                    bubble.background.visible = true;
                    
                    // æ›´æ–°æ°”æ³¡ä½ç½®å±…ä¸­å¹¶è°ƒæ•´ç¼©æ”?                    updateBubblePosition(personaName);
                    
                    // è®°å½•å½“å‰æ°”æ³¡ç±»å‹
                    if (bubbleType === "dialog") {
                        dialogBubbles[personaName] = message;
                        // å¦‚æœæœ‰åŠ¨ä½œæ°”æ³¡ï¼Œæ¸…é™¤å®?                        delete actionBubbles[personaName];
                        if (bubbleTimers[personaName] && bubbleTimers[personaName].action) {
                            clearTimeout(bubbleTimers[personaName].action);
                            bubbleTimers[personaName].action = null;
                        }
                    } else {
                        actionBubbles[personaName] = message;
                    }
                    
                    // è®¾ç½®è‡ªåŠ¨éšè—å®šæ—¶å™?                    if (!bubbleTimers[personaName]) {
                        bubbleTimers[personaName] = {};
                    }
                    
                    // å…ˆæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™?                    if (bubbleTimers[personaName][bubbleType]) {
                        clearTimeout(bubbleTimers[personaName][bubbleType]);
                    }
                    
                    // åˆ›å»ºæ‰“å­—æ•ˆæœ (ä»…å¯¹è¯æ°”æ³?
                    if (bubbleType === "dialog") {
                        // ä¿å­˜å®Œæ•´æ¶ˆæ¯å’Œå½“å‰æ˜¾ç¤ºä½ç½?                        typingEffects[personaName] = {
                            fullText: displayText,
                            currentPos: 0,
                            interval: null,
                            fullTextWidth: fullTextWidth,
                            fullTextHeight: fullTextHeight,
                            lastUpdateTime: Date.now()
                        };
                        
                        // ä½¿ç”¨requestAnimationFrameä»£æ›¿setIntervalå®ç°æ›´æµç•…çš„æ‰“å­—æ•ˆæœ
                        const animate = () => {
                            const effect = typingEffects[personaName];
                            if (!effect) return;

                            const now = Date.now();
                            const elapsed = now - effect.lastUpdateTime;
                            
                            // æ¯?0æ¯«ç§’æ›´æ–°ä¸€ä¸ªå­—ç¬?                            if (elapsed >= 50) {
                                if (effect.currentPos < effect.fullText.length) {
                                    effect.currentPos++;
                                    bubble.text.text = effect.fullText.substring(0, effect.currentPos);
                                    // ç¡®ä¿æ¯æ¬¡æ›´æ–°æ–‡æœ¬æ—¶å¼ºåˆ¶åº”ç”¨è‡ªåŠ¨æ¢è¡?                                    bubble.text.style.wordWrap = true;
                                    bubble.text.style.wordWrapWidth = 40;
                                    
                                    // å¦‚æœæ–‡æœ¬è¶…å‡ºé¢„è®¾å®½åº¦ï¼Œè°ƒæ•´æ°”æ³¡å¤§å°?                                    if (bubble.text.width > effect.fullTextWidth) {
                                        effect.fullTextWidth = bubble.text.width;
                                        bubble.background.clear();
                                        bubble.background.beginFill(bgColor);
                                        bubble.background.lineStyle(3, borderColor, 0.8);
                                        bubble.background.drawRoundedRect(0, 0, effect.fullTextWidth + 20, effect.fullTextHeight + 8, 10);
                                        bubble.background.endFill();
                                        
                                        // é‡æ–°å±…ä¸­æ°”æ³¡
                                        updateBubblePosition(personaName);
                                    }
                                    
                                    effect.lastUpdateTime = now;
                                    requestAnimationFrame(animate);
                                }
                            } else {
                                requestAnimationFrame(animate);
                            }
                        };
                        
                        // å¯åŠ¨åŠ¨ç”»
                        requestAnimationFrame(animate);
                    } else {
                        // åŠ¨ä½œæ°”æ³¡ç›´æ¥æ˜¾ç¤ºå…¨éƒ¨æ–‡å­—
                        bubble.text.text = displayText;
                    }
                    
                    // è®¾ç½®æ–°çš„å®šæ—¶å™?                    bubbleTimers[personaName][bubbleType] = setTimeout(() => {
                        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²æ˜¾ç¤ºçš„å¯¹è¯
                        if (bubbleType === "dialog" && dialogQueues[personaName] && dialogQueues[personaName].length > 0) {
                            // ç§»é™¤ç¬¬ä¸€æ¡å¯¹è¯?                            dialogQueues[personaName].shift();
                            console.log(`å·²ä» ${personaName} çš„é˜Ÿåˆ—ç§»é™¤ä¸€æ¡å¯¹è¯ï¼Œå‰©ä½™: ${dialogQueues[personaName].length}`);
                            
                            // å¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰å¯¹è¯ï¼Œç»§ç»­æ˜¾ç¤ºä¸‹ä¸€æ?                            if (dialogQueues[personaName].length > 0) {
                                // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´åæ˜¾ç¤ºä¸‹ä¸€æ¡ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹åˆ°æ°”æ³¡æ¶ˆå¤±
                                setTimeout(() => {
                                    displayNextDialogue(personaName);
                                }, 1000);
                                return; // ä¸éšè—æ°”æ³¡ï¼Œç­‰å¾…ä¸‹ä¸€æ¡å¯¹è¯?                            }
                        }
                        
                        // å¦‚æœæ˜¯å¯¹è¯æ°”æ³¡è¶…æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåŠ¨ä½œæ°”æ³?                        if (bubbleType === "dialog" && actionBubbles[personaName]) {
                            // æ¸…é™¤æ‰“å­—æ•ˆæœ
                            if (typingEffects[personaName]) {
                                clearInterval(typingEffects[personaName].interval);
                                delete typingEffects[personaName];
                            }
                            
                            // åˆ‡æ¢åˆ°åŠ¨ä½œæ°”æ³?                            bubble.text.text = formatActionText(actionBubbles[personaName]);
                            // ç¦ç”¨åŠ¨ä½œæ°”æ³¡çš„è‡ªåŠ¨æ¢è¡Œï¼Œç¡®ä¿åªæ˜¾ç¤ºä¸€è¡?                            bubble.text.style.wordWrap = false;
                            bubble.text.style.fontSize = 12;
                            bubble.text.style.wordWrapWidth = 40;
                            
                            // ä½¿ç”¨åŠ¨ä½œæ°”æ³¡çš„æ ·å¼?                            bubble.background.clear();
                            bubble.background.beginFill(0xE6F7FF);
                            bubble.background.lineStyle(3, 0x0088CC, 0.8);
                            // ä¸ºåŠ¨ä½œæ°”æ³¡æä¾›æ›´å®½çš„èƒŒæ™¯
                            bubble.background.drawRoundedRect(0, 0, bubble.text.width + 50, bubble.text.height + 8, 10);
                            bubble.background.endFill();
                            
                            // è®¾ç½®åŠ¨ä½œæ°”æ³¡çš„å®šæ—¶å™¨
                            bubbleTimers[personaName].action = setTimeout(() => {
                                bubble.container.visible = false;
                                delete actionBubbles[personaName];
                                
                                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå¯¹è¯éœ€è¦æ˜¾ç¤?                                if (dialogQueues[personaName] && dialogQueues[personaName].length > 0) {
                                    setTimeout(() => {
                                        displayNextDialogue(personaName);
                                    }, 500);
                                }
                            }, 8000);
                        } else {
                            // ç›´æ¥éšè—æ°”æ³¡
                            bubble.container.visible = false;
                            
                            // æ¸…é™¤æ‰“å­—æ•ˆæœ
                            if (typingEffects[personaName]) {
                                clearInterval(typingEffects[personaName].interval);
                                delete typingEffects[personaName];
                            }
                        }
                        
                        // æ¸…é™¤å¯¹åº”çš„å­˜å‚¨å’Œå®šæ—¶å™?                        if (bubbleType === "dialog") {
                            delete dialogBubbles[personaName];
                            bubbleTimers[personaName].dialog = null;
                        } else {
                            delete actionBubbles[personaName];
                            bubbleTimers[personaName].action = null;
                        }
                    }, displayTime);
                    
                } else {
                    console.error(`${personaName} çš„æ°”æ³¡å¯¹è±¡ä¸å®Œæ•´:`, bubble);
                }
            });
            
            // å¼ºåˆ¶æ•´ä¸ªèˆå°æ’åº
            app.stage.sortableChildren = true;
            app.stage.sortChildren();
            
        } catch (error) {
            console.error(`å¼ºåˆ¶æ˜¾ç¤ºNPC ${bubbleType}æ°”æ³¡æ—¶å‡ºé”?`, error);
        }
    }
    
    // åˆ›å»ºè§’è‰²å¯¹è¯æ°”æ³¡
    function createDialogueBubble(personaSprite, personaName) {
        // åˆ›å»ºåŸºç¡€å®¹å™¨
        const dialogueContainer = new PIXI.Container();
        dialogueContainer.name = `dialogue_${personaName}`;
        dialogueContainer.zIndex = 9999;
        
        // åˆ›å»ºèƒŒæ™¯å’Œæ–‡æœ?        const background = new PIXI.Graphics();
        background.name = "dialogue_bg";
        
        const text = new PIXI.Text("", {
            fontFamily: 'Arial',
            fontSize: 14,
            fill: 0x000000,
            align: 'left',
            wordWrap: true,
            wordWrapWidth: 40,
            lineHeight: 10
        });
        text.name = "dialogue_text";
        text.x = 8;
        text.y = 4;
        
        // ç»„è£…æ°”æ³¡
        dialogueContainer.addChild(background);
        dialogueContainer.addChild(text);
        
        // è®¾ç½®ä½ç½®å’Œå¯è§æ€?        dialogueContainer.x = personaSprite.width / 2 - 100;
        dialogueContainer.y = -70;
        dialogueContainer.visible = false;
        
        // æ·»åŠ åˆ°è§’è‰²ç²¾ç?        personaSprite.addChild(dialogueContainer);
        
        // è®°å½•æ°”æ³¡å¼•ç”¨
        pronunciatios[personaName] = {
            container: dialogueContainer,
            background: background,
            text: text,
            personaName: personaName
        };
    }
    
    // åˆ›å»ºæˆ–æ›´æ–°åŠ¨ä½œæ°”æ³?    function updateActionBubble(personaName, action, emoji = "") {
        if (!action?.trim()) return;
        
        const formattedAction = formatActionText(action);
        const actionEntries = [{
            character: personaName,
            message: formattedAction,
            emoji: ""
        }];
        
        // å–æ¶ˆç°æœ‰çš„åŠ¨ä½œæ°”æ³¡è®¡æ—¶å™¨
        if (bubbleTimers[personaName]?.action) {
            clearTimeout(bubbleTimers[personaName].action);
            bubbleTimers[personaName].action = null;
        }
        
        // æ˜¾ç¤ºæ–°çš„åŠ¨ä½œæ°”æ³¡
        forceShowNPCBubbles(actionEntries, "action");
    }
    
    // æ ¼å¼åŒ–æ´»åŠ¨æ–‡æœ?    function formatActionText(text) {
        if (!text?.trim()) return "";
        
        // ç§»é™¤æ¢è¡Œå’Œå¤šä½™ç©ºæ ?        text = text.replace(/\n/g, " ").replace(/\s+/g, " ").trim();
        
        // å¤„ç†ç‰¹æ®Šæ´»åŠ¨æ–‡æœ¬
        if (text.includes("ç¡è§‰")) return "ç¡è§‰ä¸?;
        if (text.includes("å‰å¾€")) {
            const match = text.match(/å‰å¾€\s*(.+)/);
            return match?.[1] ? `å‰å¾€${match[1].trim()}` : text;
        }
        
        // æˆªæ–­é•¿æ–‡æœ?        return text.length > 30 ? text.slice(0, 30) + "..." : text;
    }

    // åˆå§‹åŒ–æ¸¸æˆ?    function initGame() {
        try {
            // åˆ›å»ºPIXIåº”ç”¨
            app = new PIXI.Application({
                width: document.documentElement.clientWidth,
                height: Math.min(document.documentElement.clientHeight * 0.7, 800),
                backgroundColor: 0x1a1a2e, // æ·±è“è‰²èƒŒæ™¯åŒ¹é…æ˜Ÿç©?                resolution: window.devicePixelRatio || 1,
                antialias: true
            });
            
            // è®¾ç½®é«˜è´¨é‡æ¸²æŸ?            PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.LINEAR;
            PIXI.settings.ROUND_PIXELS = true;
            
            // æ·»åŠ åˆ°DOM
            const gameContainer = document.getElementById('game-container');
            gameContainer.appendChild(app.view);
            
            // ç¡®ä¿Canvaså¯¹è±¡ä½¿ç”¨willReadFrequentlyå±æ€?            setCanvasWillReadFrequently();
            
            // åˆ›å»ºæ¸¸æˆå®¹å™¨
            container = new PIXI.Container();
            app.stage.addChild(container);
            
            // å±…ä¸­è§†å›¾
            app.stage.position.set(app.screen.width / 2, app.screen.height / 2);
            
            // è®¾ç½®ç¼©æ”¾
            container.scale.set(zoom);
            
            // åŠ è½½çº¹ç†
            loadTextures();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupEventListeners();
            
            // è®¾ç½®ç¼©æ”¾æ§åˆ¶
            setupZoomControls();
            
            // åŠ è½½å®Œæˆåçš„å¤„ç†
            app.loader.load((loader, resources) => {
                // åˆå§‹åŒ–åœ°å›?                initMap();
                
                // åˆå§‹åŒ–NPC
                initNPC();
                
                // å¼€å§‹æ¸¸æˆå¾ªç?                app.ticker.add(gameLoop);
                
                // è®¾ç½®åˆå§‹æ—¶é—´
                updateGameTime();
                
                // æ¯?ç§’æ›´æ–°ä¸€æ¬¡å¯¹è¯æ°”æ³?                setInterval(updateNPCBubbles, 5000);
                
                // ä¸¤ç§’åæµ‹è¯•æ°”æ³?                setTimeout(() => {
                    testAllNPCBubbles();
                }, 2000);
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', handleResize);
            
            // åˆå§‹è®¾ç½®ç”»é¢æ¯”ä¾‹
            setTimeout(() => {
                handleResize();
            }, 500);
            
        } catch (error) {
            console.error("åˆå§‹åŒ–æ¸¸æˆæ—¶å‡ºé”™:", error);
        }
    }

    // è·å–è§’è‰²çŠ¶æ€?    function getPersonaStatus(personaName) {
        // æ£€æŸ¥å½“å‰æ­¥éª¤æ˜¯å¦æœ‰è¯¥è§’è‰²çš„æ•°æ®
        const currentStepKey = step.toString();
        if (all_movement[currentStepKey] && all_movement[currentStepKey][personaName]) {
            return all_movement[currentStepKey][personaName];
        }
        
        // å¦‚æœæ²¡æœ‰ï¼Œæ£€æŸ¥å‰ä¸€æ­¥æ˜¯å¦æœ‰è¯¥è§’è‰²çš„æ•°æ®
        const prevStepKey = (step - 1).toString();
        if (all_movement[prevStepKey] && all_movement[prevStepKey][personaName]) {
            return all_movement[prevStepKey][personaName];
        }
        
        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¿”å›null
        return null;
    }

    // åˆ›å»ºæµ®åŠ¨æ—¶é’Ÿçª—å£æŒ‰é’®ï¼Œæ·»åŠ åˆ°å³ä¾§æ—¶é—´å®¹å™¨ä¸?    function createFloatingClockButton() {
        // ç­‰UIåˆ›å»ºå®Œæˆåå†æ·»åŠ æŒ‰é’®
        const timeDisplayCheck = setInterval(() => {
            const timeDisplayElement = document.getElementById('time-display');
            if (timeDisplayElement && currentTimeText) {
                clearInterval(timeDisplayCheck);
                
                // åˆ›å»ºæµ®åŠ¨æ—¶é’ŸæŒ‰é’®
                const floatingClockBtn = document.createElement('button');
                floatingClockBtn.innerHTML = 'â¬†ï¸';
                floatingClockBtn.title = 'æ˜¾ç¤ºæµ®åŠ¨æ—¶é’Ÿ';
                floatingClockBtn.style.marginLeft = '5px';
                floatingClockBtn.style.backgroundColor = 'transparent';
                floatingClockBtn.style.border = 'none';
                floatingClockBtn.style.color = 'white';
                floatingClockBtn.style.fontSize = '14px';
                floatingClockBtn.style.cursor = 'pointer';
                floatingClockBtn.style.padding = '3px';
                floatingClockBtn.style.borderRadius = '3px';
                
                floatingClockBtn.addEventListener('mouseover', () => {
                    floatingClockBtn.style.backgroundColor = 'rgba(255,255,255,0.2)';
                });
                
                floatingClockBtn.addEventListener('mouseout', () => {
                    floatingClockBtn.style.backgroundColor = 'transparent';
                });
                
                floatingClockBtn.addEventListener('click', () => {
                    console.log("ç‚¹å‡»äº†æµ®åŠ¨æ—¶é’ŸæŒ‰é’?);
                    toggleFloatingClock();
                });
                
                currentTimeText.appendChild(floatingClockBtn);
            }
        }, 500);
    }
    
    // æ›´æ–°æ¸¸æˆæ—¶é—´å‡½æ•°
    function updateGameTime() {
        try {
            console.log("åˆå§‹åŒ–æ¸¸æˆæ—¶é—?..");
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTimeDisplay();
            // åˆ›å»ºæµ®åŠ¨æ—¶é’ŸæŒ‰é’®ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (typeof createFloatingClockButton === 'function') {
                createFloatingClockButton();
            } else {
                console.warn("createFloatingClockButton å‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•åˆ›å»ºæµ®åŠ¨æ—¶é’ŸæŒ‰é’®");
            }
            console.log("æ¸¸æˆæ—¶é—´åˆå§‹åŒ–å®Œæˆ?);
        } catch (error) {
            console.error("æ›´æ–°æ¸¸æˆæ—¶é—´æ—¶å‡ºé”?", error);
        }
    }
    
    // æµ®åŠ¨æ—¶é’Ÿè®¡æ—¶å™¨IDç®¡ç†
    let floatingClockUpdateInterval = null;
    
    // åˆ›å»º/æ˜¾ç¤º/éšè—æµ®åŠ¨æ—¶é’Ÿçª—å£
    function toggleFloatingClock() {
        if (floatingClockWindow) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ç§»é™¤å¹¶æ¸…ç†è®¡æ—¶å™?            if (floatingClockUpdateInterval) {
                clearInterval(floatingClockUpdateInterval);
                floatingClockUpdateInterval = null;
            }
            document.body.removeChild(floatingClockWindow);
            floatingClockWindow = null;
            return;
        }
        
        // åˆ›å»ºæµ®åŠ¨çª—å£
        floatingClockWindow = document.createElement('div');
        floatingClockWindow.className = 'floating-window';
        floatingClockWindow.style.left = '20px';
        floatingClockWindow.style.top = '20px';
        
        // çª—å£å¤´éƒ¨
        const windowHeader = document.createElement('div');
        windowHeader.className = 'window-header';
        
        const windowTitle = document.createElement('div');
        windowTitle.className = 'window-title';
        windowTitle.textContent = 'æ¸¸æˆæ—¶é—´';
        
        const closeButton = document.createElement('button');
        closeButton.className = 'window-close';
        closeButton.innerHTML = 'Ã—';
        closeButton.addEventListener('click', () => {
            toggleFloatingClock();
        });
        
        windowHeader.appendChild(windowTitle);
        windowHeader.appendChild(closeButton);
        
        // çª—å£å†…å®¹
        const windowContent = document.createElement('div');
        windowContent.className = 'window-content';
        
        const clockDate = document.createElement('div');
        clockDate.className = 'clock-date';
        
        const clockDisplay = document.createElement('div');
        clockDisplay.className = 'clock-display';
        
        windowContent.appendChild(clockDate);
        windowContent.appendChild(clockDisplay);
        
        floatingClockWindow.appendChild(windowHeader);
        floatingClockWindow.appendChild(windowContent);
        
        document.body.appendChild(floatingClockWindow);
        
        // æ›´æ–°æ—¶é’Ÿæ˜¾ç¤º
        updateFloatingClock();
        
        // è®¾ç½®å®šæ—¶æ›´æ–° - ä½¿ç”¨setIntervalä»£æ›¿é€’å½’setTimeout
        if (floatingClockUpdateInterval) {
            clearInterval(floatingClockUpdateInterval);
        }
        floatingClockUpdateInterval = setInterval(updateFloatingClock, 1000);
        
        // å®ç°æ‹–åŠ¨åŠŸèƒ½
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        windowHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragOffsetX = e.clientX - floatingClockWindow.offsetLeft;
            dragOffsetY = e.clientY - floatingClockWindow.offsetTop;
            floatingClockWindow.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const newLeft = e.clientX - dragOffsetX;
            const newTop = e.clientY - dragOffsetY;
            
            // ç¡®ä¿çª—å£ä¸ä¼šè¢«æ‹–å‡ºè§†å?            const maxLeft = window.innerWidth - floatingClockWindow.offsetWidth;
            const maxTop = window.innerHeight - floatingClockWindow.offsetHeight;
            
            floatingClockWindow.style.left = `${Math.max(0, Math.min(newLeft, maxLeft))}px`;
            floatingClockWindow.style.top = `${Math.max(0, Math.min(newTop, maxTop))}px`;
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                floatingClockWindow.style.cursor = 'default';
            }
        });
    }
    
    // æ›´æ–°æµ®åŠ¨æ—¶é’Ÿæ˜¾ç¤º
    function updateFloatingClock() {
        if (!floatingClockWindow) {
            // å¦‚æœæ—¶é’Ÿçª—å£ä¸å­˜åœ¨ï¼Œæ¸…ç†è®¡æ—¶å™?            if (floatingClockUpdateInterval) {
                clearInterval(floatingClockUpdateInterval);
                floatingClockUpdateInterval = null;
            }
            return;
        }
        
            const clockDate = floatingClockWindow.querySelector('.clock-date');
            const clockDisplay = floatingClockWindow.querySelector('.clock-display');
            
            if (clockDate && clockDisplay) {
                const currentDate = new Date(start_datetime.getTime());
                
                // æ˜¾ç¤ºæ ¼å¼åŒ–çš„æ—¥æœŸ
                const year = currentDate.getFullYear();
                const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                const day = currentDate.getDate().toString().padStart(2, '0');
                const weekday = ['æ˜ŸæœŸæ—?, 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäº?, 'æ˜ŸæœŸä¸?, 'æ˜ŸæœŸå›?, 'æ˜ŸæœŸäº?, 'æ˜ŸæœŸå…?][currentDate.getDay()];
                
                // æ˜¾ç¤ºæ ¼å¼åŒ–çš„æ—¶é—´
                const hours = currentDate.getHours().toString().padStart(2, '0');
                const minutes = currentDate.getMinutes().toString().padStart(2, '0');
                const seconds = currentDate.getSeconds().toString().padStart(2, '0');
                
                clockDate.textContent = `${year}å¹?{month}æœ?{day}æ—?${weekday}`;
                clockDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        }
    }

    // æ·»åŠ å†…å­˜ç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–å˜é‡
    let memoryCleanupInterval = 300000; // æ¯?åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡å†…å­?    let lastMemoryCleanup = Date.now();
    let maxDialogHistorySize = 50; // æœ€å¤§ä¿å­˜çš„å¯¹è¯è®°å½•æ•°é‡
    let bubbleTimersToRemove = [];  // éœ€è¦åˆ é™¤çš„æ°”æ³¡è®¡æ—¶å™?    let frameSkipCounter = 0; // å¸§æ•°è·³è¿‡è®¡æ•°å™?    let frameSkipThreshold = 2; // æ¯éš”å‡ å¸§æ‰§è¡Œä¸€æ¬¡å®Œæ•´æ›´æ–°ï¼ˆå€¼è¶Šå¤§æ€§èƒ½è¶Šå¥½ä½†åŠ¨ç”»å¯èƒ½ä¸æµç•…ï¼?    
    // æ›´æ–°å¯¹è¯å†å²è®°å½•åŠŸèƒ½ï¼Œæ·»åŠ å¤§å°é™åˆ?    function addDialogToHistory(sender, message, time) {
        // é¦–å…ˆæ£€æŸ¥å†å²è®°å½•å¤§å°?        let historyKeys = Object.keys(dialogHistory);
        if (historyKeys.length > maxDialogHistorySize) {
            // åˆ é™¤æœ€æ—§çš„å‡ æ¡è®°å½•ï¼Œä¿ç•?0%
            const keysToRemove = historyKeys.slice(0, Math.floor(historyKeys.length * 0.2));
            keysToRemove.forEach(key => {
                delete dialogHistory[key];
            });
            console.log(`æ¸…ç†è¿‡å¤šçš„å¯¹è¯å†å²è®°å½•ï¼Œç§»é™¤äº?{keysToRemove.length}æ¡æ—§è®°å½•`);
        }
        
        // æ·»åŠ æ–°è®°å½?        const dialogId = `dialog_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
        dialogHistory[dialogId] = { sender, message, time };
    }

    // ä¼˜åŒ–å®šæ—¶å™¨æ¸…ç†ï¼Œç¡®ä¿ä¸ä¼šç´¯ç§¯æœªä½¿ç”¨çš„å®šæ—¶å™?    function showDialogBubble(personaName, text, duration = 5000) {
        try {
            // æ£€æŸ¥è§’è‰²åç§°å’Œå‘è¨€æ˜¯å¦æœ‰æ•ˆ
            if (!personaName || !text || text.trim() === '') {
                console.warn(`æ— æ•ˆçš„æ°”æ³¡å‚æ•?(${personaName}): ${text}`);
                return;
            }
            
            // è·å–è§’è‰²å’Œæ°”æ³?            const npc = personas[personaName];
            const bubble = pronunciatios[personaName];
            
            if (!npc) {
                console.warn(`æ‰¾ä¸åˆ°è§’è‰? ${personaName}`);
                return;
            }
            
            if (!bubble || !bubble.container || !bubble.text || !bubble.background) {
                console.warn(`æ‰¾ä¸åˆ°æ°”æ³? ${personaName}`);
                return;
            }
            
            // å‡†å¤‡æ°”æ³¡å†…å®¹
            const displayText = text;
            
            // æ¸…é™¤è§’è‰²ç°æœ‰çš„å®šæ—¶å™¨
            if (bubbleTimers[personaName]) {
                clearTimeout(bubbleTimers[personaName]);
                delete bubbleTimers[personaName];
            }
            
            // æ¸…é™¤ç°æœ‰æ‰“å­—æ•ˆæœ
            if (typingEffects[personaName]) {
                clearInterval(typingEffects[personaName].interval);
                delete typingEffects[personaName];
            }
            
            // é‡ç½®æ–‡æœ¬å†…å®¹
            bubble.text.text = displayText;
            
            // è®¾ç½®æ°”æ³¡èƒŒæ™¯æ ·å¼
            const padding = 10;
            bubble.background.clear();
            bubble.background.beginFill(0xFFFFAA);
            bubble.background.lineStyle(2, 0x000000, 0.8);
            bubble.background.drawRoundedRect(
                0, 0, 
                bubble.text.width + padding * 2, 
                bubble.text.height + padding * 2,
                10
            );
            bubble.background.endFill();
            
            // è°ƒæ•´æ–‡æœ¬ä½ç½®
            bubble.text.x = padding;
            bubble.text.y = padding;
            
            // ç¡®ä¿æ°”æ³¡åœ¨æœ€ä¸Šå±‚å¹¶å¯è§?            bubble.container.zIndex = 9999;
            bubble.container.visible = true;
            bubble.container.alpha = 1;
            
            // æ›´æ–°æ°”æ³¡ä½ç½®å’Œç¼©æ”?            updateBubblePosition(personaName);
            
            // åˆ›å»ºå”¯ä¸€çš„å®šæ—¶å™¨ID
            const timerId = `${personaName}_${Date.now()}`;
            
            // è®¾ç½®è‡ªåŠ¨éšè—å®šæ—¶å™?            const timer = setTimeout(() => {
                // éšè—æ°”æ³¡
                if (bubble && bubble.container) {
                    bubble.container.visible = false;
                }
                
                // å®šæ—¶å™¨æ‰§è¡Œåä»ç®¡ç†å¯¹è±¡ä¸­åˆ é™¤
                delete bubbleTimers[timerId];
                
                console.log(`æ°”æ³¡è‡ªåŠ¨éšè— (${personaName}): ${timerId.slice(-6)}`);
            }, duration);
            
            // å­˜å‚¨å®šæ—¶å™¨ä¿¡æ¯ï¼ˆå¸¦æœ‰é¢å¤–ä¿¡æ¯æ–¹ä¾¿è°ƒè¯•ï¼?            bubbleTimers[timerId] = {
                timer: timer,
                personaName: personaName,
                text: text.slice(0, 20) + (text.length > 20 ? '...' : ''),
                createdAt: Date.now(),
                expirationTime: Date.now() + duration + 1000, // æ·»åŠ 1ç§’ç¼“å†?                duration: duration
            };
            
            console.log(`æ˜¾ç¤ºæ°”æ³¡ (${personaName}): ${timerId.slice(-6)}, æŒç»­æ—¶é—´: ${duration}ms`);
            return timerId;
        } catch (error) {
            console.error(`æ˜¾ç¤ºå¯¹è¯æ°”æ³¡æ—¶å‡ºé”?(${personaName}):`, error);
            return null;
        }
    }
    
    // éšè—å¯¹è¯æ°”æ³¡
    function hideDialogBubble(personaName) {
        try {
            const bubble = pronunciatios[personaName];
            if (bubble && bubble.container) {
                bubble.container.visible = false;
            }
            
            // æ¸…ç†è¯¥è§’è‰²çš„æ‰€æœ‰è®¡æ—¶å™¨
            for (let timerId in bubbleTimers) {
                if (bubbleTimers[timerId].personaName === personaName) {
                    clearTimeout(bubbleTimers[timerId].timer);
                    delete bubbleTimers[timerId];
                }
            }
        } catch (error) {
            console.error(`éšè—å¯¹è¯æ°”æ³¡æ—¶å‡ºé”?(${personaName}):`, error);
        }
    }

    // æ·»åŠ PIXIæ¸²æŸ“ä¼˜åŒ–è®¾ç½®
    PIXI.settings.PRECISION_FRAGMENT = PIXI.PRECISION.MEDIUM; // é™ä½ç‰‡æ®µç€è‰²å™¨ç²¾åº¦
    PIXI.settings.GC_MODE = PIXI.GC_MODES.AUTO; // å¯ç”¨è‡ªåŠ¨åƒåœ¾å›æ”¶
    PIXI.settings.GC_MAX_IDLE = 60 * 10; // 10åˆ†é’Ÿçš„æœ€å¤§ç©ºé—²æ—¶é—?    PIXI.settings.WRAP_MODE = PIXI.WRAP_MODES.CLAMP; // è¾¹ç¼˜åŒ…è£…æ¨¡å¼
    PIXI.settings.MIPMAP_TEXTURES = PIXI.MIPMAP_MODES.ON; // å¯ç”¨mipmapä»¥æé«˜ç¼©æ”¾æ€§èƒ½

    // å¢å¼ºè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯çš„åŠŸèƒ½
    let autoScrollEnabled = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
    
    // è‡ªåŠ¨æ»šåŠ¨å‡½æ•°
    function scrollToLatestMessage() {
        const dialogContent = document.getElementById('conversation-content');
        if (!dialogContent) return;
        
        if (!autoScrollEnabled) return;
        
        const messages = dialogContent.querySelectorAll('.chat-message');
        const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
        
        dialogContent.style.scrollBehavior = 'smooth';
        
        const attemptScroll = (attempt = 1, maxAttempts = 3) => {
            if (attempt > maxAttempts) return;
            
            const delay = attempt * 300;
            
            setTimeout(() => {
                dialogContent.scrollTop = dialogContent.scrollHeight;
                
                if (lastMessage) {
                    lastMessage.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'end'
                    });
                }
                
                if (attempt < maxAttempts) {
                    attemptScroll(attempt + 1, maxAttempts);
                }
            }, delay);
        };
        
        setTimeout(() => {
            attemptScroll();
        }, 100);
    }
    
    // æ·»åŠ è‡ªåŠ¨æ»šåŠ¨å¼€å…?    function addAutoScrollToggle(container) {
        // åˆ›å»ºå¼€å…³å®¹å™?        const toggleContainer = document.createElement('div');
        toggleContainer.style.position = 'absolute';
        toggleContainer.style.top = '5px';
        toggleContainer.style.right = '10px';
        toggleContainer.style.zIndex = '1000';
        toggleContainer.style.display = 'flex';
        toggleContainer.style.alignItems = 'center';
        toggleContainer.style.gap = '5px';
        
        // åˆ›å»ºæ ‡ç­¾
        const label = document.createElement('span');
        label.textContent = 'è‡ªåŠ¨æ»šåŠ¨:';
        label.style.fontSize = '12px';
        label.style.color = '#666';
        
        // åˆ›å»ºå¼€å…³æŒ‰é’?        const toggle = document.createElement('button');
        toggle.textContent = autoScrollEnabled ? 'âœ? : 'âœ?;
        toggle.style.width = '24px';
        toggle.style.height = '24px';
        toggle.style.borderRadius = '50%';
        toggle.style.border = 'none';
        toggle.style.background = autoScrollEnabled ? '#4CAF50' : '#F44336';
        toggle.style.color = 'white';
        toggle.style.cursor = 'pointer';
        toggle.style.fontSize = '12px';
        toggle.style.display = 'flex';
        toggle.style.justifyContent = 'center';
        toggle.style.alignItems = 'center';
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        toggle.addEventListener('click', function() {
            autoScrollEnabled = !autoScrollEnabled;
            toggle.textContent = autoScrollEnabled ? 'âœ? : 'âœ?;
            toggle.style.background = autoScrollEnabled ? '#4CAF50' : '#F44336';
            
            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨æ»šåŠ¨ï¼Œç«‹å³æ»šåŠ¨åˆ°åº•éƒ?            if (autoScrollEnabled) {
                scrollToLatestMessage();
            }
            
            console.log(`è‡ªåŠ¨æ»šåŠ¨å·?{autoScrollEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        });
        
        // æ·»åŠ åˆ°å®¹å™?        toggleContainer.appendChild(label);
        toggleContainer.appendChild(toggle);
        container.appendChild(toggleContainer);
    }

    var characterImages = {}; // è§’è‰²å¤´é¡¶å›¾ç‰‡èµ„æºæ˜ å°„
    var characterHeadImages = {}; // å­˜å‚¨è§’è‰²å¤´é¡¶æ˜¾ç¤ºçš„å›¾ç‰?</script>



